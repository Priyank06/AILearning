@page "/multifile"
@using Microsoft.Extensions.Logging
@using PoC1_LegacyAnalyzer_Web.Services
@using PoC1_LegacyAnalyzer_Web.Models
@using PoC1_LegacyAnalyzer_Web.Components.MultiFileAnalysis
@using Microsoft.AspNetCore.Components.Forms
@using System.Text
@using PoC1_LegacyAnalyzer_Web.Services.Infrastructure
@using PoC1_LegacyAnalyzer_Web.Services.Reporting
@inject IMultiFileAnalysisService MultiFileAnalysisService
@inject IFileDownloadService FileDownloadService
@inject IJSRuntime JSRuntime
@inject IReportService ReportService
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>Enterprise Project Analysis</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-2">Enterprise Project Analysis</h1>
            <p class="lead text-muted">Advanced Legacy System Assessment Platform</p>
        </div>
    </div>

    <!-- Single-column layout for file upload and configuration -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Project File Upload</h5>
                    @if (selectedFiles.Any())
                    {
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-files"></i> @selectedFiles.Count file(s) selected
                        </span>
                    }
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Analysis Type Selection -->
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label fw-bold">Analysis Type:</label>
                            <select class="form-select" @bind="selectedAnalysisType">
                                <option value="general">General Code Assessment</option>
                                <option value="security">Security Analysis</option>
                                <option value="performance">Performance Review</option>
                                <option value="migration">Migration Readiness</option>
                            </select>
                        </div>

                        <!-- File Upload Buttons -->
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label class="form-label fw-bold">Upload Files:</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <InputFile id="fileInput" OnChange="HandleFileSelection" multiple accept=".cs,.py,.js,.ts,.java,.go" class="d-none" webkitdirectory />
                                <label for="fileInput" class="btn btn-primary">
                                    <i class="bi bi-folder-plus"></i> Select Project Folder
                                </label>

                                <InputFile id="individualFiles" OnChange="HandleIndividualFileSelection" multiple accept=".cs,.py,.js,.ts,.java,.go" class="d-none" />
                                <label for="individualFiles" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-plus"></i> Select Individual Files
                                </label>
                            </div>
                            @if (selectedFiles.Any())
                            {
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> Total size: @FormatFileSize(selectedFiles.Sum(f => f.Size))
                                    </small>
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold d-block">&nbsp;</label>
                            <div class="d-flex gap-2">
                                @if (selectedFiles.Any())
                                {
                                    <button class="btn btn-success flex-fill" @onclick="AnalyzeProject" disabled="@isAnalyzing">
                                        @if (isAnalyzing)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <text>Analyzing...</text>
                                        }
                                        else
                                        {
                                            <text><i class="bi bi-play-circle"></i> Analyze</text>
                                        }
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="ClearFiles" title="Clear all files">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <AnalysisProgressModal IsVisible="@isAnalyzing" Progress="@analysisProgress" />

    <!-- Results Section - Single Column Layout -->
    @if (analysisResult != null)
    {
        <div class="row">
            <div class="col-12">
                <!-- Project Summary -->
                <ProjectSummaryCard Result="@analysisResult" />

                @*<div class="alert alert-info">
                    <h5>Executive Dashboard Ready</h5>
                    <p>Interactive charts loading... If charts don't appear, detailed metrics are available below.</p>
                    <button class="btn btn-outline-primary btn-sm" @onclick="TestSimpleCharts">
                        Validate Dashboard
                    </button>
                </div>*@

                <!-- Charts Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5 class="alert-heading mb-3"><i class="bi bi-graph-up"></i> Executive Dashboard</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Files Requiring Immediate Review</h6>
                                            <small>Priority ranking by technical complexity</small>
                                        </div>
                                        <div class="card-body" style="height: 300px;">
                                            <canvas id="complexityChart" width="400" height="250"></canvas>
                                        </div>
                                        <div class="card-footer text-muted">
                                            <small><strong>Action:</strong> Focus development effort on highest-scoring files first</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">Project Risk Assessment</h6>
                                            <small>Risk distribution across entire codebase</small>
                                        </div>
                                        <div class="card-body" style="height: 300px;">
                                            <canvas id="riskChart" width="400" height="250"></canvas>
                                        </div>
                                        <div class="card-footer text-muted">
                                            <small><strong>Insight:</strong> Risk distribution indicates project complexity level</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Quality Assessment -->
                <CodeQualityCard Result="@analysisResult"
                                 ComplexityLowThreshold="@ComplexityLowThreshold"
                                 ComplexityMediumThreshold="@ComplexityMediumThreshold" />

                <!-- Strategic Business Impact -->
                @if (businessMetrics != null)
                {
                    <BusinessMetricsCardComponent Metrics="@businessMetrics" />
                }

                <!-- Executive Assessment Summary -->
                <ExecutiveSummaryCard Result="@analysisResult"
                                      ComplexityLowThreshold="@ComplexityLowThreshold"
                                      ComplexityMediumThreshold="@ComplexityMediumThreshold"
                                      ComplexityHighThreshold="@ComplexityHighThreshold" />

                <!-- Risk Assessment Summary -->
                <RiskAssessmentCard Result="@analysisResult"
                                    ComplexityLowThreshold="@ComplexityLowThreshold"
                                    ComplexityMediumThreshold="@ComplexityMediumThreshold" />

                <!-- Intelligent Assessment Summary -->
                <AIAssessmentCard AssessmentText="@(analysisResult.OverallAssessment ?? string.Empty)" />

                <!-- Strategic Recommendations -->
                <StrategicRecommendationsCard Recommendations="@analysisResult.KeyRecommendations" />

                <!-- Detailed File Analysis -->
                <DetailedFileAnalysisCard FileResults="@analysisResult.FileResults"
                                          ComplexityLowThreshold="@ComplexityLowThreshold"
                                          ComplexityMediumThreshold="@ComplexityMediumThreshold"
                                          ComplexityHighThreshold="@ComplexityHighThreshold" />

                <!-- Legacy Issues -->
                <LegacyIssuesCard FileResults="@analysisResult.FileResults" />

                <!-- Executive Reporting -->
                <ReportGenerationCard IsGeneratingReport="@isGeneratingReport"
                                      OnGenerateReport="@DownloadExecutiveReport" />
            </div>
        </div>
    }
</div>

<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

    /* Improve card spacing and alignment */
    .card {
        margin-bottom: 1rem;
    }

    /* Better text formatting for AI insights */
    .ai-insight-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #495057;
    }

    /* Improve file list display */
    .file-list-item {
        transition: background-color 0.2s ease;
    }

        .file-list-item:hover {
            background-color: #f8f9fa !important;
        }

    /* Center align charts better */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 250px;
    }

    .insight-text {
        color: #2c3e50 !important; /* Darker text for better readability */
        font-weight: 500;
    }

    .card-body small {
        color: #495057 !important; /* Ensure all small text is readable */
    }

    .spin {
        animation: spin 2s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    private string selectedAnalysisType = "general";
    private bool isAnalyzing = false;
    private bool isGeneratingReport = false;
    private string statusMessage = "";
    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();
    private MultiFileAnalysisResult? analysisResult;
    private BusinessMetrics? businessMetrics;

    private int ComplexityLowThreshold;
    private int ComplexityMediumThreshold;
    private int ComplexityHighThreshold;
    private int TokenCharEstimate;
    private bool businessRulesLoaded = false;

    protected override void OnInitialized()
    {
        // Load thresholds from configuration
        ComplexityLowThreshold = int.TryParse(Configuration["BusinessCalculationRules:ComplexityLowThreshold"], out var low) ? low : 30;
        ComplexityMediumThreshold = int.TryParse(Configuration["BusinessCalculationRules:ComplexityMediumThreshold"], out var med) ? med : 50;
        ComplexityHighThreshold = int.TryParse(Configuration["BusinessCalculationRules:ComplexityHighThreshold"], out var high) ? high : 70;
        TokenCharEstimate = int.TryParse(Configuration["BusinessCalculationRules:TokenCharEstimate"], out var token) ? token : 4;
        businessRulesLoaded = true;
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        // NOTE: No file count limit - batching handles any number of files
        // Using a large number for GetMultipleFiles to allow folder selection, but no actual limit enforced
        var newFiles = e.GetMultipleFiles(10000); // Large number to allow folder selection
        var csFiles = newFiles.Where(f => f.Name.EndsWith(".cs", StringComparison.OrdinalIgnoreCase)).ToList();

        // Filter out generated/designer files that aren't useful for analysis
        var sourceFiles = csFiles.Where(f =>
            !f.Name.Contains(".Designer.") &&
            !f.Name.Contains(".g.cs") &&
            !f.Name.Contains(".g.i.cs") &&
            !f.Name.Contains("AssemblyInfo.cs") &&
            !f.Name.Contains("GlobalAssemblyInfo.cs") &&
            !f.Name.StartsWith("Temp", StringComparison.OrdinalIgnoreCase) &&
            !f.Name.Contains("obj\\Debug") &&
            !f.Name.Contains("obj\\Release")
        ).ToList();

        if (sourceFiles.Count != newFiles.Count())
        {
            statusMessage = $"Folder selection: Found {sourceFiles.Count} relevant source files from {newFiles.Count()} total files.";
        }
        else
        {
            statusMessage = $"Successfully loaded {sourceFiles.Count} source files from project folder.";
        }

        // Clear existing and add new files
        // NOTE: No file count limit - batching handles any number of files
        selectedFiles.Clear();
        selectedFiles.AddRange(sourceFiles);

        StateHasChanged();
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Handled by preventDefault
    }

    private void HandleFileDrop(DragEventArgs e)
    {
        statusMessage = "File upload: Please use the Browse Files button to select source files.";
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        statusMessage = $"Removed {file.Name}. {selectedFiles.Count} files remaining for analysis.";
        StateHasChanged();
    }

    private void ClearFiles()
    {
        selectedFiles.Clear();
        statusMessage = "All files cleared. Ready for new file selection.";
        StateHasChanged();
    }

    private async Task TestSimpleCharts()
    {
        try
        {
            Console.WriteLine("Testing simple charts...");
            statusMessage = "Testing chart functionality...";
            StateHasChanged();

            await Task.Delay(500); // Allow UI to render

            // Test if Chart.js is loaded
            var chartLoaded = await JSRuntime.InvokeAsync<bool>("eval", "typeof Chart !== 'undefined'");
            Console.WriteLine($"Chart.js loaded: {chartLoaded}");

            if (!chartLoaded)
            {
                statusMessage = "Chart.js library not loaded";
                return;
            }

            // Test simple chart creation
            var testResult = await JSRuntime.InvokeAsync<bool>("testSimpleChart");
            Console.WriteLine($"Test chart result: {testResult}");

            if (testResult)
            {
                statusMessage = "Chart test successful! Chart.js is working.";
            }
            else
            {
                statusMessage = "Chart test failed. Check console for details.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Test error: {ex.Message}");
            statusMessage = $"Test error: {ex.Message}";
        }
    }

    private async Task DebugChartElements()
    {
        try
        {
            Console.WriteLine("Debugging chart elements...");

            // Check if canvas elements exist
            var canvasInfo = await JSRuntime.InvokeAsync<string>("eval", @"
            Array.from(document.querySelectorAll('canvas')).map(c =>
                c.id + ': ' + c.offsetWidth + 'x' + c.offsetHeight
            ).join(', ')
        ");

            Console.WriteLine($"Canvas elements: {canvasInfo}");
            statusMessage = $"Canvas elements: {canvasInfo}";

            // Check Chart.js version
            var chartVersion = await JSRuntime.InvokeAsync<string>("eval", @"
            typeof Chart !== 'undefined' ? Chart.version || 'Unknown version' : 'Not loaded'
        ");

            Console.WriteLine($"Chart.js version: {chartVersion}");

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Debug error: {ex.Message}");
            statusMessage = $"Debug error: {ex.Message}";
        }
    }

    private async Task GenerateCharts()
    {
        if (analysisResult?.FileResults == null || !analysisResult.FileResults.Any())
        {
            Console.WriteLine("No file results available for chart generation");
            return;
        }

        try
        {
            Console.WriteLine("Creating executive charts...");
            statusMessage = "Generating executive dashboard...";
            StateHasChanged();

            // Wait for DOM
            await Task.Delay(1500);

            // FIXED: Ensure we have valid data
            var validFiles = analysisResult.FileResults
                .Where(f => f != null && !string.IsNullOrEmpty(f.FileName))
                .ToList();

            if (!validFiles.Any())
            {
                Console.WriteLine("No valid files for chart generation");
                return;
            }

            // FIXED: Create complexity chart with proper data
            var topFiles = validFiles
                .OrderByDescending(f => f.ComplexityScore)
                .Take(8)
                .ToList();

            var fileNames = topFiles.Select(f => f.FileName.Length > 12 ? f.FileName.Substring(0, 12) + "..." : f.FileName).ToArray();
            var complexityScores = topFiles.Select(f => (object)f.ComplexityScore).ToArray();

            Console.WriteLine($"Creating complexity chart with {fileNames.Length} files: [{string.Join(", ", complexityScores)}]");

            var complexitySuccess = await JSRuntime.InvokeAsync<bool>("createSimpleChart",
                "complexityChart",
                "bar",
                fileNames,
                complexityScores,
                "Highest Risk Files - Complexity Analysis"
            );

            // FIXED: Create risk distribution with actual counts
            var lowCount = validFiles.Count(f => f.ComplexityScore < 40);
            var mediumCount = validFiles.Count(f => f.ComplexityScore >= 40 && f.ComplexityScore < 70);
            var highCount = validFiles.Count(f => f.ComplexityScore >= 70);

            Console.WriteLine($"Risk distribution: Low={lowCount}, Medium={mediumCount}, High={highCount}");

            if (lowCount + mediumCount + highCount > 0)
            {
                var riskLabels = new[] { "Low Risk", "Medium Risk", "High Risk" };
                var riskValues = new object[] { lowCount, mediumCount, highCount };

                var riskSuccess = await JSRuntime.InvokeAsync<bool>("createSimpleChart",
                    "riskChart",
                    "doughnut",
                    riskLabels,
                    riskValues,
                    "Project Risk Distribution"
                );

                Console.WriteLine($"Charts created: Complexity={complexitySuccess}, Risk={riskSuccess}");

                if (complexitySuccess || riskSuccess)
                {
                    statusMessage = "Executive dashboard created successfully.";
                }
                else
                {
                    statusMessage = "Dashboard generation completed. Review detailed analysis below.";
                }
            }
            else
            {
                statusMessage = "Analysis completed. Detailed insights available in file breakdown.";
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart error: {ex.Message}");
            statusMessage = "Analysis completed successfully. Detailed breakdown available below.";
        }
    }

    private async Task DownloadExecutiveReport()
    {
        if (analysisResult == null) return;

        isGeneratingReport = true;
        statusMessage = "Generating comprehensive executive report...";
        StateHasChanged();

        try
        {
            // Generate executive summary report
            var reportContent = GenerateExecutiveReport();
            var reportBytes = System.Text.Encoding.UTF8.GetBytes(reportContent);
            var fileName = $"executive-analysis-{selectedAnalysisType}-{DateTime.Now:yyyyMMdd-HHmmss}.md";

            await FileDownloadService.DownloadFileAsync(fileName, reportBytes, "text/markdown");
            statusMessage = $"Executive report generated successfully: {fileName}";
        }
        catch (Exception ex)
        {
            statusMessage = $"Report generation failed: {ex.Message}";
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private string GenerateExecutiveReport()
    {
        if (analysisResult == null) return "";

        var report = new StringBuilder();

        // Executive Summary Header
        report.AppendLine("# Executive Project Analysis Report");
        report.AppendLine($"**Analysis Type**: {selectedAnalysisType.ToUpper()} ASSESSMENT");
        report.AppendLine($"**Report Generated**: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        report.AppendLine($"**Project Scope**: {analysisResult.TotalFiles} source files analyzed");
        report.AppendLine();

        // Executive Summary
        report.AppendLine("## Executive Summary");
        report.AppendLine($"This comprehensive analysis evaluated {analysisResult.TotalFiles} source files containing {analysisResult.TotalClasses} classes and {analysisResult.TotalMethods} methods. ");
        report.AppendLine($"The overall project complexity is rated as **{analysisResult.OverallRiskLevel}** with a risk score of {analysisResult.OverallComplexityScore}/100.");
        report.AppendLine();

        // FIXED: Use real data calculations directly in the report
        var manualHours = CalculateManualAnalysisHours(analysisResult);
        var costSavings = manualHours * 125;

        // Strategic Business Context with real data
        report.AppendLine("## Strategic Business Context");
        report.AppendLine("**Market Timing**: Legacy modernization market projected 15% annual growth");
        report.AppendLine("**Competitive Advantage**: AI-powered analysis delivers results 20x faster than manual assessment");
        report.AppendLine($"**Risk Management**: {analysisResult.OverallRiskLevel} complexity level (score: {analysisResult.OverallComplexityScore}/100) requires immediate attention");
        report.AppendLine();

        report.AppendLine("## Financial Impact Analysis");
        report.AppendLine($"**Code Complexity**: {analysisResult.TotalClasses} classes with {analysisResult.TotalMethods} methods analyzed");
        report.AppendLine($"**Estimated Manual Analysis Time**: {manualHours} hours");
        report.AppendLine($"**AI Analysis Time**: 3 minutes");
        report.AppendLine($"**Time Savings**: {manualHours} hours manual vs. 3 minutes AI = {manualHours * 60 - 3} minutes saved");
        report.AppendLine($"**Cost Avoidance**: ${costSavings:N0} in developer time cost avoidance");
        report.AppendLine();

        // Competitive Advantage Analysis with real data
        var speedMultiplier = (manualHours * 60) / 3;
        report.AppendLine("## Competitive Advantage Analysis");
        report.AppendLine();
        report.AppendLine("### Speed Advantage");
        report.AppendLine($"- **Traditional Approach**: {manualHours} hours manual analysis");
        report.AppendLine($"- **AI-Enhanced Approach**: 3 minutes automated analysis");
        report.AppendLine($"- **Speed Multiplier**: {speedMultiplier:F0}x faster time-to-insight");
        report.AppendLine();
        report.AppendLine("### Cost Advantage");
        report.AppendLine($"- **Traditional Manual Review**: ${costSavings:N0} ({manualHours} hours @ $125/hour)");
        report.AppendLine($"- **AI-Enhanced Analysis**: $5 per comprehensive assessment");
        report.AppendLine($"- **Cost Reduction**: ${costSavings - 5:N0} savings per analysis");
        report.AppendLine();
        report.AppendLine("### Project Metrics");
        report.AppendLine($"- **Code Complexity**: {analysisResult.OverallComplexityScore}/100 complexity score");
        report.AppendLine($"- **Risk Assessment**: {analysisResult.OverallRiskLevel} risk level based on actual code structure");
        report.AppendLine($"- **Analysis Scope**: {analysisResult.TotalClasses} classes, {analysisResult.TotalMethods} methods, {analysisResult.TotalProperties} properties");
        report.AppendLine();

        // Key Metrics
        report.AppendLine("## Key Performance Indicators");
        report.AppendLine("| Metric | Value | Assessment |");
        report.AppendLine("|--------|--------|------------|");
        report.AppendLine($"| Source Files | {analysisResult.TotalFiles} | {GetFileCountAssessment(analysisResult.TotalFiles)} |");
        report.AppendLine($"| Code Classes | {analysisResult.TotalClasses} | {GetClassCountAssessment(analysisResult.TotalClasses)} |");
        report.AppendLine($"| Methods | {analysisResult.TotalMethods} | {GetMethodCountAssessment(analysisResult.TotalMethods)} |");
        report.AppendLine($"| Complexity Score | {analysisResult.OverallComplexityScore}/100 | {analysisResult.OverallRiskLevel} Risk Level |");
        report.AppendLine();

        // Risk Assessment
        var riskStats = GetRiskStatistics();
        report.AppendLine("## Risk Assessment");
        report.AppendLine($"- **Low Risk Files**: {riskStats.low} files ({riskStats.lowPercent:F1}%)");
        report.AppendLine($"- **Medium Risk Files**: {riskStats.medium} files ({riskStats.mediumPercent:F1}%)");
        report.AppendLine($"- **High Risk Files**: {riskStats.high} files ({riskStats.highPercent:F1}%)");
        report.AppendLine();

        // Strategic Recommendations
        if (analysisResult.KeyRecommendations.Any())
        {
            report.AppendLine("## Strategic Recommendations");
            foreach (var recommendation in analysisResult.KeyRecommendations)
            {
                report.AppendLine($"- {recommendation}");
            }
            report.AppendLine();
        }

        // Business Impact
        report.AppendLine("## Business Impact Assessment");
        report.AppendLine($"**Migration Timeline**: {GetMigrationTimeline(analysisResult.OverallComplexityScore)}");
        report.AppendLine($"**Resource Requirements**: {GetResourceRequirements(analysisResult.OverallComplexityScore)}");
        report.AppendLine($"**Financial Impact**: {GetFinancialImpact(analysisResult.OverallComplexityScore)}");
        report.AppendLine();

        // Technical Details
        report.AppendLine("## Detailed File Analysis");
        foreach (var file in analysisResult.FileResults.OrderByDescending(f => f.ComplexityScore).Take(10))
        {
            report.AppendLine($"### {file.FileName}");
            report.AppendLine($"- **Complexity Score**: {file.ComplexityScore}/100");
            report.AppendLine($"- **Classes**: {file.StaticAnalysis.ClassCount}");
            report.AppendLine($"- **Methods**: {file.StaticAnalysis.MethodCount}");
            report.AppendLine($"- **Properties**: {file.StaticAnalysis.PropertyCount}");
            if (!string.IsNullOrEmpty(file.AIInsight))
            {
                report.AppendLine($"- **Assessment**: {file.AIInsight}");
            }
            report.AppendLine();
        }

        // Next Steps
        report.AppendLine("## Recommended Next Steps");
        report.AppendLine("1. **Immediate Actions**: Address high-complexity files identified in this analysis");
        report.AppendLine("2. **Resource Planning**: Allocate development resources based on complexity assessment");
        report.AppendLine("3. **Timeline Development**: Create detailed project timeline using risk assessment data");
        report.AppendLine("4. **Stakeholder Communication**: Present findings to technical and business stakeholders");
        report.AppendLine("5. **Monitoring Strategy**: Establish metrics tracking for modernization progress");

        return report.ToString();
    }

    private (int low, int medium, int high, double lowPercent, double mediumPercent, double highPercent) GetRiskStatistics()
    {
        if (analysisResult?.FileResults == null) return (0, 0, 0, 0, 0, 0);

        var total = analysisResult.FileResults.Count;
        var low = analysisResult.FileResults.Count(f => f.ComplexityScore < 40);
        var medium = analysisResult.FileResults.Count(f => f.ComplexityScore >= 40 && f.ComplexityScore < 70);
        var high = analysisResult.FileResults.Count(f => f.ComplexityScore >= 70);

        return (low, medium, high,
                low * 100.0 / total,
                medium * 100.0 / total,
                high * 100.0 / total);
    }

    private string FormatFileSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:n1} {suffixes[counter]}";
    }

    private string GetStatusAlertClass() => statusMessage.Contains("error") || statusMessage.Contains("failed") ? "alert-danger" : "alert-info";

    private string GetRiskTextColorClass(string risk) => risk switch
    {
        "LOW" => "text-success",
        "MEDIUM" => "text-warning",
        "HIGH" => "text-danger",
        _ => "text-secondary"
    };

    private string GetRiskDescription(string risk) => risk switch
    {
        "LOW" => "Standard migration process applicable",
        "MEDIUM" => "Structured approach with experienced team required",
        "HIGH" => "Complex migration requiring specialist expertise",
        _ => "Assessment in progress"
    };

    private async Task HandleIndividualFileSelection(InputFileChangeEventArgs e)
    {
        var newFiles = e.GetMultipleFiles(20); // Allow more files for folder selection
        var csFiles = newFiles.Where(f => f.Name.EndsWith(".cs", StringComparison.OrdinalIgnoreCase)).ToList();

        // Filter out common non-source files
        csFiles = csFiles.Where(f =>
            !f.Name.Contains(".Designer.") &&
            !f.Name.Contains(".g.cs") &&
            !f.Name.Contains("AssemblyInfo.cs") &&
            !f.Name.StartsWith("Temp", StringComparison.OrdinalIgnoreCase)
        ).ToList();

        if (csFiles.Count != newFiles.Count())
        {
            statusMessage = $"Filtered to {csFiles.Count} source files from {newFiles.Count()} total files.";
        }
        else
        {
            statusMessage = $"Successfully selected {csFiles.Count} source files.";
        }

        selectedFiles.AddRange(csFiles);
        StateHasChanged();
    }

    private string FormatAIInsight(string insight)
    {
        if (string.IsNullOrEmpty(insight))
            return "<div class='alert alert-light'><em>Assessment pending - analysis in progress</em></div>";

        try
        {
            // Clean up the text aggressively
            var cleaned = insight
                .Replace("###", "")
                .Replace("##", "")
                .Replace("#", "")
                .Replace("**", "")
                .Replace("*", "")
                .Replace("```", "")
                .Replace("`", "")
                .Replace("---", "")
                .Trim();

            // Split into sentences and clean them
            var sentences = cleaned.Split(new[] { '.', '!', '?' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => s.Length > 10 && !s.StartsWith("Priority") && !s.StartsWith("Implementation"))
                .Take(3) // Limit to 3 key insights for executives
                .ToList();

            if (!sentences.Any())
            {
                return "<div class='alert alert-warning'><strong>Assessment Summary:</strong> Code analysis completed. Technical details require manual review.</div>";
            }

            var formatted = new System.Text.StringBuilder();
            formatted.Append("<div class='executive-summary'>");

            for (int i = 0; i < sentences.Count; i++)
            {
                var sentence = sentences[i].Trim();
                if (!sentence.EndsWith(".")) sentence += ".";

                // Format as executive-friendly insight
                formatted.Append($"<div class='insight-item mb-2'>");
                formatted.Append($"<span class='badge bg-primary me-2'>{i + 1}</span>");
                formatted.Append($"<span class='insight-text'>{sentence}</span>");
                formatted.Append("</div>");
            }

            formatted.Append("</div>");
            return formatted.ToString();
        }
        catch (Exception)
        {
            return "<div class='alert alert-info'><strong>Technical Assessment:</strong> Code structure analyzed. Detailed recommendations available upon request.</div>";
        }
    }

    private string GetComplexityCardClass(int score) => score switch
    {
        >= 70 => "bg-danger",
        >= 40 => "bg-warning text-dark",
        _ => "bg-success"
    };

    private string GetRiskBadgeClass()
    {
        return analysisResult?.OverallRiskLevel switch
        {
            "LOW" => "success",
            "MEDIUM" => "warning",
            "HIGH" => "danger",
            _ => "secondary"
        };
    }

    // Helper methods for UI rendering using config thresholds
    private string GetQualityColorClass(int complexity)
    {
        if (complexity > ComplexityMediumThreshold) return "bg-danger";
        if (complexity > ComplexityLowThreshold) return "bg-warning";
        return "bg-success";
    }

    private string GetStatusBadgeClass(int complexity)
    {
        if (complexity > ComplexityMediumThreshold) return "bg-danger";
        if (complexity > ComplexityLowThreshold) return "bg-warning";
        return "bg-success";
    }

    private string GetStatusText(int complexity)
    {
        if (complexity > ComplexityMediumThreshold) return "Needs Review";
        if (complexity > ComplexityLowThreshold) return "Monitor";
        return "Good";
    }

    private string GetMaintenanceLevel(int complexity)
    {
        if (complexity > ComplexityMediumThreshold) return "Immediate attention";
        if (complexity > ComplexityLowThreshold) return "Scheduled review";
        return "Standard maintenance";
    }

    private string GetComplexityColorClass(int score)
    {
        if (score < ComplexityLowThreshold) return "bg-success";
        if (score < ComplexityMediumThreshold) return "bg-warning";
        return "bg-danger";
    }

    private string GetComplexityTextColor(int score)
    {
        if (score < ComplexityMediumThreshold) return "text-success";
        if (score < ComplexityHighThreshold) return "text-warning";
        return "text-danger";
    }

    private string GetComplexityBadgeClass(int score)
    {
        if (score < ComplexityLowThreshold) return "bg-success";
        if (score < ComplexityMediumThreshold) return "bg-warning text-dark";
        return "bg-danger";
    }

    private string GetComplexityLabel(int score)
    {
        if (score < ComplexityLowThreshold) return "Low Risk";
        if (score < ComplexityMediumThreshold) return "Medium Risk";
        return "High Risk";
    }

    private string GetSeverityBadgeClass(string severity)
    {
        return severity?.ToUpper() switch
        {
            "CRITICAL" => "bg-danger",
            "HIGH" => "bg-warning text-dark",
            "MEDIUM" => "bg-info",
            "LOW" => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }

    private string GetRiskBadgeClass(string riskLevel)
    {
        return riskLevel?.ToUpper() switch
        {
            "CRITICAL" => "bg-danger",
            "HIGH" => "bg-warning text-dark",
            "MEDIUM" => "bg-info text-white",
            "LOW" => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetSemanticQualityColor(int score)
    {
        return score >= 80 ? "bg-success" :
               score >= 60 ? "bg-warning" :
               score >= 40 ? "bg-info" :
               "bg-danger";
    }

    private string GetSemanticIssueTypeBadge(string issueType)
    {
        return issueType.ToUpper() switch
        {
            var t when t.Contains("TYPE") => "bg-danger",
            var t when t.Contains("UNINITIALIZED") => "bg-warning text-dark",
            var t when t.Contains("CONTROL") => "bg-info",
            var t when t.Contains("DEPRECATED") => "bg-danger",
            var t when t.Contains("RUNTIME") => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetCategoryBadge(string category)
    {
        return category?.ToUpper() switch
        {
            "ERROR" => "bg-danger",
            "WARNING" => "bg-warning text-dark",
            "INFO" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private string GetTimelineColorClass()
    {
        if (analysisResult == null) return "secondary";

        if (analysisResult.OverallComplexityScore < 40)
            return "success";
        else if (analysisResult.OverallComplexityScore < 70)
            return "warning";
        else
            return "danger";
    }

    private string GetExecutiveTimeline()
    {
        if (analysisResult == null) return "Assessment Pending";
        if (analysisResult.OverallComplexityScore < ComplexityLowThreshold)
            return "2-4 weeks (Low complexity migration)";
        else if (analysisResult.OverallComplexityScore < ComplexityMediumThreshold)
            return "4-8 weeks (Standard migration process)";
        else if (analysisResult.OverallComplexityScore < ComplexityHighThreshold)
            return "8-12 weeks (Complex migration - phased approach)";
        else
            return "12+ weeks (High complexity - dedicated team required)";
    }

    private AnalysisProgress? analysisProgress;

    private async Task AnalyzeProject()
    {
        if (!selectedFiles.Any()) return;

        isAnalyzing = true;
        analysisProgress = new AnalysisProgress
        {
            TotalFiles = selectedFiles.Count,
            CurrentAnalysisType = selectedAnalysisType,
            StartTime = DateTime.Now
        };

        businessMetrics = null; // Reset business metrics
        statusMessage = $"Starting comprehensive analysis of {selectedFiles.Count} files...";
        StateHasChanged();

        var progress = new Progress<AnalysisProgress>(p =>
        {
            analysisProgress = p;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            analysisResult = await MultiFileAnalysisService.AnalyzeMultipleFilesWithProgressAsync(
                selectedFiles, selectedAnalysisType, progress);

            // Calculate business metrics after analysis
            businessMetrics = MultiFileAnalysisService.CalculateBusinessMetrics(analysisResult);

            statusMessage = $"Analysis completed! ROI: {businessMetrics.EstimatedDeveloperHoursSaved * businessMetrics.AverageHourlyRate:C0} value delivered.";
            statusMessage += $" Compliance Cost Avoidance: {businessMetrics.ComplianceCostAvoidance:C0}.";
            statusMessage += $" Project Size: {businessMetrics.ProjectSize}.";
            // Adding more detail to the status message
            statusMessage += $" Estimated Developer Hours Saved: {businessMetrics.EstimatedDeveloperHoursSaved}.";
            statusMessage += $" Average Hourly Rate: {businessMetrics.AverageHourlyRate:C0}.";
            statusMessage += $" Compliance Cost Avoidance: {businessMetrics.ComplianceCostAvoidance:C0}.";
            statusMessage += $" Project Size: {businessMetrics.ProjectSize}.";

            await GenerateCharts();
        }
        catch (Exception ex)
        {
            statusMessage = $"Analysis encountered an error: {ex.Message}";
        }
        finally
        {
            isAnalyzing = false;
            analysisProgress = null;
            StateHasChanged();
        }
    }

    private async Task<BusinessMetrics> CalculateBusinessMetricsAsync(MultiFileAnalysisResult result)
    {
        return await Task.FromResult(new BusinessMetrics
        {
            EstimatedDeveloperHoursSaved = result.TotalMethods * 0.5m * ((result.OverallComplexityScore / 100m) + 0.5m),
            MigrationTimeline = result.OverallComplexityScore switch
            {
                < 30 => "2-4 weeks",
                < 50 => "4-8 weeks",
                < 70 => "8-12 weeks",
                _ => "12+ weeks"
            },
            RiskMitigation = $"{result.OverallRiskLevel} risk level with appropriate mitigation strategy",
            ComplianceCostAvoidance = result.OverallRiskLevel switch
            {
                "HIGH" => 15000m,
                "MEDIUM" => 8000m,
                "LOW" => 3000m,
                _ => 1000m
            },
            ProjectSize = result.TotalFiles switch
            {
                < 5 => "Small Project",
                < 15 => "Medium Project",
                < 30 => "Large Project",
                _ => "Enterprise Project"
            },
            RecommendedApproach = result.OverallComplexityScore switch
            {
                < 30 => "Standard development practices",
                < 50 => "Structured approach with experienced team",
                < 70 => "Phased migration with risk mitigation",
                _ => "Enterprise methodology with dedicated team"
            }
        });
    }

    private int CalculateManualAnalysisHours(MultiFileAnalysisResult result)
    {
        var baseHours = result.TotalClasses * 2; // 2 hours per class
        var methodHours = result.TotalMethods * 0.25; // 15 minutes per method
        var dependencyHours = result.TotalUsingStatements * 0.5; // 30 minutes per dependency

        return (int)(baseHours + methodHours + dependencyHours);
    }

    private string GetFileCountAssessment(int fileCount)
    {
        if (fileCount < 5) return "Small project scope";
        if (fileCount < 15) return "Medium project complexity";
        if (fileCount < 30) return "Large project - requires structured approach";
        return "Enterprise-scale project - dedicated team recommended";
    }

    private string GetClassCountAssessment(int classCount)
    {
        if (classCount < 10) return "Low structural complexity";
        if (classCount < 25) return "Moderate architectural complexity";
        if (classCount < 50) return "Complex architecture - careful planning required";
        return "Highly complex system - expert analysis recommended";
    }

    private string GetMethodCountAssessment(int methodCount)
    {
        if (methodCount < 50) return "Manageable codebase size";
        if (methodCount < 150) return "Medium codebase - standard development practices apply";
        if (methodCount < 300) return "Large codebase - requires systematic approach";
        return "Very large codebase - enterprise development practices essential";
    }

    private string GetMigrationTimeline(int complexityScore)
    {
        if (complexityScore < ComplexityLowThreshold) return "2-4 weeks (Low complexity migration)";
        if (complexityScore < ComplexityMediumThreshold) return "4-8 weeks (Standard migration process)";
        if (complexityScore < ComplexityHighThreshold) return "8-16 weeks (Complex migration - phased approach)";
        return "16+ weeks (High complexity - dedicated team required)";
    }

    private string GetResourceRequirements(int complexityScore)
    {
        if (complexityScore < ComplexityLowThreshold) return "1-2 developers, standard skillset";
        if (complexityScore < ComplexityMediumThreshold) return "2-3 developers, experienced team";
        if (complexityScore < ComplexityHighThreshold) return "3-5 developers, senior expertise required";
        return "5+ developers, specialist migration team with architect oversight";
    }

    private string GetFinancialImpact(int complexityScore)
    {
        if (complexityScore < ComplexityLowThreshold) return "Low cost - standard development rates";
        if (complexityScore < ComplexityMediumThreshold) return "Moderate cost - budget for quality assurance";
        if (complexityScore < ComplexityHighThreshold) return "High cost - include risk mitigation budget";
        return "Very high cost - executive approval recommended";
    }

    // Replace token estimation usage
    private int EstimateTokens(int charCount)
    {
        return charCount / TokenCharEstimate;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyAllCharts");
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}