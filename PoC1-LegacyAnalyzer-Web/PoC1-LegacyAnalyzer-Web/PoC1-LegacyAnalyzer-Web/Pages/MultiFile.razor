@page "/multifile"
@using Microsoft.Extensions.Logging
@using PoC1_LegacyAnalyzer_Web.Services
@using PoC1_LegacyAnalyzer_Web.Models
@using Microsoft.AspNetCore.Components.Forms
@using System.Text
@inject IMultiFileAnalysisService MultiFileAnalysisService
@inject IFileDownloadService FileDownloadService
@inject IJSRuntime JSRuntime
@inject IReportService ReportService
@implements IAsyncDisposable

<PageTitle>Enterprise Project Analysis</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-2">Enterprise Project Analysis</h1>
            <p class="lead text-muted">Advanced Legacy System Assessment Platform</p>
        </div>
    </div>

    <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Project File Upload</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Analysis Type:</label>
                        <select class="form-select" @bind="selectedAnalysisType">
                            <option value="general">General Code Assessment</option>
                            <option value="security">Security Analysis</option>
                            <option value="performance">Performance Review</option>
                            <option value="migration">Migration Readiness</option>
                        </select>
                    </div>

                    <div class="upload-area mb-3" @ondragover="HandleDragOver" @ondragover:preventDefault="true"
                         @ondrop="HandleFileDrop" @ondrop:preventDefault="true">
                        <div class="text-center p-4">
                            <div style="font-size: 3rem;" class="text-muted mb-3">
                                <i class="bi bi-folder2-open"></i>
                            </div>
                            <h6>Upload C# Project Files</h6>
                            <p class="text-muted mb-3">Select multiple C# files from your project folder</p>

                            <!-- Enhanced file input to allow folder-like selection -->
                            <InputFile id="fileInput" OnChange="HandleFileSelection" multiple accept=".cs" class="d-none" webkitdirectory />
                            <label for="fileInput" class="btn btn-primary me-2">
                                <i class="bi bi-folder-plus"></i> Select Project Folder
                            </label>

                            <!-- Alternative individual file selection -->
                            <InputFile id="individualFiles" OnChange="HandleIndividualFileSelection" multiple accept=".cs" class="d-none" />
                            <label for="individualFiles" class="btn btn-outline-secondary">
                                <i class="bi bi-file-plus"></i> Select Individual Files
                            </label>

                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Folder:</strong> Automatically finds all .cs files in project<br>
                                    <strong>Individual:</strong> Select specific files manually
                                </small>
                            </div>
                        </div>
                    </div>

                    @if (selectedFiles.Any())
                    {
                        <div class="mb-3">
                            <h6>Selected Files (@selectedFiles.Count):</h6>
                            <div style="max-height: 200px; overflow-y: auto;">
                                @foreach (var file in selectedFiles)
                                {
                                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                                        <span><i class="bi bi-file-earmark-code"></i> @file.Name</span>
                                        <div>
                                            <small class="text-muted me-2">@FormatFileSize(file.Size)</small>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveFile(file))">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="text-center">
                            <button class="btn btn-success me-2" @onclick="AnalyzeProject" disabled="@isAnalyzing">
                                @if (isAnalyzing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <text>Processing @selectedFiles.Count files...</text>
                                }
                                else
                                {
                                    <text><i class="bi bi-play-circle"></i> Analyze Project (@selectedFiles.Count files)</text>
                                }
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="ClearFiles">
                                <i class="bi bi-trash"></i> Clear All
                            </button>
                        </div>
                    }

                    @if (analysisResult != null)
                    {
                        <div class="mt-3">
                            <button class="btn btn-outline-info btn-sm me-2" @onclick="TestSimpleCharts">
                                Validate Dashboard
                            </button>
                            <button class="btn btn-outline-warning btn-sm" @onclick="DebugChartElements">
                                System Diagnostics
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @if (isAnalyzing)
        {
            <!-- Modal Overlay for Progress -->
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                AI-Powered Enterprise Analysis in Progress
                            </h5>
                        </div>
                        <div class="modal-body p-4">
                            @if (analysisProgress != null)
                            {
                                <!-- Executive Progress Display -->
                                <div class="text-center mb-4">
                                    <h4 class="text-primary">Analyzing Your Legacy Codebase</h4>
                                    <p class="text-muted">AI-powered insights generating in real-time</p>
                                </div>

                                <!-- Main Progress Bar -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold">Overall Progress</span>
                                        <span class="fw-bold text-primary">@($"{analysisProgress.ProgressPercentage:F1}")%</span>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                             style="width: @($"{analysisProgress.ProgressPercentage:F1}")%">
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Analysis Status -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <div class="card border-primary">
                                            <div class="card-body text-center">
                                                <i class="bi bi-file-earmark-code fs-2 text-primary mb-2"></i>
                                                <h6 class="card-title">Current File</h6>
                                                <p class="card-text fw-bold">@analysisProgress.CurrentFile</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-success">
                                            <div class="card-body text-center">
                                                <i class="bi bi-graph-up fs-2 text-success mb-2"></i>
                                                <h6 class="card-title">Files Completed</h6>
                                                <p class="card-text fw-bold">@analysisProgress.CompletedFiles of @analysisProgress.TotalFiles</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Status Banner -->
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="bi bi-cpu-fill fs-4 me-3"></i>
                                    <div>
                                        <strong>AI Analysis Status:</strong><br>
                                        <span>@analysisProgress.Status</span>
                                    </div>
                                </div>

                                <!-- Time and Performance Metrics -->
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border-end">
                                            <h6 class="text-muted mb-1">Analysis Type</h6>
                                            <strong class="text-primary">@analysisProgress.CurrentAnalysisType.ToUpper()</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border-end">
                                            <h6 class="text-muted mb-1">Elapsed Time</h6>
                                            <strong class="text-success">@($"{analysisProgress.ElapsedTime.TotalSeconds:F0}s")</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1">Remaining</h6>
                                        <strong class="text-warning">@(analysisProgress.TotalFiles - analysisProgress.CompletedFiles) files</strong>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="text-center">
                                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                                    <h5>Initializing AI Analysis Engine</h5>
                                    <p class="text-muted">Preparing intelligent code assessment...</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Results Section -->
        <div class="col-lg-8">
            @if (analysisResult != null)
            {
                <!-- Project Summary Cards -->
                <div class="card shadow mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Project Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 col-lg-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>@analysisResult.TotalFiles</h4>
                                        <small>Source Files</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>@analysisResult.TotalClasses</h4>
                                        <small>Classes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>@analysisResult.TotalMethods</h4>
                                        <small>Methods</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card bg-secondary text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>@analysisResult.TotalProperties</h4>
                                        <small>Properties</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @*<div class="alert alert-info">
                    <h5>Executive Dashboard Ready</h5>
                    <p>Interactive charts loading... If charts don't appear, detailed metrics are available below.</p>
                    <button class="btn btn-outline-primary btn-sm" @onclick="TestSimpleCharts">
                        Validate Dashboard
                    </button>
                </div>*@

                <!-- Charts Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5 class="alert-heading mb-3"><i class="bi bi-graph-up"></i> Executive Dashboard</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Files Requiring Immediate Review</h6>
                                            <small>Priority ranking by technical complexity</small>
                                        </div>
                                        <div class="card-body" style="height: 300px;">
                                            <canvas id="complexityChart" width="400" height="250"></canvas>
                                        </div>
                                        <div class="card-footer text-muted">
                                            <small><strong>Action:</strong> Focus development effort on highest-scoring files first</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">Project Risk Assessment</h6>
                                            <small>Risk distribution across entire codebase</small>
                                        </div>
                                        <div class="card-body" style="height: 300px;">
                                            <canvas id="riskChart" width="400" height="250"></canvas>
                                        </div>
                                        <div class="card-footer text-muted">
                                            <small><strong>Insight:</strong> Risk distribution indicates project complexity level</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card shadow">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Code Quality Assessment</h6>
                                <small>Maintenance optimization opportunities identified</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    @{
                                        var completedFiles = analysisResult.FileResults.Where(f => f.ComplexityScore > 0).ToList();
                                        var failedFiles = analysisResult.FileResults.Where(f => f.ComplexityScore <= 0).ToList();
                                        var averageComplexity = completedFiles.Any() ? completedFiles.Average(f => f.ComplexityScore) : 0;
                                    }

                                    <div class="col-md-8">
                                        @if (failedFiles.Any())
                                        {
                                            <div class="alert alert-warning">
                                                <h6 class="text-warning mb-2">
                                                    <i class="bi bi-exclamation-triangle"></i> Analysis Status: Incomplete
                                                </h6>
                                                <p class="mb-2">
                                                    @failedFiles.Count of @analysisResult.FileResults.Count files require completed analysis.
                                                    Successfully analyzed files show @(averageComplexity.ToString("F0")) average complexity score.
                                                </p>
                                            </div>
                                        }
                                        else if (averageComplexity <= 30)
                                        {
                                            <div class="alert alert-success">
                                                <h6 class="text-success mb-2">
                                                    <i class="bi bi-check-circle"></i> Positive Assessment: Well-Maintained Codebase
                                                </h6>
                                                <p class="mb-2">
                                                    Analysis indicates a well-structured project with manageable complexity levels.
                                                    All files fall within acceptable maintenance thresholds.
                                                </p>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning">
                                                <h6 class="text-warning mb-2">
                                                    <i class="bi bi-exclamation-triangle"></i> Moderate Complexity Detected
                                                </h6>
                                                <p class="mb-2">
                                                    Project shows @(averageComplexity.ToString("F0")) average complexity requiring attention.
                                                </p>
                                            </div>
                                        }

                                        <h6 class="mb-3">File Quality Overview</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>File</th>
                                                        <th>Quality Score</th>
                                                        <th>Status</th>
                                                        <th>Maintenance Level</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var file in analysisResult.FileResults.OrderByDescending(f => f.ComplexityScore).Take(5))
                                                    {
                                                        <tr>
                                                            <td class="fw-bold">@file.FileName</td>
                                                            <td>
                                                                @if (file.ComplexityScore > 0)
                                                                {
                                                                    <div class="progress" style="height: 20px; width: 100px;">
                                                                        <div class="progress-bar @GetQualityColorClass(file.ComplexityScore)"
                                                                             style="width: @(100 - file.ComplexityScore)%">
                                                                            @(100 - file.ComplexityScore)%
                                                                        </div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-warning">
                                                                        <i class="bi bi-exclamation-triangle"></i> Analysis Incomplete
                                                                    </span>
                                                                }
                                                            </td>
                                                            <td>
                                                                @if (file.ComplexityScore > 0)
                                                                {
                                                                    <span class="badge @GetStatusBadgeClass(file.ComplexityScore)">
                                                                        @GetStatusText(file.ComplexityScore)
                                                                    </span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                @if (file.ComplexityScore > 0)
                                                                {
                                                                    @GetMaintenanceLevel(file.ComplexityScore)
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">Analysis required</span>
                                                                }
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title @(failedFiles.Any() ? "text-warning" : averageComplexity > 30 ? "text-warning" : "text-success")">
                                                    <i class="bi bi-@(failedFiles.Any() ? "exclamation-triangle" : "shield-check")"></i> Quality Summary
                                                </h6>

                                                @if (failedFiles.Any())
                                                {
                                                    <div class="mb-3">
                                                        <strong>Overall Status:</strong><br>
                                                        <span class="text-warning">@failedFiles.Count file(s) require analysis</span>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>Completion Rate:</strong><br>
                                                        <small>@completedFiles.Count of @analysisResult.FileResults.Count files processed</small>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>Action Required:</strong><br>
                                                        <small>Complete analysis for remaining files</small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="mb-3">
                                                        <strong>Overall Status:</strong><br>
                                                        <span class="@(averageComplexity > 30 ? "text-warning" : "text-success")">
                                                            @(averageComplexity > 30 ? "Moderate Complexity" : "Well-Maintained Project")
                                                        </span>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>Maintenance Approach:</strong><br>
                                                        <small>@(averageComplexity > 30 ? "Structured improvement plan" : "Standard development practices")</small>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>Estimated Effort:</strong><br>
                                                        <small>@(averageComplexity > 30 ? "Moderate improvement cycles" : "Routine maintenance cycles")</small>
                                                    </div>
                                                }

                                            <hr>
                                            <div class="text-center">
                                                <strong class="@(failedFiles.Any() ? "text-warning" : averageComplexity > 30 ? "text-warning" : "text-success")">
                                                    @(failedFiles.Any() ? "Partial Analysis" : averageComplexity > 30 ? "Medium Risk Project" : "Low Risk Project")
                                                </strong><br>
                                                <small class="text-muted">
                                                    @(failedFiles.Any() ? $"{(double)completedFiles.Count / analysisResult.FileResults.Count * 100:F0}% Complete" :
                                                                                                        averageComplexity > 30 ? "Experienced team recommended" : "Suitable for standard team")
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            @if (businessMetrics != null)
                {
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow border-success">
                                <div class="card-header bg-success text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-0">
                                                <i class="bi bi-currency-dollar"></i> Strategic Business Impact
                                            </h5>
                                            <small>Quantified value proposition for executive review</small>
                                        </div>
                                        <div class="badge bg-light text-success fs-6">
                                            Net Value: @businessMetrics.TotalROI.ToString("C0")
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Top Row: Primary Metrics -->
                                    <div class="row g-3 text-center mb-4">
                                        <div class="col-lg-3 col-md-6">
                                            <div class="card bg-primary text-white h-100 border-0">
                                                <div class="card-body p-3">
                                                    <i class="bi bi-clock-history display-6 mb-2"></i>
                                                    <h3 class="mb-0">@businessMetrics.EstimatedDeveloperHoursSaved.ToString("F0")</h3>
                                                    <div>
                                                        <strong>Hours Saved</strong><br>
                                                        <small class="opacity-75">vs Manual Analysis</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="card bg-success text-white h-100 border-0">
                                                <div class="card-body p-3">
                                                    <i class="bi bi-currency-dollar display-6 mb-2"></i>
                                                    <h3 class="mb-0">@businessMetrics.ProjectCostSavings.ToString("C0")</h3>
                                                    <div>
                                                        <strong>Cost Avoidance</strong><br>
                                                        <small class="opacity-75"> $125/hour rate</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="card bg-warning text-dark h-100 border-0">
                                                <div class="card-body p-3">
                                                    <i class="bi bi-shield-check display-6 mb-2"></i>
                                                    <h3 class="mb-0">@businessMetrics.ComplianceCostAvoidance.ToString("C0")</h3>
                                                    <div>
                                                        <strong>Risk Mitigation</strong><br>
                                                        <small>Compliance value</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="card bg-info text-white h-100 border-0">
                                                <div class="card-body p-3">
                                                    <i class="bi bi-calendar-check display-6 mb-2"></i>
                                                    <h4 class="mb-0">@businessMetrics.MigrationTimeline</h4>
                                                    <div>
                                                        <strong>Timeline</strong><br>
                                                        <small class="opacity-75">Implementation</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bottom Row: Strategic Context -->
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="card bg-light border-0">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="bi bi-building text-primary"></i> Project Classification
                                                    </h6>
                                                    <div>
                                                        <strong>Scale:</strong> @businessMetrics.ProjectSize<br>
                                                        <strong>Strategy:</strong> @businessMetrics.RecommendedApproach
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card bg-light border-0">
                                                <div class="card-body">
                                                    <h6 class="card-title">
                                                        <i class="bi bi-shield-check text-success"></i> Risk Management
                                                    </h6>
                                                    <div>
                                                        @businessMetrics.RiskMitigation
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (analysisResult != null)
                {
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-clipboard-check"></i> Executive Summary & Recommendations
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <!-- Left Column: Assessment & Actions -->
                                        <div class="col-md-8">
                                            <h6 class="text-success mb-3">
                                                <i class="bi bi-graph-up"></i> Project Assessment
                                            </h6>
                                            <p class="mb-3">
                                                Analysis of <strong>@analysisResult.TotalFiles files</strong> containing
                                                <strong>@analysisResult.TotalClasses classes</strong> and
                                                <strong>@analysisResult.TotalMethods methods</strong>.
                                                Overall risk level:
                                                <span class="badge bg-@(GetRiskBadgeClass())">
                                                    @analysisResult.OverallRiskLevel
                                                </span>
                                            </p>

                                            <h6 class="text-primary mb-3">
                                                <i class="bi bi-target"></i> Priority Actions
                                            </h6>

                                            @if (analysisResult.KeyRecommendations.Any())
                                            {
                                                <ul class="list-unstyled">
                                                    @foreach (var recommendation in analysisResult.KeyRecommendations.Take(3))
                                                    {
                                                        <li class="mb-2">
                                                            <i class="bi bi-arrow-right text-primary"></i>
                                                            <strong>@recommendation</strong>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <div class="alert alert-success">
                                                    <strong>Recommended Approach:</strong>
                                                    Standard development practices suitable for this project complexity level.
                                                </div>
                                            }
                                        </div>

                                        <!-- Right Column: Business Impact -->
                                        <div class="col-md-4">
                                            <div class="card bg-gradient-primary text-white">
                                                <div class="card-body text-center">
                                                    <h6 class="card-title text-white">Business Impact Assessment</h6>

                                                    <div class="display-6 text-@(GetComplexityTextClass()) mb-2">
                                                        @analysisResult.OverallComplexityScore<small>/100</small>
                                                    </div>
                                                    <small class="text-muted">Complexity Score</small>

                                                    <hr />

                                                    <div class="mt-3">
                                                        <strong class="text-@(GetTimelineColorClass())">
                                                            @GetExecutiveTimeline()
                                                        </strong>
                                                        <br />
                                                        <small class="text-muted">Estimated Timeline</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="card shadow mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-briefcase"></i> Executive Assessment Summary
                                </h5>
                                <small>Strategic overview for decision makers</small>
                            </div>
                            <div class="badge bg-light text-dark fs-6">
                                Risk Level: @analysisResult.OverallRiskLevel
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-graph-up"></i> Project Assessment
                                </h6>
                                <p class="mb-3">
                                    Analysis of <strong>@analysisResult.TotalFiles files</strong> containing
                                    <strong>@analysisResult.TotalClasses classes</strong> and
                                    <strong>@analysisResult.TotalMethods methods</strong>.
                                    Overall risk level:
                                    <span class="badge bg-@(GetRiskBadgeClass())">
                                        @analysisResult.OverallRiskLevel
                                    </span>
                                </p>

                                <h6 class="text-success mb-3">
                                    <i class="bi bi-target"></i> Strategic Recommendations
                                </h6>

                                @if (analysisResult.KeyRecommendations.Any())
                                {
                                    <ul class="list-unstyled">
                                        @foreach (var recommendation in analysisResult.KeyRecommendations.Take(3))
                                        {
                                            <li class="mb-2">
                                                <i class="bi bi-arrow-right text-success"></i>
                                                <strong>@recommendation</strong>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="alert alert-success">
                                        <strong>Recommended Approach:</strong>
                                        Standard development practices suitable for this project complexity level.
                                    </div>
                                }
                            </div>

                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Complexity Assessment</h6>

                                        <div class="display-6 mb-2">
                                            @analysisResult.OverallComplexityScore<small>/100</small>
                                        </div>
                                        <small>Technical Complexity Score</small>

                                        <hr class="bg-light">

                                        <div class="mt-3">
                                            <strong>@GetExecutiveTimeline()</strong>
                                            <br>
                                            <small>Estimated Timeline</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment Summary -->
                <div class="card shadow mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-shield-check"></i> Risk Assessment Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Overall Complexity Score</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar @GetComplexityColorClass(analysisResult.OverallComplexityScore)"
                                         style="width: @(analysisResult.OverallComplexityScore)%">
                                        @analysisResult.OverallComplexityScore/100
                                    </div>
                                </div>
                                <small class="text-muted">Assessment based on code structure and dependencies</small>
                            </div>
                            <div class="col-md-6">
                                <h6>Migration Risk Level</h6>
                                <h3 class="@GetRiskTextColorClass(analysisResult.OverallRiskLevel)">
                                    @analysisResult.OverallRiskLevel
                                </h3>
                                <small class="text-muted">@GetRiskDescription(analysisResult.OverallRiskLevel)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assessment -->
                @if (!string.IsNullOrEmpty(analysisResult.OverallAssessment))
                {
                    <div class="card shadow mb-3">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-cpu"></i> Intelligent Assessment Summary</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">@analysisResult.OverallAssessment</p>
                        </div>
                    </div>
                }

                <!-- Strategic Recommendations -->
                @if (analysisResult.KeyRecommendations.Any())
                {
                    <div class="card shadow mb-3">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Strategic Recommendations</h5>
                        </div>
                        <div class="card-body">
                            @foreach (var recommendation in analysisResult.KeyRecommendations)
                            {
                                <div class="alert alert-light border-start border-primary border-3">
                                    <small><i class="bi bi-arrow-right"></i> @recommendation</small>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Detailed File Analysis -->
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Detailed File Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div style="max-height: 400px; overflow-y: auto;">
                            @foreach (var fileResult in analysisResult.FileResults.OrderByDescending(f => f.ComplexityScore))
                            {
                                <div class="card mb-2">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1">
                                                    <i class="bi bi-file-earmark-code"></i> @fileResult.FileName
                                                </h6>
                                                <div class="row mb-2">
                                                    <div class="col-3">
                                                        <small class="text-muted">Classes:</small>
                                                        <strong class="d-block">@fileResult.StaticAnalysis.ClassCount</strong>
                                                    </div>
                                                    <div class="col-3">
                                                        <small class="text-muted">Methods:</small>
                                                        <strong class="d-block">@fileResult.StaticAnalysis.MethodCount</strong>
                                                    </div>
                                                    <div class="col-3">
                                                        <small class="text-muted">Properties:</small>
                                                        <strong class="d-block">@fileResult.StaticAnalysis.PropertyCount</strong>
                                                    </div>
                                                    <div class="col-3">
                                                        <small class="text-muted">Complexity:</small>
                                                        <strong class="d-block @GetComplexityTextColor(fileResult.ComplexityScore)">
                                                            @fileResult.ComplexityScore/100
                                                        </strong>
                                                    </div>
                                                </div>
                                                @if (!string.IsNullOrEmpty(fileResult.AIInsight))
                                                {
                                                    <div class="bg-light p-3 rounded mt-2">
                                                        <h6 class="text-muted mb-2">
                                                            <i class="bi bi-cpu"></i> Assessment Summary
                                                        </h6>
                                                        <div class="text-dark" style="line-height: 1.6;">
                                                            @((MarkupString)FormatAIInsight(fileResult.AIInsight))
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            <div class="ms-3">
                                                <span class="badge @GetComplexityBadgeClass(fileResult.ComplexityScore)">
                                                    @GetComplexityLabel(fileResult.ComplexityScore)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Executive Actions -->
                <div class="card shadow mt-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-download"></i> Executive Reporting</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Comprehensive Analysis Report</h6>
                                <small class="text-muted">
                                    Professional assessment report for stakeholder distribution
                                </small>
                            </div>
                            <button class="btn btn-success" @onclick="DownloadExecutiveReport" disabled="@isGeneratingReport">
                                @if (isGeneratingReport)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-file-earmark-pdf"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

    /* Improve card spacing and alignment */
    .card {
        margin-bottom: 1rem;
    }

    /* Better text formatting for AI insights */
    .ai-insight-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #495057;
    }

    /* Improve file list display */
    .file-list-item {
        transition: background-color 0.2s ease;
    }

        .file-list-item:hover {
            background-color: #f8f9fa !important;
        }

    /* Center align charts better */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 250px;
    }

    .insight-text {
        color: #2c3e50 !important; /* Darker text for better readability */
        font-weight: 500;
    }

    .card-body small {
        color: #495057 !important; /* Ensure all small text is readable */
    }

    .spin {
        animation: spin 2s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    private string selectedAnalysisType = "general";
    private bool isAnalyzing = false;
    private bool isGeneratingReport = false;
    private string statusMessage = "";
    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();
    private MultiFileAnalysisResult? analysisResult;
    private BusinessMetrics? businessMetrics;

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        var newFiles = e.GetMultipleFiles(50); // Allow more files for folder selection
        var csFiles = newFiles.Where(f => f.Name.EndsWith(".cs", StringComparison.OrdinalIgnoreCase)).ToList();

        // Filter out generated/designer files that aren't useful for analysis
        var sourceFiles = csFiles.Where(f =>
            !f.Name.Contains(".Designer.") &&
            !f.Name.Contains(".g.cs") &&
            !f.Name.Contains(".g.i.cs") &&
            !f.Name.Contains("AssemblyInfo.cs") &&
            !f.Name.Contains("GlobalAssemblyInfo.cs") &&
            !f.Name.StartsWith("Temp", StringComparison.OrdinalIgnoreCase) &&
            !f.Name.Contains("obj\\Debug") &&
            !f.Name.Contains("obj\\Release")
        ).ToList();

        if (sourceFiles.Count != newFiles.Count())
        {
            statusMessage = $"Folder selection: Found {sourceFiles.Count} relevant C# source files from {newFiles.Count()} total files.";
        }
        else
        {
            statusMessage = $"Successfully loaded {sourceFiles.Count} C# source files from project folder.";
        }

        // Clear existing and add new files
        selectedFiles.Clear();
        selectedFiles.AddRange(sourceFiles.Take(20)); // Limit to 20 for performance

        if (sourceFiles.Count > 20)
        {
            statusMessage += $" Limited to first 20 files for performance.";
        }

        StateHasChanged();
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Handled by preventDefault
    }

    private void HandleFileDrop(DragEventArgs e)
    {
        statusMessage = "File upload: Please use the Browse Files button to select source files.";
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        statusMessage = $"Removed {file.Name}. {selectedFiles.Count} files remaining for analysis.";
        StateHasChanged();
    }

    private void ClearFiles()
    {
        selectedFiles.Clear();
        statusMessage = "All files cleared. Ready for new file selection.";
        StateHasChanged();
    }

    private async Task TestSimpleCharts()
    {
        try
        {
            Console.WriteLine("Testing simple charts...");
            statusMessage = "Testing chart functionality...";
            StateHasChanged();

            await Task.Delay(500); // Allow UI to render

            // Test if Chart.js is loaded
            var chartLoaded = await JSRuntime.InvokeAsync<bool>("eval", "typeof Chart !== 'undefined'");
            Console.WriteLine($"Chart.js loaded: {chartLoaded}");

            if (!chartLoaded)
            {
                statusMessage = "Chart.js library not loaded";
                return;
            }

            // Test simple chart creation
            var testResult = await JSRuntime.InvokeAsync<bool>("testSimpleChart");
            Console.WriteLine($"Test chart result: {testResult}");

            if (testResult)
            {
                statusMessage = "Chart test successful! Chart.js is working.";
            }
            else
            {
                statusMessage = "Chart test failed. Check console for details.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Test error: {ex.Message}");
            statusMessage = $"Test error: {ex.Message}";
        }
    }

    private async Task DebugChartElements()
    {
        try
        {
            Console.WriteLine("Debugging chart elements...");

            // Check if canvas elements exist
            var canvasInfo = await JSRuntime.InvokeAsync<string>("eval", @"
            Array.from(document.querySelectorAll('canvas')).map(c =>
                c.id + ': ' + c.offsetWidth + 'x' + c.offsetHeight
            ).join(', ')
        ");

            Console.WriteLine($"Canvas elements: {canvasInfo}");
            statusMessage = $"Canvas elements: {canvasInfo}";

            // Check Chart.js version
            var chartVersion = await JSRuntime.InvokeAsync<string>("eval", @"
            typeof Chart !== 'undefined' ? Chart.version || 'Unknown version' : 'Not loaded'
        ");

            Console.WriteLine($"Chart.js version: {chartVersion}");

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Debug error: {ex.Message}");
            statusMessage = $"Debug error: {ex.Message}";
        }
    }

    private async Task GenerateCharts()
    {
        if (analysisResult?.FileResults == null || !analysisResult.FileResults.Any())
        {
            Console.WriteLine("No file results available for chart generation");
            return;
        }

        try
        {
            Console.WriteLine("Creating executive charts...");
            statusMessage = "Generating executive dashboard...";
            StateHasChanged();

            // Wait for DOM
            await Task.Delay(1500);

            // FIXED: Ensure we have valid data
            var validFiles = analysisResult.FileResults
                .Where(f => f != null && !string.IsNullOrEmpty(f.FileName))
                .ToList();

            if (!validFiles.Any())
            {
                Console.WriteLine("No valid files for chart generation");
                return;
            }

            // FIXED: Create complexity chart with proper data
            var topFiles = validFiles
                .OrderByDescending(f => f.ComplexityScore)
                .Take(8)
                .ToList();

            var fileNames = topFiles.Select(f => f.FileName.Length > 12 ? f.FileName.Substring(0, 12) + "..." : f.FileName).ToArray();
            var complexityScores = topFiles.Select(f => (object)f.ComplexityScore).ToArray();

            Console.WriteLine($"Creating complexity chart with {fileNames.Length} files: [{string.Join(", ", complexityScores)}]");

            var complexitySuccess = await JSRuntime.InvokeAsync<bool>("createSimpleChart",
                "complexityChart",
                "bar",
                fileNames,
                complexityScores,
                "Highest Risk Files - Complexity Analysis"
            );

            // FIXED: Create risk distribution with actual counts
            var lowCount = validFiles.Count(f => f.ComplexityScore < 40);
            var mediumCount = validFiles.Count(f => f.ComplexityScore >= 40 && f.ComplexityScore < 70);
            var highCount = validFiles.Count(f => f.ComplexityScore >= 70);

            Console.WriteLine($"Risk distribution: Low={lowCount}, Medium={mediumCount}, High={highCount}");

            if (lowCount + mediumCount + highCount > 0)
            {
                var riskLabels = new[] { "Low Risk", "Medium Risk", "High Risk" };
                var riskValues = new object[] { lowCount, mediumCount, highCount };

                var riskSuccess = await JSRuntime.InvokeAsync<bool>("createSimpleChart",
                    "riskChart",
                    "doughnut",
                    riskLabels,
                    riskValues,
                    "Project Risk Distribution"
                );

                Console.WriteLine($"Charts created: Complexity={complexitySuccess}, Risk={riskSuccess}");

                if (complexitySuccess || riskSuccess)
                {
                    statusMessage = "Executive dashboard created successfully.";
                }
                else
                {
                    statusMessage = "Dashboard generation completed. Review detailed analysis below.";
                }
            }
            else
            {
                statusMessage = "Analysis completed. Detailed insights available in file breakdown.";
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart error: {ex.Message}");
            statusMessage = "Analysis completed successfully. Detailed breakdown available below.";
        }
    }

    private async Task DownloadExecutiveReport()
    {
        if (analysisResult == null) return;

        isGeneratingReport = true;
        statusMessage = "Generating comprehensive executive report...";
        StateHasChanged();

        try
        {
            // Generate executive summary report
            var reportContent = GenerateExecutiveReport();
            var reportBytes = System.Text.Encoding.UTF8.GetBytes(reportContent);
            var fileName = $"executive-analysis-{selectedAnalysisType}-{DateTime.Now:yyyyMMdd-HHmmss}.md";

            await FileDownloadService.DownloadFileAsync(fileName, reportBytes, "text/markdown");
            statusMessage = $"Executive report generated successfully: {fileName}";
        }
        catch (Exception ex)
        {
            statusMessage = $"Report generation failed: {ex.Message}";
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private string GenerateExecutiveReport()
    {
        if (analysisResult == null) return "";

        var report = new StringBuilder();

        // Executive Summary Header
        report.AppendLine("# Executive Project Analysis Report");
        report.AppendLine($"**Analysis Type**: {selectedAnalysisType.ToUpper()} ASSESSMENT");
        report.AppendLine($"**Report Generated**: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        report.AppendLine($"**Project Scope**: {analysisResult.TotalFiles} source files analyzed");
        report.AppendLine();

        // Executive Summary
        report.AppendLine("## Executive Summary");
        report.AppendLine($"This comprehensive analysis evaluated {analysisResult.TotalFiles} source files containing {analysisResult.TotalClasses} classes and {analysisResult.TotalMethods} methods. ");
        report.AppendLine($"The overall project complexity is rated as **{analysisResult.OverallRiskLevel}** with a risk score of {analysisResult.OverallComplexityScore}/100.");
        report.AppendLine();

        // FIXED: Use real data calculations directly in the report
        var manualHours = CalculateManualAnalysisHours(analysisResult);
        var costSavings = manualHours * 125;

        // Strategic Business Context with real data
        report.AppendLine("## Strategic Business Context");
        report.AppendLine("**Market Timing**: Legacy modernization market projected 15% annual growth");
        report.AppendLine("**Competitive Advantage**: AI-powered analysis delivers results 20x faster than manual assessment");
        report.AppendLine($"**Risk Management**: {analysisResult.OverallRiskLevel} complexity level (score: {analysisResult.OverallComplexityScore}/100) requires immediate attention");
        report.AppendLine();

        report.AppendLine("## Financial Impact Analysis");
        report.AppendLine($"**Code Complexity**: {analysisResult.TotalClasses} classes with {analysisResult.TotalMethods} methods analyzed");
        report.AppendLine($"**Estimated Manual Analysis Time**: {manualHours} hours");
        report.AppendLine($"**AI Analysis Time**: 3 minutes");
        report.AppendLine($"**Time Savings**: {manualHours} hours manual vs. 3 minutes AI = {manualHours * 60 - 3} minutes saved");
        report.AppendLine($"**Cost Avoidance**: ${costSavings:N0} in developer time cost avoidance");
        report.AppendLine();

        // Competitive Advantage Analysis with real data
        var speedMultiplier = (manualHours * 60) / 3;
        report.AppendLine("## Competitive Advantage Analysis");
        report.AppendLine();
        report.AppendLine("### Speed Advantage");
        report.AppendLine($"- **Traditional Approach**: {manualHours} hours manual analysis");
        report.AppendLine($"- **AI-Enhanced Approach**: 3 minutes automated analysis");
        report.AppendLine($"- **Speed Multiplier**: {speedMultiplier:F0}x faster time-to-insight");
        report.AppendLine();
        report.AppendLine("### Cost Advantage");
        report.AppendLine($"- **Traditional Manual Review**: ${costSavings:N0} ({manualHours} hours @ $125/hour)");
        report.AppendLine($"- **AI-Enhanced Analysis**: $5 per comprehensive assessment");
        report.AppendLine($"- **Cost Reduction**: ${costSavings - 5:N0} savings per analysis");
        report.AppendLine();
        report.AppendLine("### Project Metrics");
        report.AppendLine($"- **Code Complexity**: {analysisResult.OverallComplexityScore}/100 complexity score");
        report.AppendLine($"- **Risk Assessment**: {analysisResult.OverallRiskLevel} risk level based on actual code structure");
        report.AppendLine($"- **Analysis Scope**: {analysisResult.TotalClasses} classes, {analysisResult.TotalMethods} methods, {analysisResult.TotalProperties} properties");
        report.AppendLine();

        // Key Metrics
        report.AppendLine("## Key Performance Indicators");
        report.AppendLine("| Metric | Value | Assessment |");
        report.AppendLine("|--------|--------|------------|");
        report.AppendLine($"| Source Files | {analysisResult.TotalFiles} | {GetFileCountAssessment(analysisResult.TotalFiles)} |");
        report.AppendLine($"| Code Classes | {analysisResult.TotalClasses} | {GetClassCountAssessment(analysisResult.TotalClasses)} |");
        report.AppendLine($"| Methods | {analysisResult.TotalMethods} | {GetMethodCountAssessment(analysisResult.TotalMethods)} |");
        report.AppendLine($"| Complexity Score | {analysisResult.OverallComplexityScore}/100 | {analysisResult.OverallRiskLevel} Risk Level |");
        report.AppendLine();

        // Risk Assessment
        var riskStats = GetRiskStatistics();
        report.AppendLine("## Risk Assessment");
        report.AppendLine($"- **Low Risk Files**: {riskStats.low} files ({riskStats.lowPercent:F1}%)");
        report.AppendLine($"- **Medium Risk Files**: {riskStats.medium} files ({riskStats.mediumPercent:F1}%)");
        report.AppendLine($"- **High Risk Files**: {riskStats.high} files ({riskStats.highPercent:F1}%)");
        report.AppendLine();

        // Strategic Recommendations
        if (analysisResult.KeyRecommendations.Any())
        {
            report.AppendLine("## Strategic Recommendations");
            foreach (var recommendation in analysisResult.KeyRecommendations)
            {
                report.AppendLine($"- {recommendation}");
            }
            report.AppendLine();
        }

        // Business Impact
        report.AppendLine("## Business Impact Assessment");
        report.AppendLine($"**Migration Timeline**: {GetMigrationTimeline(analysisResult.OverallComplexityScore)}");
        report.AppendLine($"**Resource Requirements**: {GetResourceRequirements(analysisResult.OverallComplexityScore)}");
        report.AppendLine($"**Financial Impact**: {GetFinancialImpact(analysisResult.OverallComplexityScore)}");
        report.AppendLine();

        // Technical Details
        report.AppendLine("## Detailed File Analysis");
        foreach (var file in analysisResult.FileResults.OrderByDescending(f => f.ComplexityScore).Take(10))
        {
            report.AppendLine($"### {file.FileName}");
            report.AppendLine($"- **Complexity Score**: {file.ComplexityScore}/100");
            report.AppendLine($"- **Classes**: {file.StaticAnalysis.ClassCount}");
            report.AppendLine($"- **Methods**: {file.StaticAnalysis.MethodCount}");
            report.AppendLine($"- **Properties**: {file.StaticAnalysis.PropertyCount}");
            if (!string.IsNullOrEmpty(file.AIInsight))
            {
                report.AppendLine($"- **Assessment**: {file.AIInsight}");
            }
            report.AppendLine();
        }

        // Next Steps
        report.AppendLine("## Recommended Next Steps");
        report.AppendLine("1. **Immediate Actions**: Address high-complexity files identified in this analysis");
        report.AppendLine("2. **Resource Planning**: Allocate development resources based on complexity assessment");
        report.AppendLine("3. **Timeline Development**: Create detailed project timeline using risk assessment data");
        report.AppendLine("4. **Stakeholder Communication**: Present findings to technical and business stakeholders");
        report.AppendLine("5. **Monitoring Strategy**: Establish metrics tracking for modernization progress");

        return report.ToString();
    }

    private (int low, int medium, int high, double lowPercent, double mediumPercent, double highPercent) GetRiskStatistics()
    {
        if (analysisResult?.FileResults == null) return (0, 0, 0, 0, 0, 0);

        var total = analysisResult.FileResults.Count;
        var low = analysisResult.FileResults.Count(f => f.ComplexityScore < 40);
        var medium = analysisResult.FileResults.Count(f => f.ComplexityScore >= 40 && f.ComplexityScore < 70);
        var high = analysisResult.FileResults.Count(f => f.ComplexityScore >= 70);

        return (low, medium, high,
                low * 100.0 / total,
                medium * 100.0 / total,
                high * 100.0 / total);
    }

    private string FormatFileSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:n1} {suffixes[counter]}";
    }

    private string GetStatusAlertClass() => statusMessage.Contains("error") || statusMessage.Contains("failed") ? "alert-danger" : "alert-info";

    private string GetComplexityColorClass(int score)
    {
        if (score < 30) return "bg-success";
        if (score < 60) return "bg-warning";
        return "bg-danger";
    }

    private string GetRiskTextColorClass(string risk) => risk switch
    {
        "LOW" => "text-success",
        "MEDIUM" => "text-warning",
        "HIGH" => "text-danger",
        _ => "text-secondary"
    };

    private string GetRiskDescription(string risk) => risk switch
    {
        "LOW" => "Standard migration process applicable",
        "MEDIUM" => "Structured approach with experienced team required",
        "HIGH" => "Complex migration requiring specialist expertise",
        _ => "Assessment in progress"
    };

    private string GetComplexityTextColor(int score)
    {
        if (score < 40) return "text-success";
        if (score < 70) return "text-warning";
        return "text-danger";
    }

    private string GetComplexityBadgeClass(int score)
    {
        if (score < 40) return "bg-success";
        if (score < 70) return "bg-warning text-dark";
        return "bg-danger";
    }

    private string GetComplexityLabel(int score)
    {
        if (score < 40) return "Low Risk";
        if (score < 70) return "Medium Risk";
        return "High Risk";
    }

    private async Task HandleIndividualFileSelection(InputFileChangeEventArgs e)
    {
        var newFiles = e.GetMultipleFiles(20); // Allow more files for folder selection
        var csFiles = newFiles.Where(f => f.Name.EndsWith(".cs", StringComparison.OrdinalIgnoreCase)).ToList();

        // Filter out common non-source files
        csFiles = csFiles.Where(f =>
            !f.Name.Contains(".Designer.") &&
            !f.Name.Contains(".g.cs") &&
            !f.Name.Contains("AssemblyInfo.cs") &&
            !f.Name.StartsWith("Temp", StringComparison.OrdinalIgnoreCase)
        ).ToList();

        if (csFiles.Count != newFiles.Count())
        {
            statusMessage = $"Filtered to {csFiles.Count} C# source files from {newFiles.Count()} total files.";
        }
        else
        {
            statusMessage = $"Successfully selected {csFiles.Count} C# source files.";
        }

        selectedFiles.AddRange(csFiles);
        StateHasChanged();
    }

    private string FormatAIInsight(string insight)
    {
        if (string.IsNullOrEmpty(insight))
            return "<div class='alert alert-light'><em>Assessment pending - analysis in progress</em></div>";

        try
        {
            // Clean up the text aggressively
            var cleaned = insight
                .Replace("###", "")
                .Replace("##", "")
                .Replace("#", "")
                .Replace("**", "")
                .Replace("*", "")
                .Replace("```", "")
                .Replace("`", "")
                .Replace("---", "")
                .Trim();

            // Split into sentences and clean them
            var sentences = cleaned.Split(new[] { '.', '!', '?' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => s.Length > 10 && !s.StartsWith("Priority") && !s.StartsWith("Implementation"))
                .Take(3) // Limit to 3 key insights for executives
                .ToList();

            if (!sentences.Any())
            {
                return "<div class='alert alert-warning'><strong>Assessment Summary:</strong> Code analysis completed. Technical details require manual review.</div>";
            }

            var formatted = new System.Text.StringBuilder();
            formatted.Append("<div class='executive-summary'>");

            for (int i = 0; i < sentences.Count; i++)
            {
                var sentence = sentences[i].Trim();
                if (!sentence.EndsWith(".")) sentence += ".";

                // Format as executive-friendly insight
                formatted.Append($"<div class='insight-item mb-2'>");
                formatted.Append($"<span class='badge bg-primary me-2'>{i + 1}</span>");
                formatted.Append($"<span class='insight-text'>{sentence}</span>");
                formatted.Append("</div>");
            }

            formatted.Append("</div>");
            return formatted.ToString();
        }
        catch (Exception)
        {
            return "<div class='alert alert-info'><strong>Technical Assessment:</strong> Code structure analyzed. Detailed recommendations available upon request.</div>";
        }
    }

    private string GetComplexityCardClass(int score) => score switch
    {
        >= 70 => "bg-danger",
        >= 40 => "bg-warning text-dark",
        _ => "bg-success"
    };

    private string GetRiskBadgeClass()
    {
        return analysisResult?.OverallRiskLevel switch
        {
            "LOW" => "success",
            "MEDIUM" => "warning",
            "HIGH" => "danger",
            _ => "secondary"
        };
    }

    private string GetComplexityTextClass()
    {
        if (analysisResult == null) return "secondary";

        if (analysisResult.OverallComplexityScore < 40)
            return "success";
        else if (analysisResult.OverallComplexityScore < 70)
            return "warning";
        else
            return "danger";
    }

    private string GetTimelineColorClass()
    {
        if (analysisResult == null) return "secondary";

        if (analysisResult.OverallComplexityScore < 40)
            return "success";
        else if (analysisResult.OverallComplexityScore < 70)
            return "warning";
        else
            return "danger";
    }

    private string GetExecutiveTimeline()
    {
        if (analysisResult == null) return "Assessment Pending";

        if (analysisResult.OverallComplexityScore < 30)
            return "2-4 weeks (Low complexity migration)";
        else if (analysisResult.OverallComplexityScore < 50)
            return "4-8 weeks (Standard migration process)";
        else if (analysisResult.OverallComplexityScore < 70)
            return "8-12 weeks (Complex migration - phased approach)";
        else
            return "12+ weeks (High complexity - dedicated team required)";
    }

    private AnalysisProgress? analysisProgress;

    private async Task AnalyzeProject()
    {
        if (!selectedFiles.Any()) return;

        isAnalyzing = true;
        analysisProgress = new AnalysisProgress
        {
            TotalFiles = selectedFiles.Count,
            CurrentAnalysisType = selectedAnalysisType,
            StartTime = DateTime.Now
        };

        businessMetrics = null; // Reset business metrics
        statusMessage = $"Starting comprehensive analysis of {selectedFiles.Count} files...";
        StateHasChanged();

        var progress = new Progress<AnalysisProgress>(p =>
        {
            analysisProgress = p;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            analysisResult = await MultiFileAnalysisService.AnalyzeMultipleFilesWithProgressAsync(
                selectedFiles, selectedAnalysisType, progress);

            // Calculate business metrics after analysis
            businessMetrics = await CalculateBusinessMetricsAsync(analysisResult);

            statusMessage = $"Analysis completed! ROI: {businessMetrics.EstimatedDeveloperHoursSaved * businessMetrics.AverageHourlyRate:C0} value delivered.";
            statusMessage += $" Compliance Cost Avoidance: {businessMetrics.ComplianceCostAvoidance:C0}.";
            statusMessage += $" Project Size: {businessMetrics.ProjectSize}.";
            // Adding more detail to the status message
            statusMessage += $" Estimated Developer Hours Saved: {businessMetrics.EstimatedDeveloperHoursSaved}.";
            statusMessage += $" Average Hourly Rate: {businessMetrics.AverageHourlyRate:C0}.";
            statusMessage += $" Compliance Cost Avoidance: {businessMetrics.ComplianceCostAvoidance:C0}.";
            statusMessage += $" Project Size: {businessMetrics.ProjectSize}.";

            await GenerateCharts();
        }
        catch (Exception ex)
        {
            statusMessage = $"Analysis encountered an error: {ex.Message}";
        }
        finally
        {
            isAnalyzing = false;
            analysisProgress = null;
            StateHasChanged();
        }
    }

    private async Task<BusinessMetrics> CalculateBusinessMetricsAsync(MultiFileAnalysisResult result)
    {
        return await Task.FromResult(new BusinessMetrics
        {
            EstimatedDeveloperHoursSaved = result.TotalMethods * 0.5m * ((result.OverallComplexityScore / 100m) + 0.5m),
            MigrationTimeline = result.OverallComplexityScore switch
            {
                < 30 => "2-4 weeks",
                < 50 => "4-8 weeks",
                < 70 => "8-12 weeks",
                _ => "12+ weeks"
            },
            RiskMitigation = $"{result.OverallRiskLevel} risk level with appropriate mitigation strategy",
            ComplianceCostAvoidance = result.OverallRiskLevel switch
            {
                "HIGH" => 15000m,
                "MEDIUM" => 8000m,
                "LOW" => 3000m,
                _ => 1000m
            },
            ProjectSize = result.TotalFiles switch
            {
                < 5 => "Small Project",
                < 15 => "Medium Project",
                < 30 => "Large Project",
                _ => "Enterprise Project"
            },
            RecommendedApproach = result.OverallComplexityScore switch
            {
                < 30 => "Standard development practices",
                < 50 => "Structured approach with experienced team",
                < 70 => "Phased migration with risk mitigation",
                _ => "Enterprise methodology with dedicated team"
            }
        });
    }

    private int CalculateManualAnalysisHours(MultiFileAnalysisResult result)
    {
        var baseHours = result.TotalClasses * 2; // 2 hours per class
        var methodHours = result.TotalMethods * 0.25; // 15 minutes per method
        var dependencyHours = result.TotalUsingStatements * 0.5; // 30 minutes per dependency

        return (int)(baseHours + methodHours + dependencyHours);
    }

    private string GetFileCountAssessment(int fileCount)
    {
        if (fileCount < 5) return "Small project scope";
        if (fileCount < 15) return "Medium project complexity";
        if (fileCount < 30) return "Large project - requires structured approach";
        return "Enterprise-scale project - dedicated team recommended";
    }

    private string GetClassCountAssessment(int classCount)
    {
        if (classCount < 10) return "Low structural complexity";
        if (classCount < 25) return "Moderate architectural complexity";
        if (classCount < 50) return "Complex architecture - careful planning required";
        return "Highly complex system - expert analysis recommended";
    }

    private string GetMethodCountAssessment(int methodCount)
    {
        if (methodCount < 50) return "Manageable codebase size";
        if (methodCount < 150) return "Medium codebase - standard development practices apply";
        if (methodCount < 300) return "Large codebase - requires systematic approach";
        return "Very large codebase - enterprise development practices essential";
    }

    private string GetMigrationTimeline(int complexityScore)
    {
        if (complexityScore < 30) return "2-4 weeks (Low complexity migration)";
        if (complexityScore < 50) return "4-8 weeks (Standard migration process)";
        if (complexityScore < 70) return "8-16 weeks (Complex migration - phased approach)";
        return "16+ weeks (High complexity - dedicated team required)";
    }

    private string GetResourceRequirements(int complexityScore)
    {
        if (complexityScore < 30) return "1-2 developers, standard skillset";
        if (complexityScore < 50) return "2-3 developers, experienced team";
        if (complexityScore < 70) return "3-5 developers, senior expertise required";
        return "5+ developers, specialist migration team with architect oversight";
    }

    private string GetFinancialImpact(int complexityScore)
    {
        if (complexityScore < 30) return "Low cost - standard development rates";
        if (complexityScore < 50) return "Moderate cost - budget for quality assurance";
        if (complexityScore < 70) return "High cost - include risk mitigation budget";
        return "Very high cost - executive approval recommended";
    }

    private string GetRowClass(int complexity) => complexity switch
    {
        > 70 => "table-danger",
        > 40 => "table-warning",
        _ => "table-success"
    };

    private string GetEffortEstimate(int complexity) => complexity switch
    {
        > 70 => "3-5 days",
        > 40 => "1-2 days",
        _ => "2-4 hours"
    };

    private string GetBusinessImpact(int complexity) => complexity switch
    {
        > 70 => "High - blocks deployment",
        > 40 => "Medium - increases risk",
        _ => "Low - maintenance only"
    };

    private string GetQualityColorClass(int complexity) => complexity switch
    {
        > 50 => "bg-danger",
        > 30 => "bg-warning",
        _ => "bg-success"
    };

    private string GetStatusBadgeClass(int complexity) => complexity switch
    {
        > 50 => "bg-danger",
        > 30 => "bg-warning",
        _ => "bg-success"
    };

    private string GetStatusText(int complexity) => complexity switch
    {
        > 50 => "Needs Review",
        > 30 => "Monitor",
        _ => "Good"
    };

    private string GetMaintenanceLevel(int complexity) => complexity switch
    {
        > 50 => "Immediate attention",
        > 30 => "Scheduled review",
        _ => "Standard maintenance"
    };

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyAllCharts");
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}