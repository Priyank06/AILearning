@page "/multiagent"
@using PoC1_LegacyAnalyzer_Web.Components
@using PoC1_LegacyAnalyzer_Web.Models
@using PoC1_LegacyAnalyzer_Web.Models.AgentCommunication
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Models.ProjectAnalysis
@using PoC1_LegacyAnalyzer_Web.Services
@inject IAgentOrchestrationService OrchestrationService
@inject ICodeAnalysisService CodeAnalysisService
@inject IEnhancedProjectAnalysisService EnhancedProjectAnalysisService

<PageTitle>Multi-Agent Team Analysis</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="bg-gradient-primary text-white p-4 rounded shadow">
                <h1 class="display-4 mb-2"> Multi-Agent Team Analysis</h1>
                <p class="lead mb-0">Coordinated AI specialist team for comprehensive code analysis</p>
                <div class="mt-3">
                    <span class="badge bg-light text-primary me-2">Security Expert</span>
                    <span class="badge bg-light text-primary me-2">Performance Specialist</span>
                    <span class="badge bg-light text-primary">Architecture Analyst</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Section -->
        <div class="col-lg-5">
            <EnhancedProjectSelector OnProjectAnalysisRequest="HandleEnhancedProjectAnalysis" />
        </div>

        <!-- Results Section -->
        @if (enhancedProjectResult != null)
        {
            <div class="col-12">
                <ProjectResults ProjectResult="enhancedProjectResult"
                                        OnFileDetailsRequested="ShowFileDetailsModal" />
            </div>
        }
        else if (teamResult != null)
        {
            <!-- Keep existing team result display for backward compatibility -->
            <div class="col-lg-7">
                <!-- Your existing team results display code -->
            </div>
        }

        <!-- File Details Modal -->
        @if (showFileDetailsModal && selectedFileDetails != null)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-file-earmark-code"></i> @selectedFileDetails.FileName
                            </h5>
                            <button type="button" class="btn-close" @onclick="CloseFileDetailsModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>File Size:</strong> @FormatFileSize(selectedFileDetails.FileSize)
                                </div>
                                <div class="col-md-6">
                                    <strong>Complexity Score:</strong>
                                    <span class="badge @GetComplexityBadgeClass(selectedFileDetails.ComplexityScore)">
                                        @selectedFileDetails.ComplexityScore
                                    </span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Analysis Status:</strong> @selectedFileDetails.Status
                                </div>
                                <div class="col-md-6">
                                    <strong>Static Analysis:</strong>
                                    @selectedFileDetails.StaticAnalysis.ClassCount classes,
                                    @selectedFileDetails.StaticAnalysis.MethodCount methods
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedFileDetails.AIInsight))
                            {
                                <div class="mt-3">
                                    <strong>AI Analysis Insights:</strong>
                                    <div class="p-3 bg-light rounded mt-2">
                                        @selectedFileDetails.AIInsight
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(selectedFileDetails.ErrorMessage))
                            {
                                <div class="mt-3">
                                    <div class="alert alert-warning">
                                        <strong>Analysis Note:</strong> @selectedFileDetails.ErrorMessage
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseFileDetailsModal">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .metric-box {
        padding: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        margin: 0.5rem 0;
    }

    .agent-result-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        background: #fafafa;
    }

    .discussion-message {
        border-left: 3px solid #007bff;
        padding-left: 1rem;
    }

    .executive-summary {
        line-height: 1.7;
        font-size: 15px;
    }

        .executive-summary h6 {
            color: #2c3e50;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .executive-summary p {
            margin-bottom: 1rem;
        }

    .executive-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 2rem;
        line-height: 1.8;
        font-size: 15px;
        border-left: 5px solid #007bff;
    }

        .executive-summary h6 {
            color: #2c3e50;
            margin: 1.5rem 0 0.8rem 0;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

            .executive-summary h6::before {
                content: "💼";
                margin-right: 0.5rem;
                font-size: 1.2em;
            }


    .agent-result-card {
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }

        .agent-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

    .analysis-progress {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0,123,255,0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .metrics-dashboard {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-radius: 12px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }

    .metric-box {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.2);
    }

        .metric-box h4 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

    .discussion-message {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }

        .discussion-message:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

    .recommendations-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .priority-section {
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        border-left: 4px solid;
    }

    .priority-high {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
    }

    .priority-medium {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
    }

    @@media (max-width: 768px) {
        .recommendations-grid {
            grid-template-columns: 1fr;
        }

        .metric-box h4 {
            font-size: 1.5rem;
        }

        .agent-result-card {
            padding: 1rem;
        }
    }

</style>

@code {
    private string selectedObjective = "comprehensive-audit";
    private string customObjective = "";
    private bool includeSecurityAgent = true;
    private bool includePerformanceAgent = true;
    private bool includeArchitectureAgent = true;
    private string codeInput = "";
    private bool isAnalyzing = false;
    private string statusMessage = "";
    private TeamAnalysisResult? teamResult;
    private ProjectAnalysisResult? enhancedProjectResult;
    private bool showFileDetailsModal = false;
    private FileAnalysisResult? selectedFileDetails;

    private int currentAnalysisPhase = 0;
    private readonly string[] analysisPhases = {
        "Planning team analysis approach",
        "Deploying specialist agents",
        "Executing parallel analysis",
        "Facilitating peer review discussions",
        "Synthesizing team recommendations",
        "Generating executive summary"
    };

    protected override void OnInitialized()
    {
        OnObjectiveChanged();
        statusMessage = "Multi-agent team ready! Select agents and provide code for comprehensive analysis.";
    }

    private void OnObjectiveChanged()
    {
        // Auto-configure agent team based on objective
        switch (selectedObjective)
        {
            case "security-compliance":
                includeSecurityAgent = true;
                includePerformanceAgent = false;
                includeArchitectureAgent = true;
                break;
            case "performance-optimization":
                includeSecurityAgent = false;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
            case "architecture-modernization":
                includeSecurityAgent = true;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
            case "comprehensive-audit":
                includeSecurityAgent = true;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
        }

        StateHasChanged();
    }

    private string GetCurrentAnalysisPhase()
    {
        if (currentAnalysisPhase < analysisPhases.Length)
            return analysisPhases[currentAnalysisPhase];
        return "Analysis Complete";
    }

    private int GetAnalysisProgress()
    {
        return (int)((double)currentAnalysisPhase / analysisPhases.Length * 100);
    }

    private void LoadTeamSampleCode()
    {
        codeInput = @"using System;
using System.Data.SqlClient;
using System.Security.Cryptography;
using System.Text;
using System.Collections.Generic;
using System.Linq;

namespace LegacyFinancialSystem
{
    // Poor separation of concerns - business logic mixed with data access
    public class AccountManager
    {
        private string connectionString = ""Server=localhost;Database=Finance;Trusted_Connection=true;"";

        // Security issue: Hardcoded admin credentials
        private const string ADMIN_PASSWORD = ""admin123"";

        // Performance issue: Synchronous operations
        public List<Account> GetUserAccounts(string userId)
        {
            var accounts = new List<Account>();

            // Security vulnerability: SQL injection possible
            string sql = ""SELECT * FROM Accounts WHERE UserId = '"" + userId + ""'"";

            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();
                var command = new SqlCommand(sql, connection);
                var reader = command.ExecuteReader();

                // Performance issue: Loading all data into memory
                while (reader.Read())
                {
                    accounts.Add(new Account
                    {
                        Id = (int)reader[""Id""],
                        Balance = (decimal)reader[""Balance""],
                        AccountType = reader[""AccountType""].ToString(),
                        // Security issue: Storing sensitive data in plain text
                        SocialSecurityNumber = reader[""SSN""].ToString()
                    });
                }
            }

            return accounts;
        }

        // Architecture violation: Mixed responsibilities
        public bool ProcessPayment(int fromAccountId, int toAccountId, decimal amount)
        {
            // Performance issue: Multiple database calls
            var fromAccount = GetAccountById(fromAccountId);
            var toAccount = GetAccountById(toAccountId);

            if (fromAccount.Balance < amount)
            {
                // Poor error handling: Silent failure
                return false;
            }

            // Security issue: No transaction isolation
            fromAccount.Balance -= amount;
            toAccount.Balance += amount;

            // Performance issue: Separate update calls
            UpdateAccount(fromAccount);
            UpdateAccount(toAccount);

            // Missing audit trail for financial transactions
            return true;
        }

        // Security issue: Weak password validation
        public bool ValidateUser(string username, string password)
        {
            if (password == ADMIN_PASSWORD)
                return true;

            // Performance issue: Inefficient string comparison
            var storedPassword = GetStoredPassword(username);
            return password.Equals(storedPassword);
        }

        // Architecture issue: Tight coupling to specific data access
        private Account GetAccountById(int accountId)
        {
            // Repeated connection code - violation of DRY principle
            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();
                var sql = ""SELECT * FROM Accounts WHERE Id = "" + accountId;
                var command = new SqlCommand(sql, connection);
                var reader = command.ExecuteReader();

                if (reader.Read())
                {
                    return new Account
                    {
                        Id = (int)reader[""Id""],
                        Balance = (decimal)reader[""Balance""],
                        AccountType = reader[""AccountType""].ToString()
                    };
                }
                return null;
            }
        }

        private void UpdateAccount(Account account)
        {
            // More duplicated connection code
            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();
                // Another SQL injection vulnerability
                var sql = $""UPDATE Accounts SET Balance = {account.Balance} WHERE Id = {account.Id}"";
                var command = new SqlCommand(sql, connection);
                command.ExecuteNonQuery();
            }
        }

        private string GetStoredPassword(string username)
        {
            // Security issue: Storing passwords in plain text
            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();
                var sql = ""SELECT Password FROM Users WHERE Username = '"" + username + ""'"";
                var command = new SqlCommand(sql, connection);
                return command.ExecuteScalar()?.ToString() ?? """";
            }
        }
    }

    public class Account
    {
        public int Id { get; set; }
        public decimal Balance { get; set; }
        public string AccountType { get; set; }
        public string SocialSecurityNumber { get; set; } // PII exposure
    }
}";

        selectedObjective = "comprehensive-audit";
        OnObjectiveChanged();
        statusMessage = "Complex financial system sample loaded - perfect for multi-agent team analysis!";
        StateHasChanged();
    }

    private async Task StartTeamAnalysis()
    {
        if (string.IsNullOrWhiteSpace(codeInput))
        {
            statusMessage = "Please enter code for team analysis.";
            return;
        }

        // Validate at least one agent is selected
        var selectedAgents = new List<string>();
        if (includeSecurityAgent) selectedAgents.Add("security");
        if (includePerformanceAgent) selectedAgents.Add("performance");
        if (includeArchitectureAgent) selectedAgents.Add("architecture");

        if (!selectedAgents.Any())
        {
            statusMessage = "Please select at least one specialist agent.";
            return;
        }

        isAnalyzing = true;
        currentAnalysisPhase = 0;

        try
        {
            var businessObjective = selectedObjective == "custom" ? customObjective : GetObjectiveDescription(selectedObjective);

            // Simulate progressive phases for demo
            for (int i = 0; i < analysisPhases.Length; i++)
            {
                currentAnalysisPhase = i;
                statusMessage = $"Phase {i + 1}: {analysisPhases[i]}...";
                StateHasChanged();

                // Realistic timing for each phase
                await Task.Delay(i switch
                {
                    0 => 1000,  // Planning
                    1 => 1500,  // Deployment
                    2 => 3000,  // Analysis (longest phase)
                    3 => 2000,  // Discussion
                    4 => 1500,  // Synthesis
                    5 => 1000   // Summary
                });
            }

            // Execute the actual team analysis
            teamResult = await OrchestrationService.CoordinateTeamAnalysisAsync(
                codeInput,
                businessObjective,
                selectedAgents);

            currentAnalysisPhase = analysisPhases.Length;
            statusMessage = $"✅ Team analysis complete! {teamResult.IndividualAnalyses.Count} agents collaborated with {teamResult.OverallConfidenceScore}% confidence.";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Team analysis failed: {ex.Message}";
            teamResult = null;
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private string GetObjectiveDescription(string objective)
    {
        return objective switch
        {
            "security-compliance" => "Comprehensive security assessment with focus on vulnerability identification and compliance requirements (SOX, GDPR, PCI-DSS)",
            "performance-optimization" => "Performance bottleneck analysis and scalability assessment for enterprise-grade optimization recommendations",
            "architecture-modernization" => "Architectural analysis and modernization planning with focus on SOLID principles, design patterns, and maintainability improvements",
            "comprehensive-audit" => "Complete code audit covering security, performance, and architectural aspects for holistic modernization planning",
            _ => "Custom business-focused code analysis and improvement recommendations"
        };
    }

    private string FormatExecutiveSummary(string summary)
    {
        if (string.IsNullOrEmpty(summary)) return "";

        // Basic formatting for executive consumption
        summary = summary.Replace("\n\n", "</p><p>");
        summary = summary.Replace("\n", "<br>");

        // Format headers
        summary = System.Text.RegularExpressions.Regex.Replace(
            summary,
            @"^(\d+\.\s*)([A-Z][^<\n]*?)(<br>|</p>)",
            "<h6 class='text-primary mb-2'>$1$2</h6>");

        // Format bullet points
        summary = summary.Replace("• ", "<i class='bi bi-arrow-right text-success me-2'></i>");
        summary = summary.Replace("- ", "<i class='bi bi-chevron-right text-info me-2'></i>");

        if (!summary.StartsWith("<p") && !summary.StartsWith("<h6"))
        {
            summary = $"<p>{summary}</p>";
        }

        return summary;
    }

    private string FormatImplementationStrategy(string strategy)
    {
        if (string.IsNullOrEmpty(strategy)) return "";

        // Format phases and sections
        strategy = strategy.Replace("Phase 1:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-1-circle'></i> Phase 1:</h6>");
        strategy = strategy.Replace("Phase 2:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-2-circle'></i> Phase 2:</h6>");
        strategy = strategy.Replace("Phase 3:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-3-circle'></i> Phase 3:</h6>");

        strategy = strategy.Replace("\n\n", "</p><p>");
        strategy = strategy.Replace("\n", "<br>");
        strategy = strategy.Replace("• ", "<i class='bi bi-check-circle text-success me-1'></i>");

        if (!strategy.StartsWith("<h6") && !strategy.StartsWith("<p"))
        {
            strategy = $"<p>{strategy}</p>";
        }

        return strategy;
    }

    private string GetAgentIcon(string agentName)
    {
        return agentName.ToLower() switch
        {
            var name when name.Contains("security") => "🛡️",
            var name when name.Contains("performance") => "⚡",
            var name when name.Contains("architectural") => "🏗️",
            _ => "🤖"
        };
    }

    private string GetConfidenceBadgeClass(int confidence)
    {
        return confidence switch
        {
            >= 90 => "bg-success",
            >= 75 => "bg-primary",
            >= 60 => "bg-warning text-dark",
            _ => "bg-danger"
        };
    }

    private string GetSeverityBadgeClass(string severity)
    {
        return severity?.ToUpper() switch
        {
            "CRITICAL" => "bg-danger",
            "HIGH" => "bg-warning text-dark",
            "MEDIUM" => "bg-info",
            "LOW" => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }

    private string GetMessageTypeBadgeClass(MessageType messageType)
    {
        return messageType switch
        {
            MessageType.Analysis => "bg-primary",
            MessageType.PeerReview => "bg-info",
            MessageType.Challenge => "bg-warning text-dark",
            MessageType.Agreement => "bg-success",
            MessageType.Synthesis => "bg-dark",
            _ => "bg-secondary"
        };
    }

    private string TruncateMessage(string message, int maxLength)
    {
        if (string.IsNullOrEmpty(message) || message.Length <= maxLength)
            return message;

        return message.Substring(0, maxLength) + "...";
    }

    private string GetEstimatedTimeline(decimal hours)
    {
        return hours switch
        {
            <= 40 => "1 week",
            <= 80 => "2 weeks",
            <= 160 => "1 month",
            <= 320 => "2 months",
            _ => "3+ months"
        };
    }

    

    // Update your HandleEnhancedProjectAnalysis method
    private async Task HandleEnhancedProjectAnalysis(ProjectAnalysisRequest request)
    {
        isAnalyzing = true;
        enhancedProjectResult = null; // Clear previous results
        teamResult = null; // Clear previous team results
        statusMessage = $"Starting enhanced analysis of {request.ProjectType}...";
        StateHasChanged();

        try
        {
            var progress = new Progress<ProjectAnalysisProgress>(p =>
            {
                statusMessage = $"{p.CurrentPhase}: {p.Status} ({p.ProgressPercentage:F0}%)";
                StateHasChanged();
            });

            enhancedProjectResult = await EnhancedProjectAnalysisService.AnalyzeProjectAsync(request, progress);

            statusMessage = $"✅ Enhanced project analysis complete! " +
                          $"{enhancedProjectResult.DetailedFileAnalysis.Count} files analyzed. " +
                          $"Project value: {enhancedProjectResult.BusinessImpact.EstimatedValue:C0}, " +
                          $"Risk level: {enhancedProjectResult.BusinessImpact.RiskLevel}";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Enhanced analysis failed: {ex.Message}";
            enhancedProjectResult = null;
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private void ShowFileDetailsModal(FileAnalysisResult file)
    {
        selectedFileDetails = file;
        showFileDetailsModal = true;
        StateHasChanged();
    }

    private void CloseFileDetailsModal()
    {
        showFileDetailsModal = false;
        selectedFileDetails = null;
        StateHasChanged();
    }

    // Add helper methods
    private string FormatFileSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:n1} {suffixes[counter]}";
    }

    private string GetComplexityBadgeClass(int complexity)
    {
        return complexity switch
        {
            >= 70 => "bg-danger",
            >= 40 => "bg-warning text-dark",
            _ => "bg-success"
        };
    }
}