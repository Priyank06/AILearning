@page "/multiagent"
@using PoC1_LegacyAnalyzer_Web.Models.AgentCommunication
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Models
@using PoC1_LegacyAnalyzer_Web.Services
@using PoC1_LegacyAnalyzer_Web.Components.Configuration
@using PoC1_LegacyAnalyzer_Web.Components.Analysis
@using PoC1_LegacyAnalyzer_Web.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IAgentOrchestrationService OrchestrationService
@inject ICodeAnalysisService CodeAnalysisService
@inject IFilePreProcessingService FilePreProcessingService
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment HostEnvironment
@inject IReportService ReportService
@inject IFileDownloadService FileDownloadService
@inject Microsoft.Extensions.Options.IOptions<PoC1_LegacyAnalyzer_Web.Models.FilePreProcessingOptions> PreProcessingOptions

<PageTitle>Multi-Agent Team Analysis</PageTitle>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="bg-gradient-primary text-white p-4 rounded shadow">
                <h1 class="display-4 mb-2">🤖 Multi-Agent Team Analysis</h1>
                <p class="lead mb-0">Coordinated AI specialist team for comprehensive code analysis</p>
                <div class="mt-3">
                    <BadgeWithIcon Text="Security Expert" Icon="🛡️" Color="light" />
                    <BadgeWithIcon Text="Performance Specialist" Icon="⚡" Color="light" />
                    <BadgeWithIcon Text="Architecture Analyst" Icon="🏗️" Color="light" />
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Section -->
        <div class="col-lg-5">
            <TeamConfigurationPanel @ref="configPanel"
                MaxFiles="50"
                MaxFileSizeMB="@(PreProcessingOptions.Value.MaxFileSizeMB)"
                OnAnalysisStarted="@HandleAnalysisStarted"
                OnPhaseChanged="@HandlePhaseChanged" />
        </div>

        <!-- Results Section -->
        @if (teamResult is not null)
        {
            <AnalysisResultsContainer 
                TeamResult="@teamResult"
                BusinessObjective="@lastBusinessObjective"
                CustomObjective="@lastCustomObjective"
                SelectedAgents="@lastSelectedAgents"
                ProjectSummary="@projectSummary"
                EstimatedInputTokens="@lastAiInputCharCount"
                IsAnalyzing="@isAnalyzing"
                OnDownloadReport="@DownloadTeamReport" />
        }
        else if (!isAnalyzing)
        {
            <div class="col-lg-7">
                <div class="card border-0 text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-robot" style="font-size: 4rem; color: #6c757d;"></i>
                        <h4 class="text-muted mt-3">Ready for Multi-Agent Analysis</h4>
                        <p class="text-muted">Configure your team and upload files to begin comprehensive AI-powered code analysis.</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private TeamConfigurationPanel? configPanel;
    private PoC1_LegacyAnalyzer_Web.Models.AgentCommunication.TeamAnalysisResult? teamResult;
    private PoC1_LegacyAnalyzer_Web.Services.ProjectSummary? projectSummary;
    private bool isAnalyzing = false;
    private int currentPhase = 0;
    private int lastAiInputCharCount = 0;
    
    // Store last analysis parameters for results display
    private string lastBusinessObjective = "";
    private string? lastCustomObjective;
    private List<string> lastSelectedAgents = new();

    private async Task HandleAnalysisStarted(AnalysisConfiguration config)
    {
        try
        {
            isAnalyzing = true;
            currentPhase = 0;
            
            // Store configuration for results display
            lastBusinessObjective = config.BusinessObjective;
            lastCustomObjective = config.CustomObjective;
            lastSelectedAgents = new List<string>(config.SelectedAgents);
            lastAiInputCharCount = config.Files.Sum(f => (int)f.Size);

            StateHasChanged();

            // Start the team analysis
            teamResult = await OrchestrationService.CoordinateTeamAnalysisAsync(
                config.Files,
                config.EffectiveObjective,
                config.SelectedAgents,
                new Progress<string>(msg => {
                    // Update progress through the config panel
                    configPanel?.UpdatePhase(++currentPhase);
                    StateHasChanged();
                }),
                CancellationToken.None);

            // Analysis completed successfully
            configPanel?.CompleteAnalysis();
        }
        catch (Exception ex)
        {
            // Handle error through config panel
            configPanel?.SetError($"Analysis failed: {ex.Message}");
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private async Task HandlePhaseChanged(int phase)
    {
        currentPhase = phase;
        StateHasChanged();
    }

    private async Task DownloadTeamReport()
    {
        if (teamResult is null) return;

        try
        {
            var content = GenerateTeamReport();
            var bytes = System.Text.Encoding.UTF8.GetBytes(content);
            var fileName = $"team-analysis-{DateTime.Now:yyyyMMdd-HHmmss}.md";
            await FileDownloadService.DownloadFileAsync(fileName, bytes, "text/markdown");
        }
        catch (Exception ex)
        {
            // Could add error handling/notification here
            Console.WriteLine($"Failed to download report: {ex.Message}");
        }
    }

    private string GenerateTeamReport()
    {
        if (teamResult is null) return "";

        var sb = new System.Text.StringBuilder();
        var objectiveText = !string.IsNullOrWhiteSpace(lastCustomObjective) 
            ? lastCustomObjective 
            : lastBusinessObjective;

        sb.AppendLine("# Multi-Agent Team Analysis Report");
        sb.AppendLine($"**Objective:** {objectiveText}");
        sb.AppendLine($"**Agents:** {string.Join(", ", lastSelectedAgents)}");
        sb.AppendLine($"**Completed:** {DateTime.Now:yyyy-MM-dd HH:mm}");
        sb.AppendLine();

        if (projectSummary is not null)
        {
            sb.AppendLine("## Project Summary");
            sb.AppendLine($"- Files: {projectSummary.TotalFiles}");
            sb.AppendLine($"- Classes: {projectSummary.TotalClasses}");
            sb.AppendLine($"- Methods: {projectSummary.TotalMethods}");
            sb.AppendLine($"- Properties: {projectSummary.TotalProperties}");
            sb.AppendLine($"- Risk Level: {projectSummary.RiskLevel}");
            sb.AppendLine($"- Complexity Score: {projectSummary.ComplexityScore}");
            sb.AppendLine();
        }

        if (!string.IsNullOrWhiteSpace(teamResult.ExecutiveSummary))
        {
            sb.AppendLine("## Executive Summary");
            sb.AppendLine(teamResult.ExecutiveSummary);
            sb.AppendLine();
        }

        sb.AppendLine("## Team Metrics");
        sb.AppendLine($"- Specialist Agents: {teamResult.IndividualAnalyses?.Count ?? 0}");
        sb.AppendLine($"- Collaboration Messages: {teamResult.TeamDiscussion?.Count ?? 0}");
        sb.AppendLine($"- Team Consensus: {teamResult.Consensus?.AgreementPercentage ?? 0:F0}%");
        sb.AppendLine($"- Overall Confidence: {teamResult.OverallConfidenceScore}%");
        sb.AppendLine();

        if (teamResult.FinalRecommendations is not null)
        {
            sb.AppendLine("## Recommendations Summary");
            sb.AppendLine($"- High Priority: {teamResult.FinalRecommendations.HighPriorityActions?.Count ?? 0}");
            sb.AppendLine($"- Medium Priority: {teamResult.FinalRecommendations.MediumPriorityActions?.Count ?? 0}");
            sb.AppendLine($"- Long-term Strategic: {teamResult.FinalRecommendations.LongTermStrategic?.Count ?? 0}");
            sb.AppendLine($"- Total Estimated Effort: {teamResult.FinalRecommendations.TotalEstimatedEffort} hours");
            sb.AppendLine();
        }

        return sb.ToString();
    }
}

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
</style>