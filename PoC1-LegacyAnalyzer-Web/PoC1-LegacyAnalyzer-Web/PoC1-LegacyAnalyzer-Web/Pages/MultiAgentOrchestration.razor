@page "/multiagent"
@using PoC1_LegacyAnalyzer_Web.Models.AgentCommunication
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Models
@using PoC1_LegacyAnalyzer_Web.Services
@using PoC1_LegacyAnalyzer_Web.Components.Configuration
@using PoC1_LegacyAnalyzer_Web.Components.Analysis
@using PoC1_LegacyAnalyzer_Web.Components.Shared
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject IServiceProvider ServiceProvider
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using PoC1_LegacyAnalyzer_Web.Services.Infrastructure
@using PoC1_LegacyAnalyzer_Web.Services.Reporting
@using PoC1_LegacyAnalyzer_Web.Services.Persistence
@using PoC1_LegacyAnalyzer_Web.Services.MultiAgent
@inject IAgentOrchestrationService OrchestrationService
@inject IBrowserStorageService BrowserStorageService
@inject ILastTeamResultStore LastResultStore
@inject ICodeAnalysisService CodeAnalysisService
@inject IFilePreProcessingService FilePreProcessingService
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment HostEnvironment
@inject IReportService ReportService
@inject IFileDownloadService FileDownloadService
@inject ITeamReportService TeamReportService
@inject Microsoft.Extensions.Options.IOptions<PoC1_LegacyAnalyzer_Web.Models.FilePreProcessingOptions> PreProcessingOptions
@implements IDisposable

<PageTitle>Multi-Agent Team Analysis</PageTitle>

<div class="container-fluid multiagent-single-column">
    <!-- Header Section -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="bg-light border-bottom border-2 p-2">
                <h2 class="h4 mb-1"><i class="bi bi-robot"></i> Multi-Agent Team Analysis</h2>
            </div>
        </div>
    </div>

    <!-- Recent agent analyses (browser storage) -->
    @if (agentStorageAvailable && recentAgentSessions.Any())
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-clock-history"></i> Recent agent analyses</span>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="LoadRecentAgentSessions">Refresh</button>
                    </div>
                    <div class="card-body py-2">
                        <ul class="list-group list-group-flush">
                            @foreach (var s in recentAgentSessions.Take(10))
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                    <span>@(s.UserFriendlyName ?? s.CreatedAt.ToString("g")) â€” @s.BusinessObjective, @s.SelectedAgents.Count agents</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" @onclick="() => LoadAgentSession(s.Id)">Load</button>
                                        <button class="btn btn-outline-danger" @onclick="() => DeleteAgentSession(s.Id)" title="Remove from history">Delete</button>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Single-column content layout -->
    <div class="row gy-4">
        <!-- Configuration Section (full width) -->
        <div class="col-12">
            <TeamConfigurationPanel @ref="configPanel"
                IsAnalyzingFromParent="@isAnalyzing"
                MaxFiles="10000"
                MaxFileSizeMB="10"
                OnAnalysisStarted="HandleAnalysisStarted"
                OnPhaseChanged="HandlePhaseChanged" />
        </div>

        <!-- Fallback: if analysis completed but UI didn't update (e.g. circuit dropped), user can load results from server -->
        @if (isAnalyzing)
        {
            <div class="col-12">
                <div class="alert alert-warning py-2 mb-0">
                    <small><i class="bi bi-exclamation-triangle"></i> If analysis completed but results didn't appear, <a href="#" @onclick="TryLoadLastCompletedResult" @onclick:preventDefault>click here to load results</a>.</small>
                </div>
            </div>
        }

        <!-- Results Section with right sidebar -->
        @if (teamResult is not null)
        {
            <div id="multiagent-results" class="col-12">
                @if (showFullResults)
                {
                    <div class="row">
                        <!-- Main Content -->
                        <div class="col-12 col-xl-9">
                            <AnalysisResultsContainer 
                                TeamResult="@teamResult"
                                BusinessObjective="@lastBusinessObjective"
                                CustomObjective="@lastCustomObjective"
                                SelectedAgents="@lastSelectedAgents"
                                ProjectSummary="@projectSummary"
                                EstimatedInputTokens="@lastAiInputCharCount"
                                IsAnalyzing="@isAnalyzing"
                                OnDownloadReport="@DownloadTeamReport" />
                        </div>
                        <!-- Right Sidebar (desktop) -->
                        <div class="col-xl-3 d-none d-xl-block position-relative quick-nav-desktop">
                            <QuickNavigationSidebar 
                                TeamResult="@teamResult"
                                OnDownloadReport="@DownloadTeamReport" />
                        </div>
                    </div>

                    <!-- Mobile Navigation Toggle (only visible on small screens) -->
                    <div class="d-xl-none position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
                        <button class="btn btn-primary rounded-circle shadow-lg" 
                                style="width: 56px; height: 56px;"
                                @onclick="ToggleMobileNav">
                            <i class="bi bi-list" style="font-size: 1.5rem;"></i>
                        </button>
                    </div>

                    <!-- Mobile Navigation Panel -->
                    <div class="mobile-nav-overlay @(showMobileNav ? "show" : "")" @onclick="ToggleMobileNav"></div>
                    <div class="mobile-nav-panel @(showMobileNav ? "show" : "")">
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <h6 class="mb-0">Quick Navigation</h6>
                            <button class="btn-close" @onclick="ToggleMobileNav"></button>
                        </div>
                        <div class="p-2">
                            <QuickNavigationSidebar 
                                TeamResult="@teamResult"
                                OnDownloadReport="@DownloadTeamReport"
                                OnNavigate="@(() => showMobileNav = false)" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-success mb-0">
                        <h5 class="alert-heading"><i class="bi bi-check-circle"></i> Analysis complete</h5>
                        <p class="mb-0">Loading results...</p>
                    </div>
                }
            </div>
        }
        else if (!isAnalyzing)
        {
            <div class="col-12">
                <div class="card border-0 text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-robot" style="font-size: 4rem; color: #6c757d;"></i>
                        <h4 class="text-muted mt-3">Ready for Multi-Agent Analysis</h4>
                        <p class="text-muted">Configure your team and upload files to begin comprehensive AI-powered code analysis.</p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private TeamConfigurationPanel? configPanel;
    private PoC1_LegacyAnalyzer_Web.Models.AgentCommunication.TeamAnalysisResult? teamResult;
    private PoC1_LegacyAnalyzer_Web.Services.ProjectSummary? projectSummary;
    private bool isAnalyzing = false;
    private bool showFullResults = false;
    private int currentPhase = 0;
    private int lastAiInputCharCount = 0;
    private bool showMobileNav = false;
    private AnalysisProgress? agentProgress = null;
    
    // Store last analysis parameters for results display
    private string lastBusinessObjective = "";
    private string? lastCustomObjective;
    private List<string> lastSelectedAgents = new();

    // Browser persistence for agent sessions
    private bool agentStorageAvailable;
    private IReadOnlyList<SavedAgentSession> recentAgentSessions = Array.Empty<SavedAgentSession>();

    protected override void OnInitialized()
    {
        // Temporary debug: try to bind AgentAnalysisConfiguration and log detailed errors if it fails.
        try
        {
            var agentAnalysisConfig = Configuration.GetSection("AgentAnalysisConfiguration").Get<PoC1_LegacyAnalyzer_Web.Models.AgentAnalysisConfiguration>();
            Console.WriteLine("AgentAnalysisConfiguration bound successfully.");
        }
        catch (Exception ex)
        {
            Console.WriteLine("AgentAnalysisConfiguration binding FAILED:");
            Console.WriteLine(ex.ToString());
        }

        base.OnInitialized();
    }

    protected override async Task OnInitializedAsync()
    {
        // Do not call LoadRecentAgentSessions here: it uses JS interop (browser storage).
        // During ServerPrerendered, JS is not available and can disconnect the circuit.
        // Load after first client render in OnAfterRenderAsync.
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadRecentAgentSessions();
        }
    }

    private async Task HandleAnalysisStarted(AnalysisConfiguration config)
    {
        Console.WriteLine($"[MultiAgentOrchestration] HandleAnalysisStarted called with {config.Files.Count} files, {config.SelectedAgents.Count} agents");
        Console.WriteLine($"[MultiAgentOrchestration] BusinessObjective: {config.BusinessObjective}, EffectiveObjective: {config.EffectiveObjective}");
        
        try
        {
            Console.WriteLine("[MultiAgentOrchestration] Resolving IAgentOrchestrationService from ServiceProvider...");
            var orchestrator = ServiceProvider.GetRequiredService<IAgentOrchestrationService>();
            Console.WriteLine("[MultiAgentOrchestration] Orchestrator resolved successfully.");

            isAnalyzing = true;
            currentPhase = 0;
            StartPollingForCompletedResult();

            // Store configuration for results display
            lastBusinessObjective = config.BusinessObjective;
            lastCustomObjective = config.CustomObjective;
            lastSelectedAgents = new List<string>(config.SelectedAgents);
            lastAiInputCharCount = config.Files.Sum(f => (int)f.Size);

            Console.WriteLine($"[MultiAgentOrchestration] State updated, calling StateHasChanged()");
            StateHasChanged();

            Console.WriteLine($"[MultiAgentOrchestration] Calling orchestrator.CoordinateTeamAnalysisAsync...");
            
            // Start the team analysis with both simple and detailed progress tracking
            teamResult = await orchestrator.CoordinateTeamAnalysisAsync(
                config.Files,
                config.EffectiveObjective,
                config.SelectedAgents,
                new Progress<string>(msg => {
                    Console.WriteLine($"[MultiAgentOrchestration] Progress update: {msg}");
                    // Update progress through the config panel
                    configPanel?.UpdatePhase(++currentPhase);
                    StateHasChanged();
                }),
                new Progress<AnalysisProgress>(progress => {
                    Console.WriteLine($"[MultiAgentOrchestration] Detailed progress: {progress.ProgressPercentage}%, Status: {progress.Status}");
                    // Update detailed per-agent progress
                    agentProgress = progress;
                    InvokeAsync(StateHasChanged);
                }),
                CancellationToken.None);

            Console.WriteLine($"[MultiAgentOrchestration] Analysis completed successfully. Results: {teamResult?.IndividualAnalyses?.Count ?? 0} analyses");

            // Save agent session to browser storage when available
            if (teamResult != null && agentStorageAvailable)
            {
                try
                {
                    await BrowserStorageService.SaveAgentSessionAsync(teamResult, lastBusinessObjective, lastCustomObjective, lastSelectedAgents, userFriendlyName: null);
                    await LoadRecentAgentSessions();
                }
                catch { /* ignore persistence errors */ }
            }

            // Store in scoped result store so "Load results" fallback and timer can pick it up if the UI push is missed
            if (teamResult != null)
                LastResultStore.SetLastResult(teamResult, lastBusinessObjective ?? "", lastCustomObjective, lastSelectedAgents ?? new List<string>());

            // Phase 1: Stop analyzing and show small "Analysis complete - Loading results..." so first render batch is small (fixes UI not updating after long async)
            isAnalyzing = false;
            showFullResults = false;
            _pollTimer?.Dispose();
            _pollTimer = null;
            configPanel?.CompleteAnalysis();
            await InvokeAsync(StateHasChanged);

            // Phase 2: After a short delay, show full results (second render batch)
            await Task.Delay(200);
            showFullResults = true;
            await InvokeAsync(StateHasChanged);
            await Task.Delay(100);
            try { await JSRuntime.InvokeVoidAsync("scrollToElement", "multiagent-results"); } catch { /* ignore */ }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MultiAgentOrchestration] ERROR in HandleAnalysisStarted: {ex.GetType().Name}: {ex.Message}");
            Console.WriteLine($"[MultiAgentOrchestration] Stack trace: {ex.StackTrace}");
            
            // Handle error through config panel
            configPanel?.SetError($"Analysis failed: {ex.Message}");
        }
        finally
        {
            isAnalyzing = false;
            _pollTimer?.Dispose();
            _pollTimer = null;
            Console.WriteLine($"[MultiAgentOrchestration] Finally block: isAnalyzing = false");
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandlePhaseChanged(int phase)
    {
        currentPhase = phase;
        StateHasChanged();
    }

    private void ToggleMobileNav()
    {
        showMobileNav = !showMobileNav;
    }

    private async Task DownloadTeamReport()
    {
        if (teamResult is null) return;

        try
        {
            var content = TeamReportService.GenerateTeamReport(
                teamResult,
                projectSummary,
                lastBusinessObjective,
                lastCustomObjective,
                lastSelectedAgents);
            var bytes = System.Text.Encoding.UTF8.GetBytes(content);
            var fileName = $"team-analysis-{DateTime.Now:yyyyMMdd-HHmmss}.md";
            await FileDownloadService.DownloadFileAsync(fileName, bytes, "text/markdown");
        }
        catch (Exception ex)
        {
            // Could add error handling/notification here
            Console.WriteLine($"Failed to download report: {ex.Message}");
        }
    }

    private async Task LoadRecentAgentSessions()
    {
        try
        {
            agentStorageAvailable = await BrowserStorageService.IsAvailableAsync();
            if (agentStorageAvailable)
            {
                await BrowserStorageService.PurgeExpiredSessionsAsync();
                recentAgentSessions = await BrowserStorageService.GetRecentAgentSessionsAsync(20);
            }
        }
        catch
        {
            agentStorageAvailable = false;
            recentAgentSessions = Array.Empty<SavedAgentSession>();
        }
        StateHasChanged();
    }

    private async Task DeleteAgentSession(string sessionId)
    {
        try
        {
            await BrowserStorageService.DeleteAgentSessionAsync(sessionId);
            await LoadRecentAgentSessions();
        }
        catch { /* ignore */ }
    }

    private async Task LoadAgentSession(string sessionId)
    {
        try
        {
            var session = await BrowserStorageService.GetAgentSessionByIdAsync(sessionId);
            if (session != null)
            {
                teamResult = session.TeamResult;
                showFullResults = true;
                lastBusinessObjective = session.BusinessObjective;
                lastCustomObjective = session.CustomObjective;
                lastSelectedAgents = session.SelectedAgents?.ToList() ?? new List<string>();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load agent session: {ex.Message}");
        }
    }

    private System.Threading.Timer? _pollTimer;

    private void StartPollingForCompletedResult()
    {
        _pollTimer?.Dispose();
        _pollTimer = new System.Threading.Timer(_ =>
        {
            _ = InvokeAsync(() =>
            {
                if (!isAnalyzing || teamResult != null) return;
                var entry = LastResultStore.TryGetLastResult();
                if (entry != null)
                {
                    teamResult = entry.Result;
                    lastBusinessObjective = entry.BusinessObjective;
                    lastCustomObjective = entry.CustomObjective;
                    lastSelectedAgents = entry.SelectedAgents?.ToList() ?? new List<string>();
                    showFullResults = true;
                    isAnalyzing = false;
                    configPanel?.CompleteAnalysis();
                    _pollTimer?.Dispose();
                    _pollTimer = null;
                    StateHasChanged();
                }
            });
        }, null, 3000, 3000);
    }

    private void TryLoadLastCompletedResult()
    {
        var entry = LastResultStore.TryGetLastResult();
        if (entry != null)
        {
            teamResult = entry.Result;
            lastBusinessObjective = entry.BusinessObjective;
            lastCustomObjective = entry.CustomObjective;
            lastSelectedAgents = entry.SelectedAgents?.ToList() ?? new List<string>();
            showFullResults = true;
            isAnalyzing = false;
            configPanel?.CompleteAnalysis();
            _pollTimer?.Dispose();
            _pollTimer = null;
            StateHasChanged();
        }
    }

    public void Dispose() => _pollTimer?.Dispose();

}

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    /* Constrain page content - accounts for left sidebar (220px) and right sidebar (280px) */
    .multiagent-single-column {
        max-width: 1600px;
        margin: 0 auto;
    }
</style>