@page "/multiagent"
@using PoC1_LegacyAnalyzer_Web.Models.AgentCommunication
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Text
@inject IAgentOrchestrationService OrchestrationService
@inject ICodeAnalysisService CodeAnalysisService
@inject IFilePreProcessingService PreProcessingService
@inject ILogger<MultiAgentOrchestration> Logger

<PageTitle>Multi-Agent Team Analysis</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="bg-gradient-primary text-white p-4 rounded shadow">
                <h1 class="display-4 mb-2">🤖 Multi-Agent Team Analysis</h1>
                <p class="lead mb-0">Coordinated AI specialist team for comprehensive legacy code analysis</p>
                <div class="mt-3">
                    <span class="badge bg-light text-primary me-2">🔒 Security Expert</span>
                    <span class="badge bg-light text-primary me-2">⚡ Performance Specialist</span>
                    <span class="badge bg-light text-primary">🏗️ Architecture Analyst</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Section -->
        <div class="col-lg-5">
            <div class="card shadow border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Team Configuration</h5>
                </div>
                <div class="card-body">
                    <!-- Business Objective -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Business Objective:</label>
                        <select class="form-select" @bind="selectedObjective" @bind:after="OnObjectiveChanged">
                            <option value="security-compliance">🔒 Security Compliance Assessment</option>
                            <option value="performance-optimization">⚡ Performance Optimization Analysis</option>
                            <option value="architecture-modernization">🏗️ Architecture Modernization Planning</option>
                            <option value="comprehensive-audit">📊 Comprehensive Code Audit</option>
                            <option value="custom">✏️ Custom Objective</option>
                        </select>
                    </div>

                    @if (selectedObjective == "custom")
                    {
                        <div class="mb-3">
                            <label class="form-label">Custom Business Objective:</label>
                            <textarea class="form-control" rows="2" @bind="customObjective"
                                      placeholder="Describe your specific business objective..."></textarea>
                        </div>
                    }

                    <!-- Agent Team Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">AI Agent Team:</label>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="includeSecurityAgent" id="securityAgent">
                                    <label class="form-check-label" for="securityAgent">
                                        <strong>🔒 Security Analyst</strong><br>
                                        <small class="text-muted">Vulnerability assessment, compliance analysis</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 mt-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="includePerformanceAgent" id="performanceAgent">
                                    <label class="form-check-label" for="performanceAgent">
                                        <strong>⚡ Performance Analyst</strong><br>
                                        <small class="text-muted">Bottleneck identification, scalability assessment</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 mt-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="includeArchitectureAgent" id="architectureAgent">
                                    <label class="form-check-label" for="architectureAgent">
                                        <strong>🏗️ Architecture Analyst</strong><br>
                                        <small class="text-muted">Design patterns, SOLID principles, code structure</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <!-- File Upload Section - OPTIMIZED FOR AI COST -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">📁 Legacy Code Files:</label>

                        <!-- Cost Optimization Info Banner -->
                        <div class="alert alert-info py-2 mb-2">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>Smart Analysis:</strong> Files are pre-processed locally to reduce AI costs by 75%+
                            </small>
                        </div>

                        <div class="upload-area @(isDragging ? "drag-over" : "")"
                             @ondragover="HandleDragOver"
                             @ondragover:preventDefault="true"
                             @ondragleave="HandleDragLeave"
                             @ondrop="HandleFileDrop"
                             @ondrop:preventDefault="true">
                            <div class="text-center p-3">
                                <div style="font-size: 2.5rem;" class="text-muted mb-2">
                                    <i class="bi bi-folder2-open"></i>
                                </div>
                                <h6>Upload C# Legacy Code</h6>
                                <p class="text-muted small mb-3">
                                    Select files from your project for AI-powered analysis
                                </p>

                                <!-- Folder Selection (Recommended) -->
                                <InputFile id="folderInput"
                                           OnChange="HandleFileSelection"
                                           multiple
                                           accept=".cs"
                                           class="d-none"
                                           webkitdirectory />
                                <label for="folderInput" class="btn btn-primary btn-sm me-2">
                                    <i class="bi bi-folder-plus"></i> Select Project Folder
                                </label>

                                <!-- Individual File Selection -->
                                <InputFile id="individualFiles"
                                           OnChange="HandleIndividualFileSelection"
                                           multiple
                                           accept=".cs"
                                           class="d-none" />
                                <label for="individualFiles" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-file-plus"></i> Select Individual Files
                                </label>

                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Folder:</strong> Auto-finds all .cs files |
                                        <strong>Individual:</strong> Select specific files
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Files Display -->
                    @if (selectedFiles.Any())
                    {
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">📄 Selected Files (@selectedFiles.Count):</h6>
                                @if (!isPreProcessing && !isAnalyzing)
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="ClearFiles">
                                        <i class="bi bi-trash"></i> Clear All
                                    </button>
                                }
                            </div>

                            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px;">
                                @foreach (var file in selectedFiles)
                                {
                                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                                        <div class="flex-grow-1">
                                            <i class="bi bi-file-earmark-code text-primary"></i>
                                            <span class="small">@file.Name</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            @if (processedMetadata.Any(m => m.FileName == file.Name))
                                            {
                                                <span class="badge bg-success me-2">✓ Analyzed</span>
                                            }
                                            <small class="text-muted me-2">@FormatFileSize(file.Size)</small>
                                            @if (!isPreProcessing && !isAnalyzing)
                                            {
                                                <button class="btn btn-sm btn-outline-danger"
                                                        @onclick="@(() => RemoveFile(file))">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Pre-Processing Stats -->
                            @if (projectSummary != null && !isAnalyzing)
                            {
                                <div class="card mt-2 bg-light">
                                    <div class="card-body py-2">
                                        <div class="row small">
                                            <div class="col-6">
                                                <strong>📊 LOC:</strong> @projectSummary.TotalLines.ToString("N0")
                                            </div>
                                            <div class="col-6">
                                                <strong>🏗️ Classes:</strong> @projectSummary.TotalClasses
                                            </div>
                                            <div class="col-6 mt-1">
                                                <strong>⚙️ Methods:</strong> @projectSummary.TotalMethods
                                            </div>
                                            <div class="col-6 mt-1">
                                                <strong>📈 Complexity:</strong>
                                                <span class="badge @GetComplexityBadgeClass(projectSummary.OverallComplexity)">
                                                    @projectSummary.OverallComplexity
                                                </span>
                                            </div>
                                        </div>
                                        @if (projectSummary.PreIdentifiedIssues.Any())
                                        {
                                            <div class="mt-2 pt-2 border-top">
                                                <small>
                                                    <strong>⚠️ Pre-Identified Issues:</strong>
                                                    @projectSummary.PreIdentifiedIssues.Count
                                                    (@projectSummary.PreIdentifiedIssues.Count(i => i.Severity == "Critical" || i.Severity == "High") critical/high)
                                                </small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="mb-3">
                            @if (projectSummary == null && !isPreProcessing)
                            {
                                <button class="btn btn-info w-100" @onclick="PreProcessFiles">
                                    <i class="bi bi-cpu"></i> Pre-Process Files (Local Analysis)
                                </button>
                                <small class="text-muted d-block mt-1">
                                    No AI cost - Static analysis only
                                </small>
                            }
                            else if (projectSummary != null && !isAnalyzing)
                            {
                                <button class="btn btn-success w-100 mb-2"
                                        @onclick="StartTeamAnalysis"
                                        disabled="@(GetSelectedAgentCount() <= 0)">
                                    <i class="bi bi-people"></i> Start AI Team Analysis
                                </button>
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>💰 Estimated tokens: ~@EstimateTokenUsage()</span>
                                    <span>⚡ ~@EstimateTime() sec</span>
                                </div>
                            }

                            @if (isPreProcessing)
                            {
                                <div class="text-center">
                                    <div class="spinner-border text-primary me-2" role="status"></div>
                                    <span>Pre-processing files... @preProcessingProgress/@selectedFiles.Count</span>
                                </div>
                            }
                        </div>
                    }

                    <!-- Team Analysis Progress -->
                    @if (isAnalyzing)
                    {
                        <div class="analysis-progress">
                            <div class="text-center mb-3">
                                <h5 class="text-primary mb-2">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Multi-Agent Collaboration in Progress
                                </h5>
                                <p class="text-muted small mb-3">AI specialists analyzing @selectedFiles.Count files</p>
                            </div>

                            <div class="progress mb-3" style="height: 12px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                     style="width: @GetAnalysisProgress()%"></div>
                            </div>

                            <div class="row text-center small">
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        @if (currentAnalysisPhase >= 2)
                                        {
                                            <span class="text-success">✅</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">⏳</span>
                                        }
                                        <strong>Analysis</strong>
                                    </div>
                                    <small class="text-muted">Agents analyzing</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        @if (currentAnalysisPhase >= 4)
                                        {
                                            <span class="text-success">✅</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">⏳</span>
                                        }
                                        <strong>Collaboration</strong>
                                    </div>
                                    <small class="text-muted">Peer review</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        @if (currentAnalysisPhase >= 6)
                                        {
                                            <span class="text-success">✅</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">⏳</span>
                                        }
                                        <strong>Synthesis</strong>
                                    </div>
                                    <small class="text-muted">Final recommendations</small>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <strong class="text-primary">Current: @GetCurrentAnalysisPhase()</strong>
                            </div>
                        </div>
                    }

                    <!-- Status Messages -->
                    @if (!string.IsNullOrEmpty(statusMessage) && !isAnalyzing && !isPreProcessing)
                    {
                        <div class="alert @GetStatusAlertClass() py-2">
                            <small><i class="bi @GetStatusIcon()"></i> @statusMessage</small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Results Section -->
        @if (teamResult != null)
        {
            <div class="col-lg-7">
                <!-- Team Performance Dashboard -->
                <div class="metrics-dashboard">
                    <div class="text-center mb-4">
                        <h4 class="mb-2">✅ Multi-Agent Analysis Complete</h4>
                        <p class="mb-0 text-muted">AI specialist team collaboration results for @selectedFiles.Count files</p>
                    </div>

                    <div class="row">
                        <div class="col-md-3 col-6">
                            <div class="metric-box">
                                <div class="mb-2">📁</div>
                                <h4>@selectedFiles.Count</h4>
                                <small>Files Analyzed</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-box">
                                <div class="mb-2">🤖</div>
                                <h4>@teamResult.IndividualAnalyses.Count</h4>
                                <small>Specialist Agents</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-box">
                                <div class="mb-2">💬</div>
                                <h4>@teamResult.TeamDiscussion.Count</h4>
                                <small>Collaboration Messages</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="metric-box">
                                <div class="mb-2">🎯</div>
                                <h4>@teamResult.FinalRecommendations.HighPriorityActions.Count</h4>
                                <small>Priority Actions</small>
                            </div>
                        </div>
                    </div>

                    <!-- Executive Summary -->
                    <div class="card shadow mb-3 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-file-text"></i> Executive Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="executive-summary">
                                @((MarkupString)FormatExecutiveSummary(teamResult.ExecutiveSummary))
                            </div>
                        </div>
                    </div>

                    <!-- Individual Agent Results -->
                    <div class="card shadow mb-3">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0"><i class="bi bi-person-badge"></i> Individual Agent Analysis</h5>
                        </div>
                        <div class="card-body">
                            @foreach (var analysis in teamResult.IndividualAnalyses.OrderByDescending(a => a.ConfidenceScore))
                            {
                                <div class="agent-result-card mb-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h6 class="text-primary mb-1">
                                                @GetAgentIcon(analysis.AgentName) @analysis.AgentName
                                            </h6>
                                            <small class="text-muted">@analysis.Specialty</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge @GetConfidenceBadgeClass(analysis.ConfidenceScore) fs-6">
                                                @analysis.ConfidenceScore% Confidence
                                            </span>
                                            <br>
                                            <small class="text-muted">@analysis.Priority Priority</small>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Key Findings (@analysis.KeyFindings.Count):</strong>
                                            <ul class="list-unstyled mt-2">
                                                @foreach (var finding in analysis.KeyFindings.Take(3))
                                                {
                                                    <li class="mb-1">
                                                        <span class="badge @GetSeverityBadgeClass(finding.Severity) me-2">@finding.Severity</span>
                                                        @finding.Category
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Recommendations (@analysis.Recommendations.Count):</strong>
                                            <ul class="list-unstyled mt-2">
                                                @foreach (var rec in analysis.Recommendations.Take(2))
                                                {
                                                    <li class="mb-1">
                                                        <strong>@rec.Title</strong><br>
                                                        <small class="text-muted">Effort: @rec.EstimatedHours hours</small>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(analysis.BusinessImpact))
                                    {
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <strong>Business Impact:</strong><br>
                                            <small>@analysis.BusinessImpact</small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Team Discussion -->
                    @if (teamResult?.TeamDiscussion != null && teamResult.TeamDiscussion.Any())
                    {
                        <div class="card shadow mb-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Agent Team Discussion</h5>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                @foreach (var message in teamResult.TeamDiscussion.OrderBy(m => m.Timestamp))
                                {
                                    <div class="discussion-message mb-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <strong class="text-primary">@message.FromAgent</strong>
                                            <small class="text-muted">@message.Timestamp.ToString("HH:mm:ss")</small>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge @GetMessageTypeBadgeClass(message.Type) me-2">
                                                @message.Type
                                            </span>
                                            @message.Subject
                                        </div>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <small>@TruncateMessage(message.Content, 200)</small>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Consolidated Recommendations -->
                    @if (teamResult?.FinalRecommendations != null)
                    {
                        <div class="mb-2 p-2 bg-light border rounded">
                            <b>Debug:</b>
                            HighPriorityActions: @(teamResult.FinalRecommendations.HighPriorityActions == null ? "null" : teamResult.FinalRecommendations.HighPriorityActions.Count.ToString())<br />
                            MediumPriorityActions: @(teamResult.FinalRecommendations.MediumPriorityActions == null ? "null" : teamResult.FinalRecommendations.MediumPriorityActions.Count.ToString())
                        </div>
                        <div class="card shadow">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-list-check"></i> Team Recommendations</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-danger">🚨 High Priority (@(teamResult.FinalRecommendations.HighPriorityActions?.Count ?? 0))</h6>
                                        <ul class="list-unstyled">
                                            @foreach (var rec in (teamResult.FinalRecommendations.HighPriorityActions ?? Enumerable.Empty<Recommendation>()).Take(5))
                                            {
                                                <li class="mb-2">
                                                    <strong>@rec.Title</strong><br>
                                                    <small class="text-muted">@rec.EstimatedHours hours - @rec.Priority priority</small>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-warning">⚡ Medium Priority (@(teamResult.FinalRecommendations.MediumPriorityActions?.Count ?? 0))</h6>
                                        <ul class="list-unstyled">
                                            @foreach (var rec in (teamResult.FinalRecommendations.MediumPriorityActions ?? Enumerable.Empty<Recommendation>()).Take(3))
                                            {
                                                <li class="mb-2">
                                                    <strong>@rec.Title</strong><br>
                                                    <small class="text-muted">@rec.EstimatedHours hours</small>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>

                                <div class="mt-4 p-3 bg-primary text-white rounded">
                                    <h6 class="mb-2"><i class="bi bi-clock"></i> Implementation Summary</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Total Effort:</strong><br>
                                            @(teamResult.FinalRecommendations.TotalEstimatedEffort) hours
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Estimated Cost:</strong><br>
                                            @((teamResult.FinalRecommendations.TotalEstimatedEffort * 125).ToString("C0"))
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Timeline:</strong><br>
                                            @GetEstimatedTimeline(teamResult.FinalRecommendations.TotalEstimatedEffort)
                                        </div>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(teamResult.FinalRecommendations.ImplementationStrategy))
                                {
                                    <div class="mt-3">
                                        <h6><i class="bi bi-map"></i> Implementation Strategy</h6>
                                        <div class="p-3 bg-light rounded">
                                            @((MarkupString)FormatImplementationStrategy(teamResult.FinalRecommendations.ImplementationStrategy))
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Styles -->
<style>
    .upload-area {
        border: 2px dashed #ced4da;
        border-radius: 8px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .upload-area.drag-over {
            border-color: #0d6efd;
            background-color: #cfe2ff;
            transform: scale(1.02);
        }

    .metric-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

        .metric-box:hover {
            transform: translateY(-5px);
        }

    .analysis-progress {
        padding: 1.5rem;
        background: linear-gradient(to bottom, #f8f9fa, #ffffff);
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .complexity-badge-low {
        background-color: #28a745 !important;
    }

    .complexity-badge-medium {
        background-color: #ffc107 !important;
    }

    .complexity-badge-high {
        background-color: #fd7e14 !important;
    }

    .complexity-badge-veryhigh {
        background-color: #dc3545 !important;
    }
</style>

@code {
    // File management
    private List<IBrowserFile> selectedFiles = new();
    private List<FileMetadata> processedMetadata = new();
    private ProjectSummary? projectSummary = null;
    private bool isDragging = false;
    private int preProcessingProgress = 0;

    // Team configuration
    private string selectedObjective = "comprehensive-audit";
    private string customObjective = "";
    private bool includeSecurityAgent = true;
    private bool includePerformanceAgent = true;
    private bool includeArchitectureAgent = true;

    // Analysis state
    private bool isPreProcessing = false;
    private bool isAnalyzing = false;
    private string statusMessage = "";
    private TeamAnalysisResult? teamResult;

    // Progress tracking
    private int currentAnalysisPhase = 0;
    private readonly string[] analysisPhases = {
        "Planning team analysis approach",
        "Deploying specialist agents",
        "Executing parallel analysis",
        "Facilitating peer review discussions",
        "Synthesizing team recommendations",
        "Generating executive summary"
    };

    protected override void OnInitialized()
    {
        OnObjectiveChanged();
        statusMessage = "Multi-agent team ready! Select code files for comprehensive AI analysis.";
    }

    private void OnObjectiveChanged()
    {
        // Auto-configure agent team based on objective
        switch (selectedObjective)
        {
            case "security-compliance":
                includeSecurityAgent = true;
                includePerformanceAgent = false;
                includeArchitectureAgent = true;
                break;
            case "performance-optimization":
                includeSecurityAgent = false;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
            case "architecture-modernization":
                includeSecurityAgent = true;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
            case "comprehensive-audit":
                includeSecurityAgent = true;
                includePerformanceAgent = true;
                includeArchitectureAgent = true;
                break;
        }

        StateHasChanged();
    }

    #region File Handling

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        try
        {
            var newFiles = e.GetMultipleFiles(50);
            var csFiles = newFiles
                .Where(f => f.Name.EndsWith(".cs", StringComparison.OrdinalIgnoreCase))
                .ToList();

            // Filter out generated/designer files
            var sourceFiles = csFiles.Where(f =>
                !f.Name.Contains(".Designer.") &&
                !f.Name.Contains(".g.cs") &&
                !f.Name.Contains(".g.i.cs") &&
                !f.Name.Contains("AssemblyInfo.cs") &&
                !f.Name.Contains("GlobalAssemblyInfo.cs") &&
                !f.Name.StartsWith("Temp", StringComparison.OrdinalIgnoreCase)
            ).ToList();

            selectedFiles.Clear();
            processedMetadata.Clear();
            projectSummary = null;

            selectedFiles.AddRange(sourceFiles.Take(20)); // Limit to 20 files

            if (sourceFiles.Count > 20)
            {
                statusMessage = $"✅ Loaded 20 files from {sourceFiles.Count} C# source files (limited for performance).";
            }
            else
            {
                statusMessage = $"✅ Successfully loaded {selectedFiles.Count} C# source files.";
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Error loading files: {ex.Message}";
            Logger.LogError(ex, "Error in HandleFileSelection");
        }
    }

    private async Task HandleIndividualFileSelection(InputFileChangeEventArgs e)
    {
        try
        {
            var newFiles = e.GetMultipleFiles(20);
            selectedFiles.Clear();
            processedMetadata.Clear();
            projectSummary = null;

            selectedFiles.AddRange(newFiles);
            statusMessage = $"✅ Selected {selectedFiles.Count} individual files for analysis.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Error selecting files: {ex.Message}";
            Logger.LogError(ex, "Error in HandleIndividualFileSelection");
        }
    }

    private void HandleDragOver(DragEventArgs e)
    {
        isDragging = true;
    }

    private void HandleDragLeave(DragEventArgs e)
    {
        isDragging = false;
    }

    private void HandleFileDrop(DragEventArgs e)
    {
        isDragging = false;
        statusMessage = "ℹ️ Please use the Browse button to select files (drag-drop from system file browser requires additional setup).";
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);

        // Also remove from processed metadata
        var metadata = processedMetadata.FirstOrDefault(m => m.FileName == file.Name);
        if (metadata != null)
        {
            processedMetadata.Remove(metadata);
        }

        // Recalculate project summary if needed
        if (processedMetadata.Any())
        {
            _ = RecalculateProjectSummary();
        }
        else
        {
            projectSummary = null;
        }

        statusMessage = $"Removed {file.Name}. {selectedFiles.Count} files remaining.";
        StateHasChanged();
    }

    private void ClearFiles()
    {
        selectedFiles.Clear();
        processedMetadata.Clear();
        projectSummary = null;
        statusMessage = "All files cleared. Ready for new selection.";
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    #endregion

    #region Pre-Processing (Local Analysis - No AI Cost)

    private async Task PreProcessFiles()
    {
        if (!selectedFiles.Any())
        {
            statusMessage = "⚠️ Please select files first.";
            return;
        }

        isPreProcessing = true;
        preProcessingProgress = 0;
        processedMetadata.Clear();
        statusMessage = "🔍 Starting local pre-processing (no AI cost)...";
        StateHasChanged();

        try
        {
            foreach (var file in selectedFiles)
            {
                Logger.LogInformation($"Pre-processing: {file.Name}");

                var metadata = await PreProcessingService.ExtractMetadataAsync(file, "csharp");
                processedMetadata.Add(metadata);

                preProcessingProgress++;
                statusMessage = $"Processing {file.Name}... ({preProcessingProgress}/{selectedFiles.Count})";
                StateHasChanged();

                // Small delay for UI responsiveness
                await Task.Delay(100);
            }

            // Create project summary
            projectSummary = await PreProcessingService.CreateProjectSummaryAsync(processedMetadata);

            var issueCount = projectSummary.PreIdentifiedIssues.Count;
            var criticalCount = projectSummary.PreIdentifiedIssues.Count(i =>
                i.Severity == "Critical" || i.Severity == "High");

            statusMessage = $"✅ Pre-processing complete! Found {issueCount} issues " +
                          $"({criticalCount} critical/high). Ready for AI team analysis.";

            Logger.LogInformation($"Pre-processing complete: {projectSummary.TotalClasses} classes, " +
                                $"{projectSummary.TotalMethods} methods, " +
                                $"{issueCount} issues identified");
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Pre-processing error: {ex.Message}";
            Logger.LogError(ex, "Error in PreProcessFiles");
        }
        finally
        {
            isPreProcessing = false;
            StateHasChanged();
        }
    }

    private async Task RecalculateProjectSummary()
    {
        if (processedMetadata.Any())
        {
            projectSummary = await PreProcessingService.CreateProjectSummaryAsync(processedMetadata);
            StateHasChanged();
        }
    }

    #endregion

    #region AI Team Analysis

    private async Task StartTeamAnalysis()
    {
        if (projectSummary == null)
        {
            statusMessage = "⚠️ Please pre-process files first (click 'Pre-Process Files' button).";
            return;
        }

        if (!includeSecurityAgent && !includePerformanceAgent && !includeArchitectureAgent)
        {
            statusMessage = "⚠️ Please select at least one AI agent for analysis.";
            return;
        }

        isAnalyzing = true;
        currentAnalysisPhase = 0;
        statusMessage = $"🚀 Initializing multi-agent team for {selectedFiles.Count} files...";
        StateHasChanged();

        try
        {
            // Create optimized AI request with summaries only
            var request = new AgentAnalysisRequest
            {
                ProjectSummary = projectSummary,
                AnalysisObjective = selectedObjective == "custom" ? customObjective : selectedObjective,
                BusinessContext = GetBusinessContext(),
                IncludeSecurityAnalysis = includeSecurityAgent,
                IncludePerformanceAnalysis = includePerformanceAgent,
                IncludeArchitectureAnalysis = includeArchitectureAgent,
                FocusAreas = GetFocusAreas()
            };

            // Simulate phases for now (replace with actual orchestration service call)
            for (int i = 0; i < analysisPhases.Length; i++)
            {
                currentAnalysisPhase = i;
                Logger.LogInformation($"Analysis phase: {analysisPhases[i]}");
                StateHasChanged();
                await Task.Delay(2000); // Simulate processing time
            }

            teamResult = await OrchestrationService.AnalyzeProjectSummaryAsync(request);

            currentAnalysisPhase = analysisPhases.Length;
            statusMessage = $"✅ Multi-agent analysis complete for {selectedFiles.Count} files!";

            Logger.LogInformation("Team analysis completed successfully");
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Analysis error: {ex.Message}";
            Logger.LogError(ex, "Error in StartTeamAnalysis");
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private TeamAnalysisResult CreateMockTeamResult()
    {
        // Create a mock result for demonstration
        // TODO: Remove this when actual orchestration service is connected
        return new TeamAnalysisResult
        {
            ConversationId = Guid.NewGuid().ToString(),
            OverallConfidenceScore = 85,
            IndividualAnalyses = new List<SpecialistAnalysisResult>
            {
                new SpecialistAnalysisResult
                {
                    AgentName = "SecurityAnalyst",
                    Specialty = "Security",
                    Priority = "Critical",
                    ConfidenceScore = 88,
                    BusinessImpact = "High risk of data breach due to SQL injection vulnerabilities. Immediate remediation required.",
                    EstimatedEffort = 16,
                    AnalysisTimestamp = DateTime.UtcNow,
                    KeyFindings = new List<Finding>
                    {
                        new Finding
                        {
                            Category = "SQL Injection",
                            Severity = "Critical",
                            Description = "String concatenation used in SQL queries allows injection attacks",
                            Location = "ReportGenerator.cs:45"
                        },
                        new Finding
                        {
                            Category = "Hardcoded Secrets",
                            Severity = "Critical",
                            Description = "Database password found hardcoded in source code",
                            Location = "SessionHandler.cs:23"
                        }
                    },
                    Recommendations = new List<Recommendation>
                    {
                        new Recommendation
                        {
                            Title = "Implement Parameterized Queries",
                            Description = "Replace string concatenation with parameterized SQL queries using SqlParameter",
                            Priority = "Critical",
                            EstimatedHours = 8,
                            Implementation = "Use SqlCommand with Parameters.AddWithValue() for all database queries"
                        },
                        new Recommendation
                        {
                            Title = "Move Secrets to Configuration",
                            Description = "Extract hardcoded credentials to secure configuration (Azure Key Vault, appsettings.json)",
                            Priority = "Critical",
                            EstimatedHours = 4,
                            Implementation = "Use IConfiguration and Azure Key Vault for secrets management"
                        }
                    },
                    RiskLevel = new RiskAssessment
                    {
                        OverallRisk = "Critical",
                        Likelihood = "High",
                        Impact = "Severe"
                    }
                },
                new SpecialistAnalysisResult
                {
                    AgentName = "PerformanceAnalyst",
                    Specialty = "Performance",
                    Priority = "Medium",
                    ConfidenceScore = 82,
                    BusinessImpact = "Current performance bottlenecks may impact user experience during peak loads.",
                    EstimatedEffort = 12,
                    AnalysisTimestamp = DateTime.UtcNow,
                    KeyFindings = new List<Finding>
                    {
                        new Finding
                        {
                            Category = "Synchronous Operations",
                            Severity = "Medium",
                            Description = "Database calls executed synchronously, blocking threads",
                            Location = "Multiple files"
                        },
                        new Finding
                        {
                            Category = "N+1 Queries",
                            Severity = "High",
                            Description = "Inefficient data access patterns causing excessive database roundtrips",
                            Location = "ReportGenerator.cs"
                        }
                    },
                    Recommendations = new List<Recommendation>
                    {
                        new Recommendation
                        {
                            Title = "Implement Async/Await Patterns",
                            Description = "Convert synchronous database calls to async operations",
                            Priority = "High",
                            EstimatedHours = 8,
                            Implementation = "Replace ExecuteReader with ExecuteReaderAsync throughout codebase"
                        },
                        new Recommendation
                        {
                            Title = "Optimize Database Queries",
                            Description = "Reduce N+1 queries by implementing eager loading or batching",
                            Priority = "Medium",
                            EstimatedHours = 6,
                            Implementation = "Use JOIN operations or in-memory caching for related data"
                        }
                    }
                },
                new SpecialistAnalysisResult
                {
                    AgentName = "ArchitectureAnalyst",
                    Specialty = "Architecture",
                    Priority = "Medium",
                    ConfidenceScore = 80,
                    BusinessImpact = "Current architecture limits scalability and maintainability. Modernization will improve long-term ROI.",
                    EstimatedEffort = 24,
                    AnalysisTimestamp = DateTime.UtcNow,
                    KeyFindings = new List<Finding>
                    {
                        new Finding
                        {
                            Category = "Legacy Patterns",
                            Severity = "Medium",
                            Description = "Use of DataSet/DataTable instead of modern ORM patterns",
                            Location = "Data access layer"
                        },
                        new Finding
                        {
                            Category = "Tight Coupling",
                            Severity = "Medium",
                            Description = "Direct dependencies between layers, violating separation of concerns",
                            Location = "Overall architecture"
                        }
                    },
                    Recommendations = new List<Recommendation>
                    {
                        new Recommendation
                        {
                            Title = "Introduce Dependency Injection",
                            Description = "Implement DI container to reduce tight coupling and improve testability",
                            Priority = "Medium",
                            EstimatedHours = 16,
                            Implementation = "Use Microsoft.Extensions.DependencyInjection for IoC container"
                        },
                        new Recommendation
                        {
                            Title = "Migrate to Entity Framework Core",
                            Description = "Replace DataSet/DataTable with Entity Framework Core for better maintainability",
                            Priority = "Low",
                            EstimatedHours = 40,
                            Implementation = "Phased migration starting with new features, then refactoring legacy code"
                        }
                    }
                }
            },
            TeamDiscussion = new List<AgentMessage>
            {
                new AgentMessage
                {
                    FromAgent = "SecurityAnalyst",
                    ToAgent = "All",
                    Type = MessageType.Analysis,
                    Subject = "Critical Security Concerns",
                    Content = "The SQL injection vulnerabilities I identified pose an immediate business risk. These should be prioritized above all other recommendations.",
                    Timestamp = DateTime.UtcNow.AddSeconds(-60)
                },
                new AgentMessage
                {
                    FromAgent = "PerformanceAnalyst",
                    ToAgent = "SecurityAnalyst",
                    Type = MessageType.Agreement,
                    Subject = "Concur with Security Priority",
                    Content = "I agree that security issues must be addressed first. The performance improvements I recommended can wait until security is resolved.",
                    Timestamp = DateTime.UtcNow.AddSeconds(-45)
                },
                new AgentMessage
                {
                    FromAgent = "ArchitectureAnalyst",
                    ToAgent = "All",
                    Type = MessageType.Analysis,
                    Subject = "Long-term Architecture Concerns",
                    Content = "While addressing immediate security issues, consider that the architectural improvements I suggested will prevent similar issues in the future.",
                    Timestamp = DateTime.UtcNow.AddSeconds(-30)
                },
                new AgentMessage
                {
                    FromAgent = "Orchestrator",
                    ToAgent = "All",
                    Type = MessageType.Synthesis,
                    Subject = "Team Consensus Reached",
                    Content = "Team has reached consensus: 1) Fix critical security issues immediately, 2) Implement performance improvements, 3) Plan long-term architectural modernization.",
                    Timestamp = DateTime.UtcNow
                }
            },
            FinalRecommendations = new ConsolidatedRecommendations
            {
                HighPriorityActions = new List<Recommendation>
                {
                    new Recommendation
                    {
                        Title = "Fix SQL Injection Vulnerabilities",
                        Description = "Critical security issue requiring immediate attention. Replace string concatenation with parameterized queries.",
                        Priority = "Critical",
                        EstimatedHours = 8,
                        Implementation = "Use SqlCommand.Parameters for all database operations",
                        Dependencies = new List<string> { "Code review", "Security testing" }
                    },
                    new Recommendation
                    {
                        Title = "Secure Credentials Management",
                        Description = "Move hardcoded secrets to Azure Key Vault or secure configuration",
                        Priority = "Critical",
                        EstimatedHours = 4,
                        Implementation = "Implement IConfiguration with Azure Key Vault integration",
                        Dependencies = new List<string> { "Azure Key Vault setup", "Configuration updates" }
                    },
                    new Recommendation
                    {
                        Title = "Implement Async Database Operations",
                        Description = "Convert synchronous operations to async/await for better scalability",
                        Priority = "High",
                        EstimatedHours = 8,
                        Implementation = "Replace sync methods with async equivalents throughout data layer",
                        Dependencies = new List<string> { "Testing", "Performance validation" }
                    }
                },
                MediumPriorityActions = new List<Recommendation>
                {
                    new Recommendation
                    {
                        Title = "Optimize Database Query Patterns",
                        Description = "Reduce N+1 queries and implement efficient data loading strategies",
                        Priority = "Medium",
                        EstimatedHours = 6,
                        Implementation = "Use JOIN operations and implement caching where appropriate"
                    },
                    new Recommendation
                    {
                        Title = "Introduce Dependency Injection",
                        Description = "Implement DI to reduce coupling and improve testability",
                        Priority = "Medium",
                        EstimatedHours = 16,
                        Implementation = "Setup DI container and refactor service dependencies"
                    }
                },
                LongTermStrategic = new List<Recommendation>
                {
                    new Recommendation
                    {
                        Title = "Migrate to Entity Framework Core",
                        Description = "Replace legacy DataSet/DataTable with modern ORM",
                        Priority = "Low",
                        EstimatedHours = 40,
                        Implementation = "Phased migration starting with new features"
                    }
                },
                TotalEstimatedEffort = 82,
                ImplementationStrategy = "Phase 1 (Immediate): Address critical security vulnerabilities (12 hours). Phase 2 (Short-term): Implement performance improvements (14 hours). Phase 3 (Long-term): Architectural modernization (56 hours)."
            },
            Consensus = new TeamConsensusMetrics
            {
                AgreementPercentage = 87.5,
                TotalMessages = 4,
                ConflictCount = 0,
                ResolvedConflictCount = 0,
                AgentParticipationScores = new Dictionary<string, int>
                {
                    { "SecurityAnalyst", 1 },
                    { "PerformanceAnalyst", 1 },
                    { "ArchitectureAnalyst", 1 },
                    { "Orchestrator", 1 }
                }
            },
            ExecutiveSummary = @"
## Executive Summary: Legacy Code Analysis

**Analysis Scope:** 2 C# files analyzed by 3 specialist AI agents
**Overall Assessment:** Critical security vulnerabilities require immediate attention
**Team Confidence:** 85%

### Critical Findings
1. **SQL Injection Vulnerabilities (Critical)** - Direct business risk requiring immediate remediation
2. **Hardcoded Credentials (Critical)** - Security compliance violation
3. **Performance Bottlenecks (High)** - Impact on user experience during peak loads

### Recommended Actions
**Immediate (12 hours):**
- Fix SQL injection vulnerabilities using parameterized queries
- Move credentials to secure configuration

**Short-term (14 hours):**
- Implement async/await patterns
- Optimize database query patterns

**Long-term (56 hours):**
- Migrate to modern ORM (Entity Framework Core)
- Implement comprehensive DI architecture

### Investment Required
- **Total Effort:** 82 hours (~2 weeks for 1 developer)
- **Estimated Cost:** $10,250 (at $125/hour)
- **Expected ROI:** Risk mitigation, improved performance, reduced technical debt

### Business Impact
Addressing these issues will:
- Eliminate critical security risks
- Improve application performance by ~40%
- Reduce future maintenance costs
- Enable easier scaling and feature development
"
        };
    }

    #endregion

    #region Helper Methods

    private int GetSelectedAgentCount()
    {
        int count = 0;
        if (includeSecurityAgent) count++;
        if (includePerformanceAgent) count++;
        if (includeArchitectureAgent) count++;
        return count;
    }

    private int EstimateTokenUsage()
    {
        if (projectSummary == null) return 0;

        // Compact summary uses ~50 tokens per file vs ~2000 for raw code
        int summaryTokens = selectedFiles.Count * 50;
        int agentMultiplier = GetSelectedAgentCount();

        return summaryTokens * agentMultiplier;
    }

    private int EstimateTime()
    {
        // Estimate based on file count and agents
        int baseTime = selectedFiles.Count * 2; // 2 seconds per file
        int agentMultiplier = GetSelectedAgentCount();
        return Math.Max(10, Math.Min(60, baseTime * agentMultiplier / 2));
    }

    private string GetCurrentAnalysisPhase()
    {
        if (currentAnalysisPhase < analysisPhases.Length)
            return analysisPhases[currentAnalysisPhase];
        return "Analysis Complete";
    }

    private int GetAnalysisProgress()
    {
        return (int)((double)currentAnalysisPhase / analysisPhases.Length * 100);
    }

    private string GetComplexityBadgeClass(string complexity)
    {
        return complexity.ToLower() switch
        {
            "low" => "bg-success",
            "medium" => "bg-warning text-dark",
            "high" => "bg-warning",
            "very high" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetStatusAlertClass()
    {
        if (statusMessage.StartsWith("✅")) return "alert-success";
        if (statusMessage.StartsWith("⚠️")) return "alert-warning";
        if (statusMessage.StartsWith("❌")) return "alert-danger";
        return "alert-info";
    }

    private string GetStatusIcon()
    {
        if (statusMessage.StartsWith("✅")) return "bi-check-circle-fill";
        if (statusMessage.StartsWith("⚠️")) return "bi-exclamation-triangle-fill";
        if (statusMessage.StartsWith("❌")) return "bi-x-circle-fill";
        return "bi-info-circle-fill";
    }

    #endregion

    #region Helper Methods

    private string GetBusinessContext()
    {
        return selectedObjective switch
        {
            "security-compliance" => "Focus on security vulnerabilities and compliance requirements",
            "performance-optimization" => "Identify performance bottlenecks and optimization opportunities",
            "architecture-modernization" => "Assess modernization readiness and architectural improvements",
            "comprehensive-audit" => "Complete assessment across security, performance, and architecture",
            _ => customObjective
        };
    }

    private List<string> GetFocusAreas()
    {
        var areas = new List<string>();

        if (projectSummary != null && projectSummary.PreIdentifiedIssues.Any())
        {
            areas.Add("Pre-identified security issues");
            areas.Add("High complexity methods");
            areas.Add("Legacy patterns");
        }

        return areas;
    }

    private string FormatExecutiveSummary(string summary)
    {
        if (string.IsNullOrEmpty(summary)) return "<p>No executive summary available.</p>";

        // Basic formatting for executive consumption
        summary = summary.Replace("\n\n", "</p><p>");
        summary = summary.Replace("\n", "<br>");

        // Format headers
        summary = System.Text.RegularExpressions.Regex.Replace(
            summary,
            @"^(#{1,3})\s*([^<\n]+?)(<br>|</p>|$)",
            "<h6 class='text-primary mb-2'>$2</h6>");

        // Format bullet points
        summary = summary.Replace("• ", "<i class='bi bi-arrow-right text-success me-2'></i>");
        summary = summary.Replace("- ", "<i class='bi bi-chevron-right text-info me-2'></i>");

        if (!summary.StartsWith("<p") && !summary.StartsWith("<h6"))
        {
            summary = $"<p>{summary}</p>";
        }

        return summary;
    }

    private string FormatImplementationStrategy(string strategy)
    {
        if (string.IsNullOrEmpty(strategy)) return "<p>No implementation strategy available.</p>";

        // Format phases and sections
        strategy = strategy.Replace("Phase 1:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-1-circle'></i> Phase 1:</h6>");
        strategy = strategy.Replace("Phase 2:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-2-circle'></i> Phase 2:</h6>");
        strategy = strategy.Replace("Phase 3:", "<h6 class='text-primary mt-3 mb-2'><i class='bi bi-3-circle'></i> Phase 3:</h6>");

        strategy = strategy.Replace("\n\n", "</p><p>");
        strategy = strategy.Replace("\n", "<br>");
        strategy = strategy.Replace("• ", "<i class='bi bi-check-circle text-success me-1'></i>");

        if (!strategy.StartsWith("<h6") && !strategy.StartsWith("<p"))
        {
            strategy = $"<p>{strategy}</p>";
        }

        return strategy;
    }

    private string GetAgentIcon(string agentName)
    {
        return agentName.ToLower() switch
        {
            var name when name.Contains("security") => "🛡️",
            var name when name.Contains("performance") => "⚡",
            var name when name.Contains("architect") => "🏗️",
            _ => "🤖"
        };
    }

    private string GetConfidenceBadgeClass(int confidence)
    {
        return confidence switch
        {
            >= 90 => "bg-success",
            >= 75 => "bg-primary",
            >= 60 => "bg-warning text-dark",
            _ => "bg-danger"
        };
    }

    private string GetSeverityBadgeClass(string severity)
    {
        return severity?.ToUpper() switch
        {
            "CRITICAL" => "bg-danger",
            "HIGH" => "bg-warning text-dark",
            "MEDIUM" => "bg-info",
            "LOW" => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }

    private string GetMessageTypeBadgeClass(MessageType messageType)
    {
        return messageType switch
        {
            MessageType.Analysis => "bg-primary",
            MessageType.PeerReview => "bg-info",
            MessageType.Challenge => "bg-warning text-dark",
            MessageType.Agreement => "bg-success",
            MessageType.Synthesis => "bg-dark",
            _ => "bg-secondary"
        };
    }

    private string TruncateMessage(string message, int maxLength)
    {
        if (string.IsNullOrEmpty(message) || message.Length <= maxLength)
            return message;

        return message.Substring(0, maxLength) + "...";
    }

    private string GetEstimatedTimeline(decimal hours)
    {
        return hours switch
        {
            <= 40 => "1 week",
            <= 80 => "2 weeks",
            <= 160 => "1 month",
            <= 320 => "2 months",
            _ => "3+ months"
        };
    }

    #endregion
}
