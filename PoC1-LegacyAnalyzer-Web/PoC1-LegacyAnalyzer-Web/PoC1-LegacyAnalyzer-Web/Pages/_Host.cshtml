@page "/"
@namespace PoC1_LegacyAnalyzer_Web.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = "_Layout";
}

<!-- Blazor reconnection UI -->
<div id="blazor-error-ui" class="alert alert-danger" role="alert" style="display: none;">
    <strong>Connection lost!</strong> The application is attempting to reconnect...
    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="location.reload()">Reload</button>
</div>

<style>
    #blazor-error-ui {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        margin: 0;
        border-radius: 0;
        text-align: center;
        padding: 1rem;
    }
</style>

<!-- Add this to your _Host.cshtml after the existing Chart.js script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="~/js/scroll-helper.js"></script>

<script>
    // Blazor reconnection handler
    window.Blazor = window.Blazor || {};
    window.Blazor.defaultReconnectionHandler = new class {
        constructor() {
            this._currentAttempt = 0;
        }
        onConnectionDown(options, error) {
            console.warn('Blazor connection down:', error);
            document.getElementById('blazor-error-ui').style.display = 'block';
            return true; // Always attempt to reconnect
        }
        onConnectionUp() {
            console.log('Blazor connection restored');
            document.getElementById('blazor-error-ui').style.display = 'none';
            this._currentAttempt = 0;
        }
        async reconnect(reconnection) {
            this._currentAttempt++;
            console.log(`Reconnection attempt ${this._currentAttempt}...`);
            
            // Retry with increasing delays: 0s, 2s, 10s, 30s, then every 60s
            const delays = [0, 2000, 10000, 30000];
            const delay = this._currentAttempt <= delays.length 
                ? delays[this._currentAttempt - 1] 
                : 60000;
            
            await new Promise(resolve => setTimeout(resolve, delay));
            
            return reconnection.reconnect();
        }
    };
</script>

<script>    
    window.createSimpleChart = function(canvasId, chartType, labels, data, title) {
        console.log('Creating chart:', canvasId, chartType, title);

        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error('Canvas not found:', canvasId);
            return false;
        }

        const ctx = canvas.getContext('2d');

        // Destroy existing chart if any
        if (canvas.chart) {
            canvas.chart.destroy();
        }

        try {
            canvas.chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: [
                            '#28a745', // Green
                            '#ffc107', // Yellow
                            '#dc3545', // Red
                            '#007bff', // Blue
                            '#17a2b8'  // Cyan
                        ],
                        borderColor: '#495057',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    }
                }
            });
            console.log('Chart created successfully:', canvasId);
            return true;
        } catch (error) {
            console.error('Error creating chart:', error);
            return false;
        }
    };

    // Test function to verify Chart.js is working
    window.testSimpleChart = function() {
        console.log('Testing simple chart...');

        // Check if Chart.js loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded');
            return false;
        }

        // Find any canvas element for testing
        const canvas = document.querySelector('canvas');
        if (!canvas) {
            console.error('No canvas elements found');
            return false;
        }

        console.log('Found canvas:', canvas.id);

        // Create a simple test chart
        return window.createSimpleChart(
            canvas.id,
            'bar',
            ['Test 1', 'Test 2', 'Test 3'],
            [10, 20, 30],
            'Test Chart'
        );
    };

    // File download function
    window.downloadFile = function (fileName, dataUrl) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    console.log('Chart.js loaded:', typeof Chart !== 'undefined');
</script>

<component type="typeof(App)" render-mode="ServerPrerendered" />
