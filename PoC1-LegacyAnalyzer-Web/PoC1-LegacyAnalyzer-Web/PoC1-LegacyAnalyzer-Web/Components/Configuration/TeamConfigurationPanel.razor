@using Microsoft.AspNetCore.Components.Forms
@using PoC1_LegacyAnalyzer_Web.Components.Configuration
@using PoC1_LegacyAnalyzer_Web.Components.Shared
@using PoC1_LegacyAnalyzer_Web.Models

@* Team configuration panel - composite component *@
<div class="card shadow border-primary">
    <div class="card-header border-primary card-header-compact">
        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Team Configuration</h5>
    </div>
    <div class="config-summary p-2 bg-light border-bottom" @onclick="ToggleConfigExpanded" style="cursor: pointer;">
        <small class="text-muted">
            <strong>@GetObjectiveDisplayName()</strong> | 
            @selectedAgents.Count Agent(s) | 
            @selectedFiles.Count File(s)
            <i class="bi bi-chevron-@(isConfigExpanded ? "up" : "down") float-end"></i>
        </small>
    </div>
    <div class="collapse @(isConfigExpanded ? "show" : "")" id="teamConfigContent">
        <div class="card-body py-2">
            <!-- Row 1: Objective + Agents side-by-side -->
            <div class="row configuration-row mb-2">
                <div class="col-md-6">
                    <BusinessObjectiveSelector 
                        ShowLabel="true"
                        ShowDescription="false"
                        SelectedObjective="@selectedObjective"
                        CustomObjective="@customObjective"
                        OnObjectiveChange="@OnObjectiveChanged"
                        OnCustomObjectiveChange="@OnCustomObjectiveChanged" />
                </div>
                <div class="col-md-6">
                    <AgentTeamSelector @ref="agentSelector"
                        DisplayMode="inline"
                        IncludeSecurityAgent="@includeSecurityAgent"
                        IncludePerformanceAgent="@includePerformanceAgent"
                        IncludeArchitectureAgent="@includeArchitectureAgent"
                        OnSelectionChange="@OnAgentSelectionChanged" />
                </div>
            </div>
            
            <!-- Row 2: File upload compact -->
            <div class="mb-2">
                <FileUploadManager 
                    DisplayMode="compact"
                    SelectedFiles="@selectedFiles"
                    MaxFiles="@MaxFiles"
                    MaxFileSizeMB="@MaxFileSizeMB"
                    OnFilesChanged="@OnFilesChanged"
                    OnStatusChanged="@OnStatusChanged" />
            </div>

            <!-- Row 3: Action button -->
            <div class="d-grid mb-2">
                <button class="btn btn-success btn-lg" @onclick="StartAnalysis" disabled="@(isAnalyzing || !IsConfigurationValid())">
                    @if (isAnalyzing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <text>Team Analyzing...</text>
                    }
                    else
                    {
                        <text><i class="bi bi-people"></i> Start Team Analysis</text>
                    }
                </button>
            </div>

            <AnalysisProgressTracker 
                IsAnalyzing="@isAnalyzing"
                CurrentPhase="@currentPhase"
                TotalPhases="6" />

            @if (!string.IsNullOrEmpty(statusMessage) && !isAnalyzing)
            {
                <div class="alert alert-info">
                    <small><i class="bi bi-info-circle"></i> @statusMessage</small>
                </div>
            }

            @if (validationErrors.Any())
            {
                <ErrorAlert Title="Configuration Errors"
                           Messages="@validationErrors"
                           Severity="warning"
                           IsList="true" />
            }
        </div>
    </div>
</div>

@code {
    private AgentTeamSelector? agentSelector;
    private string selectedObjective = "comprehensive-audit";
    private string customObjective = "";
    private bool includeSecurityAgent = true;
    private bool includePerformanceAgent = true;
    private bool includeArchitectureAgent = true;
    private List<IBrowserFile> selectedFiles = new();
    private bool isAnalyzing = false;
    private int currentPhase = 0;
    private string statusMessage = "Multi-agent team ready! Select agents and provide code for comprehensive analysis.";
    private List<string> validationErrors = new();
    private List<string> selectedAgents = new();
    private bool isConfigExpanded = true;

    [Parameter] public int MaxFiles { get; set; } = 50;
    [Parameter] public int MaxFileSizeMB { get; set; } = 10;
    [Parameter] public EventCallback<AnalysisConfiguration> OnAnalysisStarted { get; set; }
    [Parameter] public EventCallback<int> OnPhaseChanged { get; set; }

    protected override void OnInitialized()
    {
        Console.WriteLine($"[TeamConfigurationPanel] OnInitialized called. OnAnalysisStarted.HasDelegate={OnAnalysisStarted.HasDelegate}");
        statusMessage = "Multi-agent team ready! Select agents and provide code for comprehensive analysis.";
        // Initialize with default agents (all three are selected by default)
        selectedAgents = new List<string> { "security", "performance", "architecture" };
        ValidateConfiguration();
    }
    
    protected override void OnParametersSet()
    {
        Console.WriteLine($"[TeamConfigurationPanel] OnParametersSet called. OnAnalysisStarted.HasDelegate={OnAnalysisStarted.HasDelegate}");
        base.OnParametersSet();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && agentSelector != null)
        {
            // Sync initial agent selection from the selector component
            var initialAgents = agentSelector.GetSelectedAgents();
            if (initialAgents.Any() && !selectedAgents.SequenceEqual(initialAgents))
            {
                selectedAgents = initialAgents;
                StateHasChanged();
            }
        }
    }

    private async Task OnObjectiveChanged(string objective)
    {
        selectedObjective = objective;
        
        // Auto-configure agents based on objective
        if (agentSelector != null)
        {
            await agentSelector.ConfigureForObjective(objective);
        }
        
        ValidateConfiguration();
        StateHasChanged();
    }

    private async Task OnCustomObjectiveChanged(string customObj)
    {
        customObjective = customObj;
        ValidateConfiguration();
        StateHasChanged();
    }

    private async Task OnAgentSelectionChanged(List<string> agents)
    {
        selectedAgents = agents;
        ValidateConfiguration();
        StateHasChanged();
    }

    private async Task OnFilesChanged(List<IBrowserFile> files)
    {
        selectedFiles = files;
        ValidateConfiguration();
        StateHasChanged();
    }

    private async Task OnStatusChanged(string status)
    {
        statusMessage = status;
        StateHasChanged();
    }

    private async Task StartAnalysis()
    {
        Console.WriteLine("[TeamConfigurationPanel] StartAnalysis called");

        if (!IsConfigurationValid())
        {
            Console.WriteLine("[TeamConfigurationPanel] Configuration is NOT valid. Errors:");
            foreach (var err in validationErrors)
            {
                Console.WriteLine($"[TeamConfigurationPanel]   - {err}");
            }
            return;
        }

        Console.WriteLine("[TeamConfigurationPanel] Configuration is valid. Proceeding to invoke OnAnalysisStarted...");

        isAnalyzing = true;
        currentPhase = 0;

        var config = new AnalysisConfiguration
        {
            BusinessObjective = selectedObjective,
            CustomObjective = customObjective,
            SelectedAgents = selectedAgents,
            Files = selectedFiles
        };

        try
        {
            Console.WriteLine($"[TeamConfigurationPanel] Invoking OnAnalysisStarted. HasDelegate={OnAnalysisStarted.HasDelegate}");
            await OnAnalysisStarted.InvokeAsync(config);
            Console.WriteLine("[TeamConfigurationPanel] OnAnalysisStarted.InvokeAsync completed.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[TeamConfigurationPanel] ERROR during OnAnalysisStarted.InvokeAsync: {ex.GetType().Name}: {ex.Message}");
            Console.WriteLine(ex.StackTrace);
            statusMessage = $"Analysis failed: {ex.Message}";
            isAnalyzing = false;
        }

        StateHasChanged();
    }

    private bool IsConfigurationValid()
    {
        Console.WriteLine("[TeamConfigurationPanel] IsConfigurationValid called");
        ValidateConfiguration();
        Console.WriteLine($"[TeamConfigurationPanel] validationErrors.Count = {validationErrors.Count}");
        return !validationErrors.Any();
    }

    private void ValidateConfiguration()
    {
        validationErrors.Clear();

        var config = new AnalysisConfiguration
        {
            BusinessObjective = selectedObjective,
            CustomObjective = customObjective,
            SelectedAgents = selectedAgents,
            Files = selectedFiles
        };

        validationErrors.AddRange(config.GetValidationErrors());

        Console.WriteLine($"[TeamConfigurationPanel] ValidateConfiguration -> EffectiveObjective='{config.EffectiveObjective}', Agents={config.SelectedAgents.Count}, Files={config.Files.Count}");
    }

    /// <summary>
    /// Updates analysis phase from parent component.
    /// </summary>
    public void UpdatePhase(int phase)
    {
        currentPhase = phase;
        StateHasChanged();
    }

    /// <summary>
    /// Completes analysis and resets state.
    /// </summary>
    public void CompleteAnalysis()
    {
        isAnalyzing = false;
        currentPhase = 0;
        statusMessage = "Analysis complete!";
        isConfigExpanded = false;
        StateHasChanged();
    }

    private void ToggleConfigExpanded()
    {
        isConfigExpanded = !isConfigExpanded;
        StateHasChanged();
    }

    private string GetObjectiveDisplayName()
    {
        if (!string.IsNullOrWhiteSpace(customObjective) && selectedObjective == "custom")
            return customObjective.Length > 50 ? customObjective.Substring(0, 50) + "..." : customObjective;
            
        return selectedObjective switch
        {
            "security-compliance" => "Security Compliance Assessment",
            "performance-optimization" => "Performance Optimization Analysis",
            "architecture-modernization" => "Architecture Modernization Planning",
            "comprehensive-audit" => "Comprehensive Code Audit",
            "custom" => "Custom Objective",
            _ => "Unknown Objective"
        };
    }

    /// <summary>
    /// Sets error state.
    /// </summary>
    public void SetError(string error)
    {
        isAnalyzing = false;
        statusMessage = error;
        StateHasChanged();
    }
}