@using Microsoft.AspNetCore.Components.Forms
@using PoC1_LegacyAnalyzer_Web.Helpers

@* File upload manager component *@

@if (DisplayMode == "compact")
{
    <div class="mb-2">
        <label class="form-label fw-bold small mb-1">Upload Files</label>
        
        <!-- Inline buttons -->
        <div class="upload-buttons-compact mb-1">
            <InputFile id="folderInputCompact" OnChange="HandleFolderSelection"
                       multiple accept="@AcceptedTypes" class="d-none" webkitdirectory />
            <label for="folderInputCompact" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-folder2-open"></i> Folder
            </label>
            
            <InputFile id="individualFilesCompact" OnChange="HandleIndividualFileSelection"
                       multiple accept="@AcceptedTypes" class="d-none" />
            <label for="individualFilesCompact" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-file-earmark-code"></i> Files
            </label>

            @if (selectedFiles.Any())
            {
                <span class="badge bg-secondary file-count-badge ms-auto">
                    <i class="bi bi-files"></i> @selectedFiles.Count selected
                </span>
                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="ClearAllFiles">
                    <i class="bi bi-x"></i>
                </button>
            }
        </div>
        
        <!-- Compact horizontal summary (no per-file name list) -->
        @if (selectedFiles.Any())
        {
            <div class="compact-file-summary d-flex flex-wrap align-items-center gap-2 mt-1">
                <span class="file-badge">
                    <i class="bi bi-files"></i>
                    <span>@selectedFiles.Count files</span>
                </span>
                <span class="text-muted small">
                    @FormattingHelpers.FormatFileSize(selectedFiles.Sum(f => f.Size))
                </span>
            </div>
        }
    </div>
}
else
{
    <!-- Original standard layout -->
    <div class="upload-area mb-3">
        <div class="text-center p-4">
            <div style="font-size: 3rem;" class="text-muted mb-3">
                <i class="bi bi-folder2-open"></i>
            </div>
            <h6>Upload Legacy Code Files</h6>
            <p class="text-muted mb-3">Select source code files for multi-agent analysis (C#, Python, JavaScript, TypeScript, Java, Go)</p>

            <InputFile id="folderInput" OnChange="HandleFolderSelection"
                       multiple accept="@AcceptedTypes" class="d-none" webkitdirectory />
            <label for="folderInput" class="btn btn-primary me-2">
                <i class="bi bi-folder-plus"></i> Select Project Folder
            </label>

            <InputFile id="individualFiles" OnChange="HandleIndividualFileSelection"
                       multiple accept="@AcceptedTypes" class="d-none" />
            <label for="individualFiles" class="btn btn-outline-secondary">
                <i class="bi bi-file-plus"></i> Select Individual Files
            </label>
        </div>
    </div>

    @if (selectedFiles.Any())
    {
        <div class="mb-3">
            <h6>Selected Files (@selectedFiles.Count):</h6>
            <div style="max-height: 200px; overflow-y: auto;">
                @foreach (var file in selectedFiles)
                {
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                        <span><i class="bi bi-file-earmark-code"></i> @file.Name</span>
                        <div>
                            <small class="text-muted me-2">@FormattingHelpers.FormatFileSize(file.Size)</small>
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="@(() => RemoveFile(file))">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
            <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="ClearAllFiles">
                <i class="bi bi-trash"></i> Clear All Files
            </button>
        </div>
    }
}

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(hasError ? "alert-warning" : "alert-info")">
        <small><i class="bi @(hasError ? "bi-exclamation-triangle" : "bi-info-circle")"></i> @statusMessage</small>
    </div>
}

@code {
    private List<IBrowserFile> selectedFiles = new();
    private string statusMessage = "";
    private bool hasError = false;

    [Parameter] public List<IBrowserFile> SelectedFiles { get; set; } = new();
    [Parameter] public int MaxFiles { get; set; } = 50; // UI hint only - no actual limit enforced (batching handles any number)
    [Parameter] public int MaxFileSizeMB { get; set; } = 10; // 10MB file size limit
    // Default: enable common code file types for multi-language analysis
    [Parameter] public string AcceptedTypes { get; set; } = ".cs,.py,.js,.ts,.java,.go";
    [Parameter] public string DisplayMode { get; set; } = "standard"; // "standard" or "compact"
    [Parameter] public EventCallback<List<IBrowserFile>> OnFilesChanged { get; set; }
    [Parameter] public EventCallback<string> OnStatusChanged { get; set; }

    protected override void OnParametersSet()
    {
        selectedFiles = new List<IBrowserFile>(SelectedFiles);
    }

    private async Task HandleFolderSelection(InputFileChangeEventArgs e)
    {
        // Use a large number to allow folder selection - batching handles any number of files
        await ProcessFileSelection(e.GetMultipleFiles(10000), true);
    }

    private async Task HandleIndividualFileSelection(InputFileChangeEventArgs e)
    {
        // Use a large number - batching handles any number of files
        await ProcessFileSelection(e.GetMultipleFiles(10000), false);
    }

    private async Task ProcessFileSelection(IEnumerable<IBrowserFile> newFiles, bool isFolder)
    {
        // Allow multiple languages; filter by extension list
        var allowedExtensions = new[] { ".cs", ".py", ".js", ".ts", ".java", ".go" };
        var sourceFiles = newFiles.Where(f =>
                allowedExtensions.Any(ext => f.Name.EndsWith(ext, StringComparison.OrdinalIgnoreCase)) &&
                !f.Name.Contains(".Designer.", StringComparison.OrdinalIgnoreCase) &&
                !f.Name.Contains(".g.cs", StringComparison.OrdinalIgnoreCase) &&
                !f.Name.Contains("AssemblyInfo.cs", StringComparison.OrdinalIgnoreCase)
            )
            .ToList();

        // Filter by file size
        var maxFileSizeBytes = MaxFileSizeMB * 1024L * 1024L;
        var validFiles = sourceFiles.Where(f => f.Size <= maxFileSizeBytes).ToList();
        var oversizedFiles = sourceFiles.Where(f => f.Size > maxFileSizeBytes).ToList();

        selectedFiles.Clear();
        // NOTE: File count limit removed - batching handles any number of files
        // MaxFiles parameter is kept for UI hint only, but no actual limit enforced
        selectedFiles.AddRange(validFiles);

        if (oversizedFiles.Any())
        {
            statusMessage = $"Loaded {selectedFiles.Count} files. {oversizedFiles.Count} file(s) exceeded size limit and were skipped.";
            hasError = true;
        }
        else
        {
            statusMessage = isFolder 
                ? $"Loaded {selectedFiles.Count} source files from project folder."
                : $"Selected {selectedFiles.Count} individual files.";
            hasError = false;
        }

        await OnFilesChanged.InvokeAsync(new List<IBrowserFile>(selectedFiles));
        await OnStatusChanged.InvokeAsync(statusMessage);
        StateHasChanged();
    }

    private async Task RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        statusMessage = $"Removed {file.Name}. {selectedFiles.Count} files remaining.";
        hasError = false;

        await OnFilesChanged.InvokeAsync(new List<IBrowserFile>(selectedFiles));
        await OnStatusChanged.InvokeAsync(statusMessage);
        StateHasChanged();
    }

    private async Task ClearAllFiles()
    {
        selectedFiles.Clear();
        statusMessage = "All files cleared. Ready for new selection.";
        hasError = false;

        await OnFilesChanged.InvokeAsync(new List<IBrowserFile>(selectedFiles));
        await OnStatusChanged.InvokeAsync(statusMessage);
        StateHasChanged();
    }
}

<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }

    .upload-area:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }

    .upload-buttons-compact {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

    .compact-file-summary {
        max-width: 100%;
    }

    .file-count-badge {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .file-badge {
        display: flex;
        align-items: center;
        background: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .file-badge i {
        font-size: 1.2rem;
        margin-right: 0.2rem;
    }

    .btn-close {
        padding: 0.2rem 0.4rem;
        margin-left: 0.2rem;
    }
</style>