@using PoC1_LegacyAnalyzer_Web.Helpers
@using PoC1_LegacyAnalyzer_Web.Services

@* Business context display card *@
<div class="card mb-2 border-0">
    <div class="card-body p-2 bg-light">
        <button class="btn btn-link p-0 w-100 text-start text-decoration-none" @onclick="ToggleContext">
            <small class="text-muted d-flex justify-content-between align-items-center">
                <span><strong>Business Context:</strong> @GetObjectiveDisplayName()</span>
                <i class="bi bi-chevron-@(isExpanded ? "up" : "down") inline-icon"></i>
            </small>
        </button>
        
        <div class="collapse @(isExpanded ? "show" : "")" id="contextDetails">
            <div class="mt-2 pt-2 border-top">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Analysis Objective:</strong><br>
                            <small>@GetObjectiveDisplay()</small>
                        </div>
                        <div class="mb-2">
                            <strong>Specialist Agents Deployed:</strong><br>
                            <small>@string.Join(", ", SelectedAgents)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Estimated Hours Saved:</strong><br>
                            <small>@EstimateHoursSaved()</small>
                        </div>
                        <div class="mb-2">
                            <strong>Estimated Cost Avoidance:</strong><br>
                            <small>@EstimateCostAvoidance()</small>
                        </div>
                    </div>
                </div>
                
                @if (ProjectSummary != null)
                {
                    <div class="mt-3 pt-3 border-top">
                        <strong>Input Summary:</strong><br>
                        <small class="text-muted">
                            Analyzed @ProjectSummary.TotalFiles file(s) with @ProjectSummary.TotalClasses class(es), 
                            @ProjectSummary.TotalMethods method(s), and @ProjectSummary.TotalProperties propertie(s).
                            Risk Level: <span class="badge bg-warning">@ProjectSummary.RiskLevel</span>
                        </small>
                    </div>
                }
                else if (CodeInputLength > 0)
                {
                    <div class="mt-3 pt-3 border-top">
                        <strong>Input Summary:</strong><br>
                        <small class="text-muted">
                            Analyzing pasted code: @(CodeInputLength.ToString().Split('\n').Length) line(s), 
                            approximately @((CodeInputLength / 4).ToString("N0")) tokens
                        </small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string BusinessObjective { get; set; } = string.Empty;
    [Parameter] public string? CustomObjective { get; set; }
    [Parameter] public List<string> SelectedAgents { get; set; } = new();
    [Parameter] public PoC1_LegacyAnalyzer_Web.Services.ProjectSummary? ProjectSummary { get; set; }
    [Parameter] public int CodeInputLength { get; set; }
    
    private bool isExpanded = true; // Start expanded, user can collapse
    
    private void ToggleContext()
    {
        isExpanded = !isExpanded;
        StateHasChanged();
    }
    
    private string GetObjectiveDisplayName()
    {
        if (!string.IsNullOrWhiteSpace(CustomObjective))
            return CustomObjective.Length > 60 ? CustomObjective.Substring(0, 57) + "..." : CustomObjective;
            
        return BusinessObjective switch
        {
            "security-compliance" => "Security Compliance Assessment",
            "performance-optimization" => "Performance Optimization Analysis",
            "architecture-modernization" => "Architecture Modernization Planning",
            "comprehensive-audit" => "Comprehensive Code Audit",
            "custom" => "Custom Objective",
            _ => BusinessObjective
        };
    }

    private string GetObjectiveDisplay()
    {
        if (!string.IsNullOrWhiteSpace(CustomObjective))
            return CustomObjective;
            
        return FormattingHelpers.GetObjectiveDescription(BusinessObjective);
    }

    private string EstimateHoursSaved()
    {
        // Simple heuristic based on preprocessing or fallback to code length
        if (ProjectSummary != null)
        {
            var estimatedManual = ProjectSummary.TotalClasses * 2 + ProjectSummary.TotalMethods * 0.25m;
            var saved = Math.Max(1m, estimatedManual - 0.1m * estimatedManual);
            return $"{saved:F1} hours";
        }

        // Fallback estimation from code length
        var approxTokens = CodeInputLength / 4m;
        var savedFromTokens = Math.Max(0.5m, approxTokens / 200m); // ~200 tokens ~ 1 hour saved
        return $"{savedFromTokens:F1} hours";
    }

    private string EstimateCostAvoidance()
    {
        const decimal rate = 125m;
        var savedText = EstimateHoursSaved().Replace(" hours", "");
        if (decimal.TryParse(savedText, out var hours))
        {
            return (hours * rate).ToString("C0");
        }
        return (0m).ToString("C0");
    }
}