@using PoC1_LegacyAnalyzer_Web.Components.Shared
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Models
@using PoC1_LegacyAnalyzer_Web.Helpers
@using Microsoft.AspNetCore.Components

@* Individual agent analysis display card *@
<div class="card mb-2">
    <div class="card-body p-2 clickable" @onclick="ToggleExpanded">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="agent-icon">@((MarkupString)GetAgentIcon(Analysis.AgentName))</span>
                <strong>@Analysis.AgentName</strong>
                <span class="badge bg-light text-dark border">Confidence: @Analysis.ConfidenceScore%</span>
                @if (HighPriorityCount > 0)
                {
                    <span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> @HighPriorityCount High Priority</span>
                }
            </div>
            <i class="bi bi-chevron-@(isExpanded ? "up" : "down")"></i>
        </div>
        <small class="text-muted d-block mt-1">
            "@GetKeySummary()" <span class="text-secondary">[View Details]</span>
        </small>
    </div>
    
    <!-- Full Details (collapsed by default) -->
    <div class="collapse @(isExpanded ? "show" : "")" id="agent-@Analysis.AgentName-details">
        <div class="card-body border-top">
            <div class="mb-2">
                <small class="text-muted">@Analysis.Specialty</small>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <strong>Key Findings (@(Analysis.KeyFindings?.Count ?? 0)):</strong>
                    @if (Analysis.KeyFindings?.Any() == true)
                    {
                        <ul class="list-unstyled mt-2">
                            @foreach (var finding in Analysis.KeyFindings)
                            {
                                var findingId = $"finding-{Analysis.AgentName}-{finding.GetHashCode()}";
                                <li class="mb-2">
                                    <div class="d-flex align-items-start gap-2">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                                                <BadgeWithIcon 
                                                    Text="@finding.Severity"
                                                    Color="@GetSeverityColor(finding.Severity)" />
                                                @* Confidence Badge *@
                                                @if (finding.Explainability != null)
                                                {
                                                    <span class="badge @GetConfidenceBadgeClass(finding.Explainability.ConfidenceScore)" 
                                                          title="Confidence: @finding.Explainability.ConfidenceScore%">
                                                        <i class="bi @GetConfidenceIcon(finding.Explainability.ConfidenceLevel)"></i> 
                                                        @finding.Explainability.ConfidenceScore%
                                                    </span>
                                                }
                                                @if (finding.Validation != null)
                                                {
                                                    <span class="badge @GetValidationBadgeClass(finding.Validation.Status)" 
                                                          title="@GetValidationTooltip(finding.Validation)">
                                                        @GetValidationBadgeIcon(finding.Validation.Status) @GetValidationStatusLabel(finding.Validation.Status)
                                                    </span>
                                                }
                                            </div>
                                            <div>
                                                <strong>@finding.Category:</strong> @finding.Description
                                                @if (!string.IsNullOrEmpty(finding.Location))
                                                {
                                                    <br><small class="text-muted"><i class="bi bi-geo-alt"></i> @finding.Location</small>
                                                }
                                            </div>
                                            
                                            @* Explainability Section - Simplified *@
                                            @if (finding.Explainability != null)
                                            {
                                                var explainabilityId = $"explainability-{Analysis.AgentName}-{finding.GetHashCode()}";
                                                <div class="mt-2">
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            type="button" 
                                                            data-bs-toggle="collapse" 
                                                            data-bs-target="#@explainabilityId"
                                                            aria-expanded="false"
                                                            @onclick:stopPropagation="true">
                                                        <i class="bi bi-chevron-down"></i> 
                                                        <i class="bi bi-lightbulb"></i> View Details
                                                    </button>
                                                    <div class="collapse mt-2" id="@explainabilityId">
                                                        <div class="card card-body bg-light p-2 border">
                                                            <div class="row g-2 mb-2">
                                                                <div class="col-6">
                                                                    <small class="text-muted d-block">Confidence</small>
                                                                    <strong>@finding.Explainability.ConfidenceScore%</strong>
                                                                </div>
                                                                <div class="col-6">
                                                                    <small class="text-muted d-block">Level</small>
                                                                    <span class="badge bg-info">@finding.Explainability.ConfidenceLevel</span>
                                                                </div>
                                                            </div>
                                                            @* Simplified Confidence Breakdown *@
                                                            @if (finding.Explainability.ConfidenceBreakdown != null)
                                                            {
                                                                <div class="mb-2">
                                                                    <small class="text-muted d-block mb-1">Confidence Factors</small>
                                                                    <div class="d-flex gap-2 flex-wrap">
                                                                        <span class="badge bg-light text-dark">Evidence: @finding.Explainability.ConfidenceBreakdown.EvidenceClarity%</span>
                                                                        <span class="badge bg-light text-dark">Pattern: @finding.Explainability.ConfidenceBreakdown.PatternMatch%</span>
                                                                        <span class="badge bg-light text-dark">Context: @finding.Explainability.ConfidenceBreakdown.ContextUnderstanding%</span>
                                                                        <span class="badge bg-light text-dark">Consistency: @finding.Explainability.ConfidenceBreakdown.Consistency%</span>
                                                                    </div>
                                                                </div>
                                                            }
                                                            
                                                            @* Simplified Reasoning - Show only summary *@
                                                            @if (finding.Explainability.ReasoningChain != null && finding.Explainability.ReasoningChain.Any())
                                                            {
                                                                <div class="mb-2">
                                                                    <small class="text-muted d-block mb-1">Key Reasoning Steps (@finding.Explainability.ReasoningChain.Count)</small>
                                                                    <ul class="list-unstyled mb-0 small">
                                                                        @foreach (var step in finding.Explainability.ReasoningChain.Take(3))
                                                                        {
                                                                            <li class="mb-1">
                                                                                <i class="bi bi-arrow-right text-info"></i> @step.Description
                                                                            </li>
                                                                        }
                                                                        @if (finding.Explainability.ReasoningChain.Count > 3)
                                                                        {
                                                                            <li class="text-muted"><small>+@(finding.Explainability.ReasoningChain.Count - 3) more steps</small></li>
                                                                        }
                                                                    </ul>
                                                                </div>
                                                            }
                                                            
                                                            @* Simplified Supporting Evidence *@
                                                            @if (finding.Explainability.SupportingEvidence != null && finding.Explainability.SupportingEvidence.Any())
                                                            {
                                                                <div class="mb-2">
                                                                    <small class="text-muted d-block mb-1">Supporting Evidence (@finding.Explainability.SupportingEvidence.Count items)</small>
                                                                    <div class="d-flex flex-wrap gap-1">
                                                                        @foreach (var evidence in finding.Explainability.SupportingEvidence.Take(3))
                                                                        {
                                                                            <span class="badge bg-success">@evidence.Type</span>
                                                                        }
                                                                        @if (finding.Explainability.SupportingEvidence.Count > 3)
                                                                        {
                                                                            <span class="badge bg-light text-dark">+@(finding.Explainability.SupportingEvidence.Count - 3) more</span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                            
                                                            @* Simplified Contradictory Evidence *@
                                                            @if (finding.Explainability.ContradictoryEvidence != null && finding.Explainability.ContradictoryEvidence.Any())
                                                            {
                                                                <div>
                                                                    <h6 class="mb-2 text-warning">
                                                                        <i class="bi bi-exclamation-triangle"></i> Contradictory Evidence (@finding.Explainability.ContradictoryEvidence.Count)
                                                                    </h6>
                                                                    <ul class="list-unstyled mb-0">
                                                                        @foreach (var evidence in finding.Explainability.ContradictoryEvidence)
                                                                        {
                                                                            <li class="mb-1">
                                                                                <small>
                                                                                    <span class="badge bg-warning text-dark">@evidence.Type</span>
                                                                                    @evidence.Description
                                                                                    @if (!string.IsNullOrEmpty(evidence.Location))
                                                                                    {
                                                                                        <span class="text-muted">(@evidence.Location)</span>
                                                                                    }
                                                                                    <span class="badge bg-light text-dark">Strength: @evidence.Strength%</span>
                                                                                </small>
                                                                            </li>
                                                                        }
                                                                    </ul>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            @if (finding.Validation != null && (finding.Validation.Errors.Any() || finding.Validation.Warnings.Any()))
                                            {
                                                <button class="btn btn-sm btn-link p-0 mt-1 text-decoration-none" 
                                                        type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#@findingId"
                                                        aria-expanded="false"
                                                        @onclick:stopPropagation="true">
                                                    <small class="text-muted">
                                                        <i class="bi bi-chevron-right"></i> Validation Details
                                                        @if (finding.Validation.Errors.Any())
                                                        {
                                                            <span class="badge bg-danger ms-1">@finding.Validation.Errors.Count</span>
                                                        }
                                                        @if (finding.Validation.Warnings.Any())
                                                        {
                                                            <span class="badge bg-warning ms-1">@finding.Validation.Warnings.Count</span>
                                                        }
                                                    </small>
                                                </button>
                                                <div class="collapse mt-2" id="@findingId">
                                                    <div class="card card-body bg-light p-2">
                                                        @if (finding.Validation.Errors.Any())
                                                        {
                                                            <div class="mb-2">
                                                                <strong class="text-danger"><i class="bi bi-x-circle"></i> Errors:</strong>
                                                                <ul class="mb-0 small">
                                                                    @foreach (var error in finding.Validation.Errors)
                                                                    {
                                                                        <li class="text-danger">@error</li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        }
                                                        @if (finding.Validation.Warnings.Any())
                                                        {
                                                            <div>
                                                                <strong class="text-warning"><i class="bi bi-exclamation-triangle"></i> Warnings:</strong>
                                                                <ul class="mb-0 small">
                                                                    @foreach (var warning in finding.Validation.Warnings)
                                                                    {
                                                                        <li class="text-warning">@warning</li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mt-2"><small>No findings reported</small></p>
                    }
                </div>
                <div class="col-md-6">
                    <strong>Recommendations (@(Analysis.Recommendations?.Count ?? 0)):</strong>
                    @if (Analysis.Recommendations?.Any() == true)
                    {
                        <ul class="list-unstyled mt-2">
                            @foreach (var rec in Analysis.Recommendations)
                            {
                                <li class="mb-2">
                                    <strong>@rec.Title</strong><br>
                                    <small class="text-muted">Priority: @rec.Priority | Effort: @rec.EstimatedHours hours</small>
                                    @if (!string.IsNullOrWhiteSpace(rec.Description))
                                    {
                                        <br><small class="text-muted">@rec.Description</small>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mt-2"><small>No recommendations provided</small></p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Analysis.BusinessImpact))
            {
                <div class="mt-3 p-3 bg-light rounded">
                    <strong>Business Impact:</strong><br>
                    <small>@Analysis.BusinessImpact</small>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public SpecialistAnalysisResult Analysis { get; set; } = null!;
    
    private bool isExpanded = false;
    
    private int HighPriorityCount => Analysis.KeyFindings?.Count(f => 
        f.Severity?.ToUpper() == "CRITICAL" || f.Severity?.ToUpper() == "HIGH") ?? 0;

    private void ToggleExpanded()
    {
        isExpanded = !isExpanded;
        StateHasChanged();
    }

    private string GetKeySummary()
    {
        // Try to get a summary from the first finding or business impact
        var summary = "";
        
        if (Analysis.KeyFindings?.Any() == true)
        {
            summary = Analysis.KeyFindings.First().Description;
        }
        else if (!string.IsNullOrEmpty(Analysis.BusinessImpact))
        {
            summary = Analysis.BusinessImpact;
        }
        else if (Analysis.Recommendations?.Any() == true)
        {
            summary = Analysis.Recommendations.First().Description ?? Analysis.Recommendations.First().Title;
        }
        else
        {
            summary = $"{Analysis.Specialty} analysis completed with {Analysis.ConfidenceScore}% confidence";
        }
        
        return summary.Length > 100 ? summary.Substring(0, 97) + "..." : summary;
    }

    private string GetAgentIcon(string agentName)
    {
        return agentName.ToLower() switch
        {
            var name when name.Contains("security") => "<i class=\"bi bi-shield-check\"></i>",
            var name when name.Contains("performance") => "<i class=\"bi bi-speedometer2\"></i>",
            var name when name.Contains("architectural") || name.Contains("architecture") => "<i class=\"bi bi-diagram-3\"></i>",
            _ => "<i class=\"bi bi-robot\"></i>"
        };
    }

    private string GetConfidenceColor(int confidence)
    {
        return confidence switch
        {
            >= 90 => "success",
            >= 75 => "primary",
            >= 60 => "warning",
            _ => "danger"
        };
    }

    private string GetSeverityColor(string severity)
    {
        return severity?.ToUpper() switch
        {
            "CRITICAL" => "danger",
            "HIGH" => "warning",
            "MEDIUM" => "info",
            "LOW" => "secondary",
            _ => "light"
        };
    }

    private string GetValidationBadgeClass(FindingValidationStatus status)
    {
        return status switch
        {
            FindingValidationStatus.Validated => "bg-success",
            FindingValidationStatus.LowConfidence => "bg-warning",
            FindingValidationStatus.Failed => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetValidationBadgeIcon(FindingValidationStatus status)
    {
        return status switch
        {
            FindingValidationStatus.Validated => "✅",
            FindingValidationStatus.LowConfidence => "⚠️",
            FindingValidationStatus.Failed => "❌",
            _ => "❓"
        };
    }

    private string GetValidationStatusLabel(FindingValidationStatus status)
    {
        return status switch
        {
            FindingValidationStatus.Validated => "Validated",
            // Use a different term to avoid clashing with the numeric confidence score
            FindingValidationStatus.LowConfidence => "Validation Warning",
            FindingValidationStatus.Failed => "Failed Validation",
            _ => status.ToString()
        };
    }

    private string GetValidationTooltip(FindingValidationResult validation)
    {
        var parts = new List<string>();
        if (validation.Errors.Any())
            parts.Add($"{validation.Errors.Count} error(s)");
        if (validation.Warnings.Any())
            parts.Add($"{validation.Warnings.Count} warning(s)");
        return parts.Any() ? string.Join(", ", parts) : "Validation passed";
    }

    private string GetConfidenceBadgeClass(int confidenceScore)
    {
        return confidenceScore >= 90 ? "bg-success" :
               confidenceScore >= 60 ? "bg-warning text-dark" :
               "bg-danger";
    }

    private string GetConfidenceIcon(ConfidenceLevel level)
    {
        return level switch
        {
            ConfidenceLevel.High => "bi-check-circle-fill",
            ConfidenceLevel.Medium => "bi-exclamation-circle-fill",
            ConfidenceLevel.Low => "bi-x-circle-fill",
            _ => "bi-question-circle-fill"
        };
    }

    private string GetConfidenceProgressColor(int value)
    {
        return value >= 80 ? "bg-success" :
               value >= 60 ? "bg-warning" :
               value >= 40 ? "bg-info" :
               "bg-danger";
    }
}

<style>
    .clickable {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .clickable:hover {
        background-color: #f8f9fa;
    }
    
    .agent-icon {
        font-size: 1.2rem;
    }
</style>