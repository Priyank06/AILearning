@using PoC1_LegacyAnalyzer_Web.Components.Shared
@using PoC1_LegacyAnalyzer_Web.Models.MultiAgent
@using PoC1_LegacyAnalyzer_Web.Helpers

@* Individual agent analysis display card *@
<div class="card mb-2">
    <div class="card-body p-2 clickable" @onclick="ToggleExpanded">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="agent-icon">@GetAgentIcon(Analysis.AgentName)</span>
                <strong>@Analysis.AgentName</strong>
                <span class="badge bg-light text-dark border">Confidence: @Analysis.ConfidenceScore%</span>
                @if (HighPriorityCount > 0)
                {
                    <span class="badge bg-danger">⚠️ @HighPriorityCount High Priority</span>
                }
            </div>
            <i class="bi bi-chevron-@(isExpanded ? "up" : "down")"></i>
        </div>
        <small class="text-muted d-block mt-1">
            "@GetKeySummary()" <span class="text-secondary">[View Details]</span>
        </small>
    </div>
    
    <!-- Full Details (collapsed by default) -->
    <div class="collapse @(isExpanded ? "show" : "")" id="agent-@Analysis.AgentName-details">
        <div class="card-body border-top">
            <div class="mb-2">
                <small class="text-muted">@Analysis.Specialty</small>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <strong>Key Findings (@(Analysis.KeyFindings?.Count ?? 0)):</strong>
                    @if (Analysis.KeyFindings?.Any() == true)
                    {
                        <ul class="list-unstyled mt-2">
                            @foreach (var finding in Analysis.KeyFindings)
                            {
                                <li class="mb-1">
                                    <BadgeWithIcon 
                                        Text="@finding.Severity"
                                        Color="@GetSeverityColor(finding.Severity)" />
                                    <strong>@finding.Category:</strong> @finding.Description
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mt-2"><small>No findings reported</small></p>
                    }
                </div>
                <div class="col-md-6">
                    <strong>Recommendations (@(Analysis.Recommendations?.Count ?? 0)):</strong>
                    @if (Analysis.Recommendations?.Any() == true)
                    {
                        <ul class="list-unstyled mt-2">
                            @foreach (var rec in Analysis.Recommendations)
                            {
                                <li class="mb-2">
                                    <strong>@rec.Title</strong><br>
                                    <small class="text-muted">Priority: @rec.Priority | Effort: @rec.EstimatedHours hours</small>
                                    @if (!string.IsNullOrWhiteSpace(rec.Description))
                                    {
                                        <br><small class="text-muted">@rec.Description</small>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted mt-2"><small>No recommendations provided</small></p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Analysis.BusinessImpact))
            {
                <div class="mt-3 p-3 bg-light rounded">
                    <strong>Business Impact:</strong><br>
                    <small>@Analysis.BusinessImpact</small>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public SpecialistAnalysisResult Analysis { get; set; } = null!;
    
    private bool isExpanded = false;
    
    private int HighPriorityCount => Analysis.KeyFindings?.Count(f => 
        f.Severity?.ToUpper() == "CRITICAL" || f.Severity?.ToUpper() == "HIGH") ?? 0;

    private void ToggleExpanded()
    {
        isExpanded = !isExpanded;
        StateHasChanged();
    }

    private string GetKeySummary()
    {
        // Try to get a summary from the first finding or business impact
        var summary = "";
        
        if (Analysis.KeyFindings?.Any() == true)
        {
            summary = Analysis.KeyFindings.First().Description;
        }
        else if (!string.IsNullOrEmpty(Analysis.BusinessImpact))
        {
            summary = Analysis.BusinessImpact;
        }
        else if (Analysis.Recommendations?.Any() == true)
        {
            summary = Analysis.Recommendations.First().Description ?? Analysis.Recommendations.First().Title;
        }
        else
        {
            summary = $"{Analysis.Specialty} analysis completed with {Analysis.ConfidenceScore}% confidence";
        }
        
        return summary.Length > 100 ? summary.Substring(0, 97) + "..." : summary;
    }

    private string GetAgentIcon(string agentName)
    {
        return agentName.ToLower() switch
        {
            var name when name.Contains("security") => "???",
            var name when name.Contains("performance") => "?",
            var name when name.Contains("architectural") || name.Contains("architecture") => "???",
            _ => "??"
        };
    }

    private string GetConfidenceColor(int confidence)
    {
        return confidence switch
        {
            >= 90 => "success",
            >= 75 => "primary",
            >= 60 => "warning",
            _ => "danger"
        };
    }

    private string GetSeverityColor(string severity)
    {
        return severity?.ToUpper() switch
        {
            "CRITICAL" => "danger",
            "HIGH" => "warning",
            "MEDIUM" => "info",
            "LOW" => "secondary",
            _ => "light"
        };
    }
}

<style>
    .clickable {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .clickable:hover {
        background-color: #f8f9fa;
    }
    
    .agent-icon {
        font-size: 1.2rem;
    }
</style>