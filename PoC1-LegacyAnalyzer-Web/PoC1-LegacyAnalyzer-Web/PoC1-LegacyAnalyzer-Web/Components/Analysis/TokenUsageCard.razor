@using PoC1_LegacyAnalyzer_Web.Components.Shared
@using PoC1_LegacyAnalyzer_Web.Models.AgentCommunication

@* Token usage display card *@
<div class="card mb-2">
    <div class="card-body p-2">
        <small class="text-muted d-flex align-items-center gap-3 flex-wrap">
            @if (TokenUsage != null)
            {
                <span>ðŸ“Š @TokenUsage.TotalTokens.ToString("N0") tokens</span>
                <span>âš¡ @TokenUsage.CompletionTokens completions</span>
                <span>ðŸ’° $@GetCostValue().ToString("F2")</span>
                <span>ðŸ¤– @TokenUsage.Model</span>
            }
            else
            {
                var estPrompt = Math.Max(1, EstimatedInputTokens / 4);
                var estCompletion = Math.Max(1, EstimatedCompletionTokens);
                var estTotal = estPrompt + estCompletion;
                <span>ðŸ“Š ~@estTotal.ToString("N0") tokens (est.)</span>
                <span>âš¡ ~@estCompletion.ToString("N0") completions</span>
                <span>ðŸ’° ~$@GetEstimatedCost(estPrompt, estCompletion).ToString("F2")</span>
                <span>ðŸ¤– semantic-kernel</span>
            }
            <button class="btn btn-link btn-sm p-0 ms-auto" @onclick="ToggleDetails">
                <small>Details <i class="bi bi-chevron-@(showDetails ? "up" : "down")"></i></small>
            </button>
        </small>
        
        <div class="collapse @(showDetails ? "show" : "")" id="tokenDetails">
            @if (TokenUsage != null)
            {
                <div class="mt-2 pt-2 border-top">
                    <small class="text-muted">
                        <div class="row">
                            <div class="col-6 col-md-3">
                                <strong>Prompt:</strong> @TokenUsage.PromptTokens.ToString("N0")
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Completion:</strong> @TokenUsage.CompletionTokens.ToString("N0")
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Provider:</strong> @TokenUsage.Provider
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Model:</strong> @TokenUsage.Model
                            </div>
                        </div>
                    </small>
                </div>
            }
            else
            {
                var estPrompt = Math.Max(1, EstimatedInputTokens / 4);
                var estCompletion = Math.Max(1, EstimatedCompletionTokens);
                <div class="mt-2 pt-2 border-top">
                    <small class="text-muted">
                        <div class="row">
                            <div class="col-6 col-md-3">
                                <strong>Prompt (est.):</strong> ~@estPrompt.ToString("N0")
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Completion (est.):</strong> ~@estCompletion.ToString("N0")
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Provider:</strong> semantic-kernel
                            </div>
                            <div class="col-6 col-md-3">
                                <strong>Model:</strong> unknown
                            </div>
                        </div>
                    </small>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public TokenUsage? TokenUsage { get; set; }
    [Parameter] public int EstimatedInputTokens { get; set; }
    [Parameter] public int EstimatedCompletionTokens { get; set; } = 1000;
    [Parameter] public bool ShowCostEstimate { get; set; } = true;
    
    private bool showDetails = false;

    private void ToggleDetails()
    {
        showDetails = !showDetails;
        StateHasChanged();
    }

    private string GetEstimatedTotal(int prompt, int completion)
    {
        return (prompt + completion).ToString();
    }

    private decimal GetCostValue()
    {
        if (TokenUsage == null) return 0m;
        
        // Rough estimate based on GPT-4 pricing
        var promptCost = TokenUsage.PromptTokens * 0.00003m;
        var completionCost = TokenUsage.CompletionTokens * 0.00006m;
        return promptCost + completionCost;
    }

    private string GetCostEstimate()
    {
        if (TokenUsage == null) return "$0.00";
        
        // Rough estimate based on GPT-4 pricing
        var promptCost = TokenUsage.PromptTokens * 0.00003m;
        var completionCost = TokenUsage.CompletionTokens * 0.00006m;
        return (promptCost + completionCost).ToString("C3");
    }

    private decimal GetEstimatedCost(int prompt, int completion)
    {
        // Rough estimate based on GPT-4 pricing
        var promptCost = prompt * 0.00003m;
        var completionCost = completion * 0.00006m;
        return promptCost + completionCost;
    }
}